<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Details Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <!-- Load external libraries FIRST before main script -->
  <!-- Google libphonenumber library for phone validation -->
  <script src="https://cdn.jsdelivr.net/npm/google-libphonenumber@3.2.33/dist/libphonenumber.min.js"></script>
  
  <!-- jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /*
    =====================================================================
    CUSTOM FONTS - Base64 Embedded with Google Fonts Fallback
    =====================================================================
    Transport Medium → fallback to Quicksand Bold (700)
    Rotis fonts → fallback to Quicksand Regular (400/600)
    =====================================================================
    */
    
    /* Transport Medium - for headings and buttons */
    @font-face {
            font-family: 'Transport';
            font-weight: 500;
            font-style: normal;
            font-display: swap;
            unicode-range: U+0000-003F, U+0041-FFFF; /* Exclude U+0040 (@ symbol) to fallback to Quicksand */
            src: url(data:font/truetype;charset=utf-8;base64,AAEAAAALAIAAAwAwT1MvMj1ZTw0AAAE4AAAATmNtYXA5I1gjAAAFZAAAA/5nYXNw//8AAwAAb7wAAAAIZ2x5ZiuSUQQAAAtUAABg6GhlYWTjcoC1AAAAvAAAADZoaGVhGsYRQwAAAPQAAAAkaG10eMggKDAAAAGIAAAD3GxvY2Ei+Tu+AAAJZAAAAfBtYXhwAV8CPgAAARgAAAAgbmFtZaVg1MkAAGw8AAABPnBvc3SXWJOwAABtfAAAAkAAAQAAAAEAAKtDr+tfDzz1AAsIAAAAAACz73oAAAAAAL5PuykADP68EggH0gAAAAkAAgAAAAAAAAEAAAImP5OACMSGAAA/+USCAABAAAAAAAAAAAAAAAAAAAA9wABAAAA9wH8AAMAAAAAAAIACABAAAoAAABSAAAAAAAAAAAD9wGQAAUACAWaBTMAAAEbBZoFMwAAA9EAZgISAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEhMICAAQAAg8AIF0/5RAJYImAGyAAAEAAAAAAAAAAAAAAACfAAAA5gAPgPkAD8A+AAAAAAAAAVYAGQBqABGBHQAlgR0ARQAAAAAAAAAAALEAEgCyABLAkAAcANMABQFpACHA1gAbAUYAIIFZAB8BZQANAUsAHwFWACEBGgAHAWAAKQFbACgAkAAbwAAAAARDAAUAAAAABEMAAsF3AGTAAAAAAXEADwGOAEIBkAAiAaIARMFlAEHBQgBCAaQAI4GzAEIAxQBCAPwABwF3AEMBIgBCAfMAQgHIAEMBpwAmwWAAQgGtACbBfwBDAXMAIQEoAAsBogA+AWEAFwHsAB8BWwANAU4ACQFDABsAAAAAAAAAAASGAAUAAAAAAAAAAAEsABTBPQAnARcAFEFCABQBJwATwMsADwE0ABSBMAAnAJEAHYCdAAcBJQAhAKgAJAG9ACEBLwAnAUEAFYFBACQBQAAhQNkAKAEGAAgA2wAPATgAJMEJAAcBjgAMARoACAEKAAQBBwATAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjwAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABWYAAAFNAA0BkgANAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABXgANAcEANAcEADQFrABMAAAAAgABAAAAAAAUAAMAAQAAA24ABAGKAAAADAAIAAIABAAkAFsAfgCiAP///wAAAAAAJgBdAH8ApP///wAA/4v/hAAAAAAABAAwAAAAAAFAAlgAAAAEAAAAAAAAAAAAAAAAAAAABAAMAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAwAEAAUABgAHAAAAAAAAsACYALEAmwCAAK4AwgCyAMYArACgAAAAAAAAAAAApgCnAKQApQCEAKIAowDDAIkAxwCtAKEAAAAAAKoAnACWAIIAqwCPAMgAgwCLAIgAkQCZAJcAzwCHAMQAgQCOANIA0wCKAJAAhQCvAMUA0QCSAJoA1QDUANYAlQCdALUAswCeAGAAYQCMAGIAtwBjALQAtgC7ALgAuQC6AMkAZAC+ALwAvQCfAGUA0ACNAMEAvwDAAGYAywDNAIYAaABnAGkAawBqAGwAkwBtAG8AbgBwAHEAcwByAHQAdQDKAHYAeAB3AHkAewB6AKgAlAB9AHwAfgB/AMwAzgCpAAQCYAAAAFgAQAAFABgAJABbAH4A/wExAUIBUwFhAXgBfgGSAscCyQLdA5QDqQO8A8AgECAUIBogHiAiICYgMCA6IEQhIiEmIVQiAiIGIg8iEiIaIh4iKyJIImAiZSLyJcrwAv//AAAAIAAmAF0AoAExAUEBUgFgAXgBfQGSAsYCyQLYA5QDqQO8A8AgECATIBggHCAgICYgMCA5IEQhIiEmIVMiAiIGIg8iESIZIh4iKyJIImAiZCLyJcrwAP///+P/4v/hAAD/vP+W/07/Zv8y/1z/BgAA/fsAAP1T/Tv81P0i3//gjwAAAAAAAOB14ILgc+Cl32ffvt+h3t3e4d7SAAAAAN6+3rjent57) format('truetype');
        }
        
        /* Rotis Sans Serif Regular - for body text */
        @font-face {
            font-family: 'RotisRegular';
            font-weight: 300;
            font-style: normal;
            font-display: swap;
            src: url(data:font/truetype;charset=utf-8;base64,T1RUTwANAIAAAwBQQkFTRYsZlLEAAFVYAAAAOkNGRiBMjcLHAAANIAAAOOZEU0lHqqGyEQAAVZQAABioR1BPU8IG0soAAExYAAAJAEdTVULsbPoyAABKHAAAAjxPUy8yWV9xjwAAAUAAAABgY21hcIINkboAAAhgAAAEnmhlYWToYvBzAAAA3AAAADZoaGVhB5wD9gAAARQAAAAkaG10eMZWMWwAAEYIAAAEFG1heHABBVAAAAABOAAAAAZuYW1lCOzPTwAAAaAAAAa+cG9zdP+4ADIAAA0AAAAAIAABAAAAAgUeOUtSpl8PPPUAAwPoAAAAAMKV0+oAAAAAwpXT6v/e/xIEQQOPAAAAAwACAAAAAAAAAAEAAAKy/soAyARX/97/zwRBAAEAAAAAAAAAAAAAAAAAAAEFAABQAAEFAAAAAwG9ASwABQAEAooCWAAAAEsCigJYAAABXgAyAR0AAAILBgYDAgQCAgQAAAADAAAAAAAAAAAAAAAAQURCRQAAACD7AgKy/soAyAOPAO4gAAABAAAAAAHcArIAAAAgAAQAAAAZATIAAQAAAAAAAABDAAAAAQAAAAAAAQAUAEMAAQAAAAAAAgAIAFcAAQAAAAAAAwAiAF8AAQAAAAAABAAdAIEAAQAAAAAABQA8AJ4AAQAAAAAABgAXANoAAQAAAAAABwCWAPEAAQAAAAAACQAKAYcAAQAAAAAACwAZAZEAAQAAAAAADgAkAaoAAQAAAAAAEgAaAc4AAwABBAkAAACGAegAAwABBAkAAQA0Am4AAwABBAkAAgAOAqIAAwABBAkAAwBEArAAAwABBAkABAAuAvQAAwABBAkABQB4AyIAAwABBAkABgAuAvQAAwABBAkABwEsA5oAAwABBAkACQAUBMYAAwABBAkACwAyBNoAAwABBAkADgBIBQwAAwABBAkAEAAoBVQAAwABBAkAEQAQBXypIDE5OTAsIDIwMDIsIDIwMDUgQWRvYmUgU3lzdGVtcyBJbmNvcnBvcmF0ZWQuIEFsbCByaWdodHMgcmVzZXJ2ZWQuUm90aXMgU2FucyBTZXJpZiBTdGQ0NSBMaWdodDIuMDIwO0FEQkU7Um90aXNTYW5zU2VyaWZTdGQtTGlnaHRSb3RpcyBTYW5zIFNlcmlmIFN0ZCA0NSBMaWdodFZlcnNpb24gMi4wMjA7UFMgMDAyLjAwMDtob3Rjb252IDEuMC41MDttYWtlb3RmLmxpYjIuMC4xNjk3MFJvdGlzU2Fuc1NlcmlmU3RkLUxpZ2h0Um90aXMgaXMgYSB0cmFkZW1hcmsgb2YgTW9ub3R5cGUgSW1hZ2luZyBJbmMuIHJlZ2lzdGVyZWQgaW4gdGhlIFUuUy4gUGF0ZW50IGFuZCBUcmFkZW1hcmsgT2ZmaWNlIGFuZCBtYXkgYmUgcmVnaXN0ZXJlZCBpbiBjZXJ0YWluIG90aGVyIGp1cmlzZGljdGlvbnMuT3RsIEFpY2hlcmh0dHA6Ly93d3cuYWRvYmUuY29tL3R5cGVodHRwOi8vd3d3LmFkb2JlLmNvbS90eXBlL2xlZ2FsLmh0bWxSb3RpcyBTYW5zIFNlcmlmIFN0ZCBMaWdodACpACAAMQA5ADkAMAAsACAAMgAwADAAMgAsACAAMgAwADAANQAgAEEAZABvAGIAZQAgAFMAeQBzAHQAZQBtAHMAIABJAG4AYwBvAHIAcABvAHIAYQB0AGUAZAAuACAAQQBsAGwAIAByAGkAZwBoAHQAcwAgAHIAZQBzAGUAcgB2AGUAZAAuAFIAbwB0AGkAcwAgAFMAYQBuAHMAIABTAGUAcgBpAGYAIABTAHQAZAAgAEwAaQBnAGgAdABSAGUAZwB1AGwAYQByADIALgAwADIAMAA7AEEARABCAEUAOwBSAG8AdABpAHMAUwBhAG4AcwBTAGUAcgBpAGYAUwB0AGQALQBMAGkAZwBoAHQAUgBvAHQAaQBzAFMAYQBuAHMAUwBlAHIAaQBmAFMAdABkAC0ATABpAGcAaAB0AFYAZQByAHMAaQBvAG4AIAAyAC4AMAAyADAAOwBQAFMAIAAwADAAMgAuADAAMAAwADsAaABvAHQAYwBvAG4AdgAgADEALgAwAC4ANQAwADsAbQBhAGsAZQBvAHQAZgAuAGwAaQBiADIALgAwAC4AMQA2ADkANwAwAFIAbwB0AGkAcwAgAGkAcwAgAGEAIAB0AHIAYQBkAGUAbQBhAHIAawAgAG8AZgAgAE0AbwBuAG8AdAB5AHAAZQAgAEkAbQBhAGcAaQBuAGcAIABJAG4AYwAuACAAcgBlAGcAaQBzAHQAZQByAGUAZAAgAGkAbgAgAHQAaABlACAAVQAuAFMALgAgAFAAYQB0AGUAbgB0ACAAYQBuAGQAIABUAHIAYQBkAGUAbQBhAHIAawAgAE8AZgBmAGkAYwBlACAAYQBuAGQAIABtAGEAeQAgAGIAZQAgAHIAZQBnAGkAcwB0AGUAcgBlAGQAIABpAG4AIABjAGUAcgB0AGEAaQBuACAAbwB0AGgAZQByACAAagB1AHIAaQBzAGQAaQBjAHQAaQBvAG4AcwAuAE8AdABsACAAQQBpAGMAaABlAHIAaAB0AHQAcAA6AC8ALwB3AHcAdwAuAGEAZABvAGIAZQAuAGMAbwBtAC8AdAB5AHAAZQBoAHQAdABwADoALwAvAHcAdwB3AC4AYQBkAG8AYgBlAC4AYwBvAG0ALwB0AHkAcABlAC8AbABlAGcAYQBsAC4AaAB0AG0AbABSAG8AdABpAHMAIABTAGEAbgBzACAAUwBlAHIAaQBmACAAUwB0AGQANAA1ACAATABpAGcAaAB0AAAAAAADAAAAAwAAAhQAAQAAAAAAHAADAAEAAAIUAAYB+AAAAAkA9wABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQACAAMABAAFAAYABwBoAAkACgALAAwADQAOAA8AEAARABIAEwAUABUAFgAXABgAGQAaABsAHAAdAB4AHwAgACEAIgAjACQAJQAmACcAKAApACoAKwAsAC0ALgAvADAAMQAyADMANAA1ADYANwA4ADkAOgA7ADwAPQA+AD8AQAB6AEIAQwBEAEUARgBHAEgASQBKAEsATABNAE4ATwBQAFEAUgBTAFQAVQBWAFcAWABZAFoAWwBcAF0AXgBfAAAAqACqAKwArQC1ALgAvgDDAMYAxADFAMgAxwDJAMoAzQDLAMwAzgDRAM8A0ADSANMA1gDUANUA1wDZANwA2gDbAG4AngBhAGIAZgByAHEAkwChAKUAlgB7AIEA9ACIAIsA8QCZAPUA9gBkAJUA7ADuAO0A6ADyAIkAjQD8AI4AkQB5AGAAlADwAGUA8wDlAGoAdgB3APgAqQCrALoAjACSAG0AhwBpAHUAQQAIAJwA9wDeAMEAYwDpAGsAbAD/AQAAbwBwAHMAdAB4AKcArgCmAK8AsACxALIAswC0ALYAtwAAALkAvAC9AL8AjwB8AH0AfgB/AIAAggCDAIQAhQCGAAQCigAAAGIAQAAFACIAJgAnAF8AYAB+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AeEAhAHhADwB4QAsAeEAMAHhAEEB4QBAAeEAQwHhADQB4QAmAPEAdADxAHECPgA8Aj4APAI+ADwBhQBEA+gAXwIZAAkCBwBYAgcAMwI+AFgBvABYAZcAWAJRADMCUQBYAPEAWgFNAAAB9ABYAYUAWAL3AFgCYwBYAj4AMwHhAFgCPgAuAhkAWAHPACYBhQAAAlEAUwH0/+0DHAApAfQAAAHhAAAB4QAbAQMAWwEWABgBAwAOAU0ANAH0AAAAuQAzAbwAKQHPAEQBlwAuAeEALgGqACwBOwAmAeEALgH0AFMA3gBJAN7/3gGXAFMA3gBWAuUAUwH0AFMB4QAuAeEAUwHhAC4BOwBUAXIAJQE7ACcB9ABTAaoACwKbACwBlwANAaoACgGFABgB4QBmAU0AjQHhAFoCPgA6AQMANQGqAC0BlwAfARYAEAHhAAABTQArAaoAIQH0AA0AuQA5ATsAMwE7ACMAzAAmAMwAKgHhADkBzwAoAeEAMADMADsB4QA3AeEAPAC5ADMBOwAzATsAMwE7ACgCrQBKBFcAGAGFABQBGAA0ARgAcQEYABkBGAAdARgAGQEYABwBGABlARgAFQEYAD0BGABFARgAOQEYAHcBGAAZApsAOQL3AAABAwApAYUAAAI+ADMDVAAzARYAHwKtACsA3gBWAN7//wHhAC4C9wAuAfQAVAI+ADwB9ABRAmMALgI+AAADCgBBAj4APAIsAFQDCgA4Aj4APADeAFUBTQA7Ac8AQwMKAB4B9AAPAj4APAHhAC4CPgA5AfQADwIZAAkCGQAJAhkACQIZAAkCGQAJAhkACQIHADMBvABYAbwAWAG8AFgBvABYAPEAWgDx//sA8f/3APEAFgJjAFgCPgAzAj4AMwI+ADMCPgAzAj4AMwHPACYCUQBTAlEAUwJRAFMCUQBTAeEAAAHhAAAB4QAbAbwAKQG8ACkBvAApAbwAKQG8ACkBvAApAZcALgGqACwBqgAsAaoALAGqACwA3gBUAN7//ADe//gA3gAXAfQAUwHhAC4B4QAuAeEALgHhAC4B4QAuAXIAJQH0AFMB9ABTAfQAUwH0AFMBqgAKAaoACgGFABgCBwAmAgcAJgFNAFgBTQApAU0AHgIwAB0CcgAuAfQAUQHoAAoCBwAZAZ8AGwMXAB8B1QAnAloAFwHgABQAzAA7Ae4AHgKrAC0BMQAL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) format('truetype')
        }
    
    /*
    =====================================================================
    CLIENT DETAILS FORM - STYLE SECTION
    =====================================================================
    Lightweight iframe for collecting client details and addresses only.
    Uses getaddress.io autocomplete via Wix backend proxy.
    
    COMMUNICATION ARCHITECTURE:
    - Uses window.postMessage() API for parent-child communication
    - Parent sends: initiation-data (client info and existing data)
    - Child sends: form-data (complete client details with Thirdfort addresses)
    
    ADDRESS AUTOCOMPLETE FLOW:
    1. User types in address field (7+ chars)
    2. Child sends 'address-search' to parent via postMessage
    3. Parent calls Wix backend → backend calls getaddress.io
    4. Parent sends 'address-results' back with suggestions
    5. User selects address → Child sends 'address-lookup' to parent
    6. Parent sends 'address-data' with full address object
    7. Child converts to Thirdfort format and stores
    =====================================================================
    */
    
    /* CSS Variables */
    :root { --gap: 20px; --primary:#003C71; --error:#e02424; }
    
    /* Global body styling */
    body { 
      font-family: 'RotisRegular', 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: transparent; 
      color: #111; 
      padding: 0; 
      margin: 0; 
      line-height: 1.5; 
    }
    
    /* Main container - 970px iframe with 10px padding each side for 950px card */
    .container {
      width: 100%;
      max-width: 970px;
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
      background: transparent;
    }
    
    /* Section styling */
    .section {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 10px;
      margin: 0;
      box-sizing: border-box;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    /* Typography */
    h3 { 
      font-family: 'Transport', 'Quicksand', sans-serif; 
      font-size: 1rem; 
      font-weight: 500; 
      margin: 20px 0 10px 0; 
      color: #444; 
    }
    
    /* Form labels */
    label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 400; 
      font-size: 0.9rem; 
      color: #333;
    }
    label.required::after { 
      content: " *"; 
      color: var(--error); 
      margin-left: 4px; 
    }
    
    /* Form inputs */
    input, select { 
      font-family: 'RotisRegular', 'Quicksand', sans-serif; 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 0.9rem; 
      font-weight: 300; 
      transition: border 0.2s, box-shadow 0.2s; 
      box-sizing: border-box; 
    }
    input:focus, select:focus { 
      outline: none; 
      border-color: var(--primary); 
      box-shadow: 0 0 0 2px rgba(0,60,113,0.2); 
    }
    input:disabled, select:disabled { 
      background-color: #f5f5f5; 
      color: #666; 
      cursor: not-allowed; 
      opacity: 0.7; 
    }
    
    /* Grid layouts */
    .row { margin-bottom: 15px; }
    
    .row-grid-20-80 { 
      display: grid; 
      grid-template-columns: 20% 1fr; 
      gap: var(--gap); 
    }
    
    .row-grid-50-50 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: var(--gap); 
    }
    
    .row-grid-25-25-50 { 
      display: grid; 
      grid-template-columns: 25% 25% 1fr; 
      gap: var(--gap); 
    }
    
    /* Entity mode split layout: Left (forms) + Right (people cards) */
    .entity-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    
    .entity-left {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .entity-right {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .people-scrollable {
      max-height: 250px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* People cards */
    .people-card {
      background: #f9f9f9;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .people-card:hover {
      background: #f0f0f0;
      border-color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,60,113,0.1);
    }
    
    .people-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .people-card-name {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    
    .people-card-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-director {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge-officer {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .badge-trustee {
      background: #fff3e0;
      color: #e65100;
    }
    
    .badge-psc {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .people-card-details {
      color: #666;
      font-size: 0.8rem;
      line-height: 1.4;
    }
    
    .people-card-share {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #ddd;
      color: var(--primary);
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .no-people-message {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 0.85rem;
      font-style: italic;
    }
    
    /* Name row layout: Title (narrow), First Name (smaller), Middle Name (equal), Last Name (equal) */
    .name-row {
      display: grid;
      grid-template-columns: 100px 150px 1fr 1fr;
      gap: var(--gap);
    }
    
    /* Phone/Email row layout: aligns with name row above for clean vertical lines */
    .phone-email-row {
      display: grid;
      grid-template-columns: 100px 150px 1fr;
      gap: var(--gap);
    }
    
    /* Third row: Name Change Toggle (left 2 cols) + DOB (right col, aligned with email) */
    .toggle-dob-row {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: var(--gap);
    }
    
    /* Name change fields row: Previous Name (left 2 cols) + Reason (right col, aligned with email) */
    .name-change-row {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: var(--gap);
    }
    
    /* Date of birth inputs */
    .birthdate-inputs { 
      display: flex; 
      gap: 6px; 
      margin-top: 6px; 
      align-items: center; 
    }
    .birthdate-inputs input { 
      width: calc(2.5ch + 8px); 
      text-align: center; 
      padding: 8px; 
      font-size: 0.9rem; 
    }
    .birthdate-inputs input:nth-of-type(2), 
    .birthdate-inputs input:nth-of-type(4) { 
      margin-right: var(--gap); 
    }
    
    /* Toggle switch */
    .toggle { 
      position: relative; 
      display: inline-block; 
      width: 50px; 
      height: 24px; 
      margin-top: 6px; 
    }
    .toggle input { display: none; }
    .slider { 
      position: absolute; 
      cursor: pointer; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: #e02424; 
      transition: 0.4s; 
      border-radius: 24px; 
    }
    .slider:before { 
      position: absolute; 
      content: ''; 
      height: 18px; 
      width: 18px; 
      left: 3px; 
      bottom: 3px; 
      background: #fff; 
      transition: 0.4s; 
      border-radius: 50%; 
    }
    input:checked + .slider { background: #10a37f; }
    input:checked + .slider:before { transform: translateX(26px); }
    input:disabled + .slider { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    /* Error popup */
    .error-popup { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      background: var(--error); 
      color: #fff; 
      padding: 20px; 
      border-radius: 12px; 
      display: flex; 
      flex-direction: column;
      gap: 12px; 
      font-weight: 600; 
      max-width: 420px; 
      min-width: 300px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
    }
    
    .error-popup-header {
      font-family: 'Transport', 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
    }
    
    .error-popup-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .error-popup button { 
      background: none; 
      border: none; 
      color: #fff; 
      font-size: 1.2rem; 
      cursor: pointer; 
      margin-left: auto;
    }
    
    .hidden { display: none !important; }
    
    /* Address autocomplete dropdown */
    .address-autocomplete-container {
      position: relative;
      width: 100%;
    }
    
    .address-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #4A90E2;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-top: -8px;
    }
    
    .address-dropdown-item {
      padding: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
    }
    
    .address-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .address-dropdown-item:hover {
      background-color: rgba(74, 144, 226, 0.1);
    }
    
    .address-dropdown-item.selected {
      background-color: rgba(74, 144, 226, 0.2);
    }
    
    .address-loading {
      padding: 10px;
      text-align: center;
      color: #666;
      font-size: 0.85rem;
    }
    
    .address-no-results {
      padding: 10px;
      text-align: center;
      color: #999;
      font-size: 0.85rem;
    }
    
    /* Jurisdiction/Country/Phone Autocomplete Dropdown Items */
    .dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .dropdown-item:hover {
      background: #f8f8f8;
    }
    
    .jurisdiction-name,
    .phone-display {
      font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 0.9rem;
      color: #333;
    }
    
    .jurisdiction-code {
      font-family: 'Transport', 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      color: rgb(0, 60, 113);
      background: #e8f4f8;
      padding: 2px 8px;
      border-radius: 3px;
    }
    
    .dropdown-item-empty {
      padding: 12px;
      text-align: center;
      color: #999;
      font-size: 0.85rem;
      font-style: italic;
      font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    /* Checkbox styling for "Address not listed" */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      border-radius: 5px;
      border: 2px solid #ddd;
      transition: all 0.2s;
    }
    
    .checkbox-container input[type="checkbox"]:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .checkbox-container input[type="checkbox"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,60,113,0.2);
    }
    
    .checkbox-container input[type="checkbox"]:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
    }
    
    /* Company Link and Refresh Buttons */
    .company-link-btn,
    .company-refresh-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      transition: all 0.2s;
      padding: 0;
    }
    
    .company-link-btn {
      right: 46px;
    }
    
    .company-refresh-btn {
      right: 4px;
    }
    
    .company-buttons-container {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .company-buttons-container .address-autocomplete-container {
      flex: 1;
    }
    
    .company-link-btn:hover,
    .company-refresh-btn:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }
    
    .company-link-btn:active,
    .company-refresh-btn:active {
      transform: scale(0.95);
    }
    
    .company-link-btn:disabled,
    .company-refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ddd;
      color: #999;
    }
    
    .company-link-btn:disabled:hover,
    .company-refresh-btn:disabled:hover {
      background: white;
      color: #999;
      transform: none;
    }
    
    /* Country dropdown styling */
    .country-dropdown {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 300;
      transition: border 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
      background: white;
      cursor: pointer;
    }
    
    .country-dropdown:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0,60,113,0.2);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .section { padding: 10px; }
      .row-grid-20-80 { 
        grid-template-columns: 25% 1fr; 
        gap: 15px; 
      }
      .row-grid-50-50 { 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
      }
      .row-grid-25-25-50 { 
        grid-template-columns: 20% 20% 1fr; 
        gap: 15px; 
      }
      .name-row {
        grid-template-columns: 80px 120px 1fr 1fr;
        gap: 15px;
      }
      .phone-email-row {
        grid-template-columns: 80px 120px 1fr;
        gap: 15px;
      }
      .toggle-dob-row {
        grid-template-columns: 215px 1fr;
        gap: 15px;
      }
      .name-change-row {
        grid-template-columns: 215px 1fr;
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .container { padding: 8px; }
      .section { padding: 10px; }
      h2 { font-size: 15px; }
      input, select { padding: 8px; font-size: 0.85rem; }
      
      .row-grid-20-80 { 
        grid-template-columns: 30% 1fr; 
        gap: 10px; 
      }
      
      .row-grid-50-50 { 
        grid-template-columns: 1fr; 
        gap: 10px; 
      }
      
      .row-grid-25-25-50 { 
        grid-template-columns: 1fr; 
        gap: 10px; 
      }
      
      .name-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .phone-email-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .toggle-dob-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .name-change-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .birthdate-inputs { 
        gap: 4px; 
      }
      .birthdate-inputs input { 
        width: calc(2ch + 6px); 
        padding: 6px; 
        font-size: 0.8rem; 
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Client Details Section -->
    <div class="section" id="detailsSection">
      <form id="clientForm">
        <!-- Entity Mode Fields (hidden by default) -->
        <div id="entityFields" class="hidden">
          <!-- Row 1: Business Name (Full Width) with buttons -->
          <div class="row">
            <label for="businessName">Business Name</label>
            <div class="company-buttons-container">
              <div class="address-autocomplete-container">
                <input type="text" id="businessName" name="businessName" autocomplete="off" placeholder="Search by company name..." />
                <div id="businessNameDropdown" class="address-dropdown hidden"></div>
              </div>
              <!-- Companies House Link Button (shows when company data linked) -->
              <button type="button" id="companyLinkBtn" class="hidden" title="View on Companies House" style="flex-shrink: 0; width: 36px; height: 36px; background: white; border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </button>
              <!-- Refresh Company Data Button (shows when company data linked) -->
              <button type="button" id="companyRefreshBtn" class="hidden" title="Refresh company data from Companies House" style="flex-shrink: 0; width: 36px; height: 36px; background: white; border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
              </button>
              <!-- Download Company Summary Button (shows when company data linked) -->
              <button type="button" id="downloadSummaryBtn" class="hidden" title="Download company summary as PDF" style="flex-shrink: 0; width: 36px; height: 36px; background: white; border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Row 2: Split Grid - Left (Country + Number) | Right (People Cards) -->
          <div class="entity-grid">
            <!-- Left Column: Registration Country + Company Number -->
            <div class="entity-left">
          <div>
            <label for="registrationCountry">Registration Country</label>
            <div class="address-autocomplete-container">
              <input type="text" id="registrationCountry" name="registrationCountry" autocomplete="off" placeholder="Search country..." value="United Kingdom" data-jurisdiction-code="GB" class="country-dropdown" />
              <div id="registrationCountryDropdown" class="address-dropdown hidden"></div>
            </div>
          </div>
              
              <div>
                <label for="entityNumber">Company Number</label>
                <div class="address-autocomplete-container">
                  <input type="text" id="entityNumber" name="entityNumber" autocomplete="off" placeholder="Search by company number..." data-organisation-number="" />
                  <div id="entityNumberDropdown" class="address-dropdown hidden"></div>
                </div>
              </div>
            </div>
            
            <!-- Right Column: People Cards (Officers, Directors, PSCs) -->
            <div class="entity-right">
              <h3 style="margin: 0 0 4px 0; font-size: 0.9rem; color: #666;">People</h3>
              <div style="margin-top: 4px; margin-bottom: 8px; padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; font-size: 0.75rem; color: #856404; line-height: 1.3;">
                ⚠️ Ensure all directors and people with &gt; 25% share have undergone appropriate AML &amp; ID checks
              </div>
              <div class="people-scrollable">
                <div id="peopleRepeater">
                  <div class="no-people-message">Link a company to view officers, directors, and PSCs</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Individual Mode Fields (shown by default) -->
        <div id="individualFields">
        <div class="row name-row">
          <div>
            <label for="titlePrefix">Title</label>
            <select id="titlePrefix" name="titlePrefix">
              <option value="">Select...</option>
              <option value="Mr">Mr</option>
              <option value="Mrs">Mrs</option>
              <option value="Ms">Ms</option>
              <option value="Miss">Miss</option>
              <option value="Master">Master</option>
              <option value="Dr">Dr</option>
              <option value="Lord">Lord</option>
              <option value="Rev">Rev</option>
              <option value="Mx">Mx</option>
              <option value="Lad">Lad</option>
              <option value="Dame">Dame</option>
            </select>
          </div>
          <div>
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" name="firstName" />
          </div>
          <div>
            <label for="middleName">Middle Name</label>
            <input type="text" id="middleName" name="middleName" />
          </div>
          <div>
            <label for="lastName">Surname</label>
            <input type="text" id="lastName" name="lastName" />
          </div>
        </div>

        <!-- Entity Number Row (shown only in entity mode, replaces DOB row) -->
        <div id="entityNumberRow" class="hidden">
          <div class="row">
            <label for="entityNumber" class="required">Entity Number</label>
            <input type="text" id="entityNumber" name="entityNumber" placeholder="Company registration number" />
          </div>
        </div>

        <div class="row phone-email-row">
          <div>
            <label for="phoneCountryCode">Code</label>
            <div class="address-autocomplete-container">
              <input type="text" id="phoneCountryCode" name="phoneCountryCode" autocomplete="off" placeholder="Search country code..." value="🇬🇧 +44 UK" data-phone-code="+44" data-country-code="GB" />
              <div id="phoneCountryCodeDropdown" class="address-dropdown hidden"></div>
            </div>
          </div>
          <div>
            <label for="phoneNumber">Mobile Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" />
          </div>
          <div>
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" placeholder="name@example.com" />
          </div>
        </div>

        <div class="row toggle-dob-row" id="nameChangeDobRow">
          <div>
            <label>Known as/Name change</label>
            <label class="toggle" title="If the client has changed their name in the last three years or is known by another name please select the toggle">
              <input type="checkbox" id="recentNameChange" />
              <span class="slider"></span>
            </label>
          </div>
          <div>
            <label>Date of Birth</label>
            <div class="birthdate-inputs">
              <input type="text" maxlength="1" id="dob1" />
              <input type="text" maxlength="1" id="dob2" />
              <input type="text" maxlength="1" id="dob3" />
              <input type="text" maxlength="1" id="dob4" />
              <input type="text" maxlength="1" id="dob5" />
              <input type="text" maxlength="1" id="dob6" />
              <input type="text" maxlength="1" id="dob7" />
              <input type="text" maxlength="1" id="dob8" />
            </div>
          </div>
        </div>

        <div id="nameChangeFields" class="hidden">
          <div class="row name-change-row">
            <div>
              <label for="previousName">Previous/Known as name</label>
              <input type="text" id="previousName" name="previousName" />
            </div>
            <div>
              <label for="reasonForNameChange">Reason for Name Change</label>
              <input type="text" id="reasonForNameChange" name="reasonForNameChange" placeholder="Marriage/Divorce, Name change by deed poll, Known as..." />
            </div>
          </div>
        </div>
        </div>
        <!-- End Individual Fields -->

        <!-- Address Fields (shown for both entity and individual) -->
        <div class="row name-change-row">
          <div>
            <label for="currentCountry">Country</label>
            <div class="address-autocomplete-container">
              <input type="text" id="currentCountry" name="currentCountry" autocomplete="off" placeholder="Search country..." value="United Kingdom" data-country-code="GBR" class="country-dropdown" />
              <div id="currentCountryDropdown" class="address-dropdown hidden"></div>
            </div>
          </div>
          <div id="currentAddressAutocompleteRow">
            <label for="currentAddress" id="currentAddressLabel">Search Address</label>
            <div class="address-autocomplete-container">
              <input type="text" id="currentAddress" name="currentAddress" autocomplete="off" placeholder="Start typing address or postcode..." />
              <div id="currentAddressDropdown" class="address-dropdown hidden"></div>
            </div>
          </div>
        </div>

        <div class="row name-change-row">
          <div>
            <label>Recent Move (within last year)</label>
            <label class="toggle" title="If the client has moved home in the past 1 year please enter their previous address">
              <input type="checkbox" id="recentMove" />
              <span class="slider"></span>
            </label>
          </div>
          <div id="addressNotListedRow">
            <div class="checkbox-container">
              <input type="checkbox" id="addressNotListed" />
              <label for="addressNotListed">Address not listed (enter manually)</label>
            </div>
          </div>
        </div>

        <!-- Manual address entry fields -->
        <div id="manualAddressFields" class="hidden">
        <div class="row row-grid-25-25-50">
          <div>
            <label for="flatNumber">Flat Number</label>
            <input type="text" id="flatNumber" name="flatNumber" />
          </div>
          <div>
            <label for="buildingNumber">Building Number</label>
            <input type="text" id="buildingNumber" name="buildingNumber" />
          </div>
          <div>
            <label for="buildingName">Building Name</label>
            <input type="text" id="buildingName" name="buildingName" />
          </div>
        </div>
        
        <div class="row row-grid-50-50">
          <div>
            <label for="street">Street</label>
            <input type="text" id="street" name="street" />
          </div>
          <div>
            <label for="subStreet">Sub Street</label>
            <input type="text" id="subStreet" name="subStreet" />
          </div>
        </div>
        
        <div class="row row-grid-50-50">
          <div>
            <label for="town">Town/City</label>
            <input type="text" id="town" name="town" />
          </div>
          <div>
            <label for="postcode">Postcode</label>
            <input type="text" id="postcode" name="postcode" />
          </div>
        </div>
        </div>

        <div id="previousAddressFields" class="hidden">
          <div class="row name-change-row">
            <div>
              <label for="previousCountry">Country</label>
              <div class="address-autocomplete-container">
                <input type="text" id="previousCountry" name="previousCountry" autocomplete="off" placeholder="Search country..." value="United Kingdom" data-country-code="GBR" class="country-dropdown" />
                <div id="previousCountryDropdown" class="address-dropdown hidden"></div>
              </div>
            </div>
            <div id="previousAddressAutocompleteRow">
              <label for="previousAddress" id="previousAddressLabel">Search Address</label>
              <div class="address-autocomplete-container">
                <input type="text" id="previousAddress" name="previousAddress" autocomplete="off" placeholder="Start typing address or postcode..." />
                <div id="previousAddressDropdown" class="address-dropdown hidden"></div>
              </div>
            </div>
          </div>

          <div class="row name-change-row">
            <div></div>
            <div id="previousAddressNotListedRow">
              <div class="checkbox-container">
                <input type="checkbox" id="previousAddressNotListed" />
                <label for="previousAddressNotListed">Address not listed (enter manually)</label>
              </div>
            </div>
          </div>
        
        <!-- Manual previous address entry fields -->
        <div id="manualPreviousAddressFields" class="hidden">
          <div class="row row-grid-25-25-50">
            <div>
              <label for="prevFlatNumber">Flat Number</label>
              <input type="text" id="prevFlatNumber" name="prevFlatNumber" />
            </div>
            <div>
              <label for="prevBuildingNumber">Building Number</label>
              <input type="text" id="prevBuildingNumber" name="prevBuildingNumber" />
            </div>
            <div>
              <label for="prevBuildingName">Building Name</label>
              <input type="text" id="prevBuildingName" name="prevBuildingName" />
            </div>
          </div>
          
          <div class="row row-grid-50-50">
            <div>
              <label for="prevStreet">Street</label>
              <input type="text" id="prevStreet" name="prevStreet" />
            </div>
            <div>
              <label for="prevSubStreet">Sub Street</label>
              <input type="text" id="prevSubStreet" name="prevSubStreet" />
            </div>
          </div>
          
          <div class="row row-grid-50-50">
            <div>
              <label for="prevTown">Town/City</label>
              <input type="text" id="prevTown" name="prevTown" />
            </div>
            <div>
              <label for="prevPostcode">Postcode</label>
              <input type="text" id="prevPostcode" name="prevPostcode" />
            </div>
          </div>
        </div>
        </div>
      </form>
      </div>
    </div>
  </div>

  <!-- Error popup -->
  <div id="errorPopup" class="error-popup hidden">
    <h4 class="error-popup-header">Validation Error</h4>
    <div class="error-popup-content">
      <span id="errorMessage" style="white-space:pre-wrap;"></span>
      <button type="button" id="closeError">×</button>
    </div>
  </div>

  <script>
    /*
    =====================================================================
    CLIENT DETAILS FORM - JAVASCRIPT
    =====================================================================
    
    GLOBAL STATE:
    - formData: Client data from parent
    - currentAddressObject: Thirdfort-formatted current address
    - previousAddressObject: Thirdfort-formatted previous address
    - addressDebounceTimer: Debounce timer for current address
    - previousAddressDebounceTimer: Debounce timer for previous address
    - isEntityMode: Boolean flag for entity vs individual mode
    
    PARENT-CHILD COMMUNICATION:
    
    INCOMING MESSAGES:
    1. 'client-data' - Load client data with structure:
       {
         type: 'client-data',
         entity: true/false,     // Controls entity vs individual mode
         entityType: 'business'/'charity', // Type of entity (when entity=true)
         allowEdits: true/false, // Controls if user can edit inputs (default: true)
         clientData: {
           n: { t, f, m, l, b },  // name: titlePrefix, firstName, middleNames, surname, businessName/charityName
           b: '01-01-2000',       // dateOfBirth
           a: {...},              // currentAddressNEW (Thirdfort object)
           pA: {...},             // previousAddressNEW (Thirdfort object)
           rM: true/false,        // clientRecentHomeMove
           nC: true/false,        // clientRecentNameChange
           pN: 'Previous Name',   // previousName
           rNC: 'Reason',         // reasonForNameChange
           m: '+447700000000',    // mobileNumber (international format)
           e: 'email@test.com',   // email
           eN: 'EN123456',        // entityNumber (company OR charity number)
           rC: 'GB',              // registrationCountry
           eT: 'business'/'charity', // entityType
           bD: {...}              // businessData (company: directors/officers/PSCs, charity: trustees)
         }
       }
    2. 'entity-true' - Toggle entity mode { type: 'entity-true', entityType: 'business'/'charity' }
    3. 'entity-false' - Toggle individual mode
    4. 'allowEdits-true' / 'allowEdits-false' - Enable/disable user input
    5. 'request-data' - Parent requests form data (validate and return)
    6. 'address-results' - Autocomplete suggestions from getaddress.io
    7. 'address-data' - Full address object after selection
    8. 'company-results' - Company search results from Companies House API
    9. 'company-data' - Full company data (directors, officers, PSCs, registered office)
    10. 'charity-results' - Charity search results from Charity Commission API
    11. 'charity-data' - Full charity data (trustees, income, expenditure)
    12. 'sanctions-check' - Request to format client data for sanctions search
    
    OUTGOING MESSAGES:
    1. 'address-search' - Request autocomplete suggestions
    2. 'address-lookup' - Request full address by ID
    3. 'company-search' - Request Companies House search { type, searchTerm, searchBy, entityType: 'business' }
    4. 'company-lookup' - Request full company data { type, companyNumber, entityType: 'business' }
    5. 'charity-search' - Request Charity Commission search { type, searchTerm, searchBy, entityType: 'charity' }
    6. 'charity-lookup' - Request full charity data { type, companyNumber, entityType: 'charity' }
    7. 'new-data' - Send updated client data (includes eT: entityType)
    8. 'validation-error' - Send validation errors
    9. 'disable-close' - Notify parent of unsaved changes
    10. 'sanctions-information' - Send formatted client data for sanctions checker { clientName, yearOfBirth, searchType }
    =====================================================================
    */
    
    // DOM Elements
    const detailsSection = document.getElementById('detailsSection');
    const clientForm = document.getElementById('clientForm');
    const errorPopup = document.getElementById('errorPopup');
    const errorMessage = document.getElementById('errorMessage');
    const closeError = document.getElementById('closeError');
    
    // Entity mode containers
    const entityFields = document.getElementById('entityFields');
    const individualFields = document.getElementById('individualFields');
    const entityNumberRow = document.getElementById('entityNumberRow');
    const nameChangeDobRow = document.getElementById('nameChangeDobRow');
    
    // Entity mode inputs
    const registrationCountry = document.getElementById('registrationCountry');
    const businessName = document.getElementById('businessName');
    const businessNameDropdown = document.getElementById('businessNameDropdown');
    const entityNumber = document.getElementById('entityNumber');
    const entityNumberDropdown = document.getElementById('entityNumberDropdown');
    const companyLinkBtn = document.getElementById('companyLinkBtn');
    const companyRefreshBtn = document.getElementById('companyRefreshBtn');
    const downloadSummaryBtn = document.getElementById('downloadSummaryBtn');
    const peopleRepeater = document.getElementById('peopleRepeater');
    
    // Form inputs
    const titlePrefix = document.getElementById('titlePrefix');
    const firstName = document.getElementById('firstName');
    const middleName = document.getElementById('middleName');
    const lastName = document.getElementById('lastName');
    const phoneCountryCode = document.getElementById('phoneCountryCode');
    const phoneNumber = document.getElementById('phoneNumber');
    const email = document.getElementById('email');
    const recentNameChange = document.getElementById('recentNameChange');
    const nameChangeFields = document.getElementById('nameChangeFields');
    const previousName = document.getElementById('previousName');
    const reasonForNameChange = document.getElementById('reasonForNameChange');
    const dobInputs = Array.from(document.querySelectorAll('.birthdate-inputs input'));
    
    // Address inputs
    const currentCountry = document.getElementById('currentCountry');
    const currentAddressAutocompleteRow = document.getElementById('currentAddressAutocompleteRow');
    const currentAddress = document.getElementById('currentAddress');
    const currentAddressDropdown = document.getElementById('currentAddressDropdown');
    const currentAddressLabel = document.getElementById('currentAddressLabel');
    const addressNotListedRow = document.getElementById('addressNotListedRow');
    const addressNotListed = document.getElementById('addressNotListed');
    const manualAddressFields = document.getElementById('manualAddressFields');
    const flatNumber = document.getElementById('flatNumber');
    const buildingNumber = document.getElementById('buildingNumber');
    const buildingName = document.getElementById('buildingName');
    const street = document.getElementById('street');
    const subStreet = document.getElementById('subStreet');
    const town = document.getElementById('town');
    const postcode = document.getElementById('postcode');
    const recentMove = document.getElementById('recentMove');
    const previousAddressFields = document.getElementById('previousAddressFields');
    const previousCountry = document.getElementById('previousCountry');
    const previousAddressAutocompleteRow = document.getElementById('previousAddressAutocompleteRow');
    const previousAddress = document.getElementById('previousAddress');
    const previousAddressDropdown = document.getElementById('previousAddressDropdown');
    const previousAddressLabel = document.getElementById('previousAddressLabel');
    const previousAddressNotListedRow = document.getElementById('previousAddressNotListedRow');
    const previousAddressNotListed = document.getElementById('previousAddressNotListed');
    const manualPreviousAddressFields = document.getElementById('manualPreviousAddressFields');
    const prevFlatNumber = document.getElementById('prevFlatNumber');
    const prevBuildingNumber = document.getElementById('prevBuildingNumber');
    const prevBuildingName = document.getElementById('prevBuildingName');
    const prevStreet = document.getElementById('prevStreet');
    const prevSubStreet = document.getElementById('prevSubStreet');
    const prevTown = document.getElementById('prevTown');
    const prevPostcode = document.getElementById('prevPostcode');
    
    // State variables
    let errorTimeout = null;
    let formData = {};
    let currentAddressObject = null;
    let previousAddressObject = null;
    let addressDebounceTimer = null;
    let previousAddressDebounceTimer = null;
    let companyNameDebounceTimer = null;
    let companyNumberDebounceTimer = null;
    let isEntityMode = false;
    let entityType = 'business'; // 'business' or 'charity'
    let isLoadingData = false; // Flag to prevent disable-close during initial load
    let hasUnsavedChanges = false;
    let allowEdits = true; // Flag to control if user can edit inputs
    let businessData = null; // Stores full company/charity data (directors/trustees, officers, PSCs)
    
    // ===== UTILITY FUNCTIONS =====
    
    function showError(msg) {
      errorMessage.textContent = msg;
      errorPopup.classList.remove('hidden');
      if (errorTimeout) clearTimeout(errorTimeout);
      errorTimeout = setTimeout(() => {
        errorPopup.classList.add('hidden');
      }, 5000);
    }
    
    function hideError() {
      errorPopup.classList.add('hidden');
      if (errorTimeout) clearTimeout(errorTimeout);
    }
    
    closeError.addEventListener('click', hideError);
    
    // ===== EDIT CONTROL =====
    
    function setEditMode(enabled) {
      allowEdits = enabled;
      
      // Get all form inputs (excluding company buttons - handled separately)
      const allFormInputs = [
        registrationCountry, businessName, entityNumber,
        titlePrefix, firstName, middleName, lastName,
        phoneCountryCode, phoneNumber, email,
        previousName, reasonForNameChange,
        currentCountry, currentAddress,
        flatNumber, buildingNumber, buildingName, street, subStreet, town, postcode,
        previousCountry, previousAddress,
        prevFlatNumber, prevBuildingNumber, prevBuildingName, prevStreet, prevSubStreet, prevTown, prevPostcode,
        recentNameChange, recentMove, addressNotListed, previousAddressNotListed
      ];
      
      // Add DOB inputs
      const allFormElements = [...allFormInputs, ...dobInputs];
      
      // Enable or disable all inputs
      allFormElements.forEach(input => {
        if (input) {
          input.disabled = !enabled;
        }
      });
      
      // Company buttons: Only disable refresh button, keep link and download enabled
      if (companyRefreshBtn) {
        companyRefreshBtn.disabled = !enabled;
      }
      // companyLinkBtn and downloadSummaryBtn stay enabled (always allow viewing and downloading)
      
      console.log(enabled ? '✅ Edit mode enabled' : '🔒 Edit mode disabled (read-only)');
    }
    
    // ===== CHANGE DETECTION =====
    
    function notifyUnsavedChanges() {
      if (!isLoadingData && !hasUnsavedChanges) {
        hasUnsavedChanges = true;
        console.log('🔒 Unsaved changes detected, disabling close button');
        window.parent.postMessage({
          type: 'disable-close'
        }, '*');
      }
    }
    
    // ===== ENTITY MODE TOGGLE =====
    
    function switchToEntityMode(type = 'business') {
      isEntityMode = true;
      entityType = type;
      entityFields.classList.remove('hidden');
      individualFields.classList.add('hidden');
      updateEntityLabels();
      console.log(`Switched to entity mode: ${type}`);
    }
    
    function switchToIndividualMode() {
      isEntityMode = false;
      entityFields.classList.add('hidden');
      individualFields.classList.remove('hidden');
      console.log('Switched to individual mode');
    }
    
    /*
    Update labels based on entity type (business vs charity)
    */
    function updateEntityLabels() {
      const isCharity = entityType === 'charity';
      
      // Update labels
      document.querySelector('label[for="businessName"]').textContent = isCharity ? 'Charity Name' : 'Business Name';
      document.querySelector('label[for="entityNumber"]').textContent = isCharity ? 'Charity Number' : 'Company Number';
      
      // Update placeholders
      businessName.placeholder = isCharity ? 'Search by charity name...' : 'Search by company name...';
      entityNumber.placeholder = isCharity ? 'Search by charity number...' : 'Search by company number...';
      
      // Update registration country label
      document.querySelector('label[for="registrationCountry"]').textContent = 'Registration Country';
      
      console.log(`✅ Labels updated for ${entityType} mode`);
    }
    
    // ===== CACHE MANAGEMENT =====
    
    /*
    LocalStorage Cache for Address API Results
    - Reduces API calls by caching autocomplete suggestions and full address objects
    - 7-day expiry on cached items
    - LRU eviction: max 50 autocomplete results, max 50 address objects
    - Cache keys: 'auto_SEARCHTERM' for suggestions, 'addr_ADDRESSID' for full addresses
    */
    
    const CACHE_EXPIRY_DAYS = 7;
    const MAX_AUTOCOMPLETE_CACHE = 50;
    const MAX_ADDRESS_CACHE = 50;
    
    // Clear expired cache items on page load
    clearExpiredCache();
    
    function isCacheExpired(timestamp) {
      const now = Date.now();
      const expiryMs = CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
      return (now - timestamp) > expiryMs;
    }
    
    function getCachedItem(key, type) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const parsed = JSON.parse(cached);
        
        // Check if expired
        if (isCacheExpired(parsed.timestamp)) {
          localStorage.removeItem(key);
          return null;
        }
        
        // Update timestamp for LRU (mark as recently accessed)
        parsed.timestamp = Date.now();
        localStorage.setItem(key, JSON.stringify(parsed));
        
        return parsed.data;
      } catch (error) {
        console.error('Cache read error:', error);
        return null;
      }
    }
    
    function setCachedItem(key, data, type) {
      try {
        const item = {
          data: data,
          timestamp: Date.now(),
          type: type
        };
        
        localStorage.setItem(key, JSON.stringify(item));
        
        // Enforce cache limits with LRU eviction
        enforceCacheLimit(type);
      } catch (error) {
        console.error('Cache write error:', error);
      }
    }
    
    function enforceCacheLimit(type) {
      try {
        const prefix = type === 'autocomplete' ? 'auto_' : 'addr_';
        const maxItems = type === 'autocomplete' ? MAX_AUTOCOMPLETE_CACHE : MAX_ADDRESS_CACHE;
        
        // Get all items of this type
        const items = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith(prefix)) {
            const cached = localStorage.getItem(key);
            if (cached) {
              try {
                const parsed = JSON.parse(cached);
                items.push({ key: key, timestamp: parsed.timestamp });
              } catch (e) {
                // Invalid item, remove it
                localStorage.removeItem(key);
              }
            }
          }
        }
        
        // If over limit, remove oldest items
        if (items.length > maxItems) {
          // Sort by timestamp (oldest first)
          items.sort((a, b) => a.timestamp - b.timestamp);
          
          // Remove oldest items until we're at the limit
          const toRemove = items.length - maxItems;
          for (let i = 0; i < toRemove; i++) {
            localStorage.removeItem(items[i].key);
          }
        }
      } catch (error) {
        console.error('Cache limit enforcement error:', error);
      }
    }
    
    function clearExpiredCache() {
      try {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.startsWith('auto_') || key.startsWith('addr_'))) {
            const cached = localStorage.getItem(key);
            if (cached) {
              try {
                const parsed = JSON.parse(cached);
                if (isCacheExpired(parsed.timestamp)) {
                  keysToRemove.push(key);
                }
              } catch (e) {
                keysToRemove.push(key); // Remove malformed items
              }
            }
          }
        }
        
        // Remove expired items
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        if (keysToRemove.length > 0) {
          console.log(`Cleared ${keysToRemove.length} expired cache items`);
        }
      } catch (error) {
        console.error('Cache cleanup error:', error);
      }
    }
    
    // ===== ADDRESS FORMATTING FUNCTIONS =====
    
    /*
    Parse manual address text into Thirdfort API format
    - Used when user types address manually (no autocomplete match)
    - Attempts to extract postcode, town, and address components
    - Returns UK-format address (no address_1/address_2 as per API spec)
    */
    function parseManualAddress(addressText, country = 'GBR') {
      if (!addressText || !addressText.trim()) return null;
      
      const text = addressText.trim();
      
      // UK addresses: Don't use address_1/address_2 (not allowed per API spec)
      if (country === 'GBR') {
        // Try to extract UK postcode
        const postcodeMatch = text.match(/\b([A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2})\b/i);
        const postcode = postcodeMatch ? postcodeMatch[1].toUpperCase() : '';
        
        // Split by commas
        const parts = text.split(',').map(p => p.trim()).filter(p => p);
        
        let town = '';
        let street = '';
        
        if (parts.length > 0) {
          if (postcode) {
            const postcodeIndex = parts.findIndex(p => p.toUpperCase().includes(postcode));
            if (postcodeIndex > 0) {
              town = parts[postcodeIndex - 1];
              street = parts[0]; // First part is likely the street with building number
            } else if (parts.length > 1) {
              town = parts[parts.length - 1];
              street = parts[0];
            } else {
              street = parts[0];
            }
          } else {
            if (parts.length > 1) {
              town = parts[parts.length - 1];
              street = parts[0];
            } else {
              street = parts[0];
            }
          }
        }
        
        return {
          building_name: '',
          building_number: '',
          flat_number: '',
          postcode: postcode,
          street: street || text,
          sub_street: '',
          town: town || 'Unknown',
          country: 'GBR'
        };
      }
      
      // Non-UK addresses: Use address_1, address_2
      const postcodeMatch = text.match(/\b([A-Z0-9]{3,10})\b/i);
      const postcode = postcodeMatch ? postcodeMatch[1].toUpperCase() : '';
      
      const parts = text.split(',').map(p => p.trim()).filter(p => p);
      let town = '';
      let addressLines = [];
      
      if (parts.length > 0) {
        if (parts.length > 1) {
          town = parts[parts.length - 1];
          addressLines = parts.slice(0, parts.length - 1);
        } else {
          addressLines = [parts[0]];
        }
      }
      
      return {
        address_1: addressLines[0] || text,
        address_2: addressLines[1] || '',
        postcode: postcode,
        street: '',
        sub_street: '',
        town: town || 'Unknown',
        state: '',
        country: country
      };
    }
    
    /*
    Format Companies House registered_office_address to Thirdfort API format
    - Companies House uses: premises, address_line_1, address_line_2, locality, postal_code
    - Thirdfort uses: building_name, building_number, street, sub_street, town, postcode
    */
    function formatCompaniesHouseToThirdfort(companiesHouseAddress) {
      if (!companiesHouseAddress) return null;
      
      // Companies House format breakdown:
      // premises: Building number (e.g., "94")
      // address_line_1: Building name or street (e.g., "Chynoweth", "Southgate Street")
      // address_line_2: Street or sub-street (e.g., "Chapel Street")
      // locality: Town/City (e.g., "Redruth")
      // postal_code: Postcode
      
      // Detect if address_line_1 is a street name or building name
      // If it contains "Street", "Road", "Avenue", "Lane", etc., it's likely a street
      const streetKeywords = /\b(street|road|avenue|lane|drive|close|way|place|terrace|crescent|square|court|grove|park|gardens?|mews|hill|row|walk|view|rise)\b/i;
      const isLine1Street = streetKeywords.test(companiesHouseAddress.address_line_1 || '');
      
      let buildingNumber = companiesHouseAddress.premises || '';
      let buildingName = '';
      let street = '';
      let subStreet = '';
      
      if (isLine1Street) {
        // address_line_1 is the street, address_line_2 is sub-street or additional info
        street = companiesHouseAddress.address_line_1 || '';
        subStreet = companiesHouseAddress.address_line_2 || '';
      } else {
        // address_line_1 is building name, address_line_2 is the street
        buildingName = companiesHouseAddress.address_line_1 || '';
        street = companiesHouseAddress.address_line_2 || '';
      }
      
      return {
        building_name: buildingName,
        building_number: buildingNumber,
        flat_number: '',
        postcode: companiesHouseAddress.postal_code || '',
        street: street,
        sub_street: subStreet,
        town: companiesHouseAddress.locality || '',
        country: 'GBR'
      };
    }
    
    /*
    Format getaddress.io address object to Thirdfort API format
    - UK (GBR): Uses individual fields (building_name, building_number, flat_number, street, etc.)
    - USA/CAN: Uses address_1, address_2, state
    - Other: Uses address_1, address_2
    - Per Thirdfort API spec: UK addresses must NOT include address_1/address_2
    */
    function formatToThirdfort(getAddressData, country = 'GBR') {
      if (!getAddressData) return null;
      
      // UK addresses: Individual fields only (no address_1, address_2)
      if (country === 'GBR') {
        // Strategy: Use explicit fields when available, intelligently extract from line_* when not
        // Complex parsing to handle all getaddress.io response variations
        
        let buildingNumber = getAddressData.building_number || getAddressData.sub_building_number || '';
        let buildingNameFromLine1 = '';
        let flatNumber = getAddressData.flat_number || '';
        
        // Parse line_1 intelligently using thoroughfare as the key
        if (getAddressData.line_1 && (!buildingNumber || !getAddressData.building_name)) {
          let addressPrefix = getAddressData.line_1.trim();
          
          // Remove thoroughfare/street from line_1 if present
          // Example: "94 Southgate Street" → "94" | "Thurstan Hoskin Llp" → "Thurstan Hoskin Llp"
          if (getAddressData.thoroughfare && addressPrefix.includes(getAddressData.thoroughfare)) {
            addressPrefix = addressPrefix.replace(getAddressData.thoroughfare, '').replace(/,\s*$/, '').trim();
          }
          
          // Now parse the remaining prefix (which has street already removed)
          if (addressPrefix) {
            // Check for flat number (e.g., "Flat 1A", "Flat 1A, Building Name")
            const flatMatch = addressPrefix.match(/^(?:Flat|flat|Apartment|apartment|Unit|unit|Apt|apt)\s+(\d+[a-zA-Z]?)/i);
            if (flatMatch && !flatNumber) {
              flatNumber = flatMatch[1];
              // Remove flat designation from prefix
              addressPrefix = addressPrefix.substring(flatMatch[0].length).replace(/^[,\s]+/, '').trim();
            }
            
            // Check if remaining starts with a number (building number like "94", "1A", etc.)
            if (!buildingNumber) {
              const numberMatch = addressPrefix.match(/^(\d+[a-zA-Z]?)\b/);
              if (numberMatch) {
                buildingNumber = numberMatch[1];
                // Remove number from prefix
                addressPrefix = addressPrefix.substring(numberMatch[0].length).replace(/^[,\s]+/, '').trim();
              }
            }
            
            // Whatever remains is the building name
            if (addressPrefix) {
              // Don't use purely numeric values as building names (they're building numbers)
              if (!/^\d+$/.test(addressPrefix)) {
              buildingNameFromLine1 = addressPrefix;
              }
            }
          }
        }
        
        // Building name: Combine all available building name data
        // Priority: sub_building_name, building_name/extracted from line_1, line_2 (if not street)
        const buildingNameParts = [
          getAddressData.sub_building_name,
          getAddressData.building_name && !/^\d+$/.test(getAddressData.building_name.trim()) ? getAddressData.building_name : buildingNameFromLine1,
          getAddressData.line_2 && getAddressData.line_2 !== getAddressData.thoroughfare ? getAddressData.line_2 : ''
        ].filter(p => p && p.trim());
        
        return {
          building_name: buildingNameParts.join(', ') || '',
          building_number: buildingNumber,
          flat_number: flatNumber,
          postcode: getAddressData.postcode || '',
          street: getAddressData.thoroughfare || getAddressData.line_3 || getAddressData.street || '',
          sub_street: getAddressData.sub_street || '',
          town: getAddressData.town_or_city || getAddressData.town || '',
          country: country
        };
  }
      
      // USA/Canada: address_1, address_2, state required
      if (country === 'USA' || country === 'CAN') {
        return {
          address_1: getAddressData.line_1 || '',
          address_2: getAddressData.line_2 || getAddressData.line_3 || getAddressData.line_4 || '',
          postcode: getAddressData.postcode || '',
          street: getAddressData.thoroughfare || getAddressData.street || '',
          sub_street: getAddressData.sub_street || '',
          town: getAddressData.town_or_city || getAddressData.town || '',
          state: getAddressData.state || getAddressData.province || '',
          country: country
        };
      }
      
      // Other countries: address_1, address_2 (no individual building fields)
      return {
        address_1: getAddressData.line_1 || '',
        address_2: getAddressData.line_2 || getAddressData.line_3 || getAddressData.line_4 || '',
        postcode: getAddressData.postcode || '',
        street: getAddressData.thoroughfare || getAddressData.street || '',
        sub_street: getAddressData.sub_street || '',
        town: getAddressData.town_or_city || getAddressData.town || '',
        state: '',
        country: country
      };
    }
    
    /*
    Format Thirdfort address object for display in input field
    - Used when loading existing data from database
    - UK addresses use individual fields (building_number, street, etc.)
    - Non-UK addresses use address_1, address_2
    - Per Thirdfort API spec: UK addresses don't have address_1/address_2
    */
    function formatThirdfortForDisplay(thirdfortAddress) {
      if (!thirdfortAddress) return '';
      
      // UK addresses: Build from individual fields
      if (thirdfortAddress.country === 'GBR') {
        const parts = [
          thirdfortAddress.flat_number,
          thirdfortAddress.building_number,
          thirdfortAddress.building_name,
          thirdfortAddress.street,
          thirdfortAddress.sub_street,
          thirdfortAddress.town,
          thirdfortAddress.postcode
        ].filter(p => p && p.trim());
        
        return parts.join(', ');
      }
      
      // Non-UK addresses: Use address_1, address_2
      const parts = [
        thirdfortAddress.address_1,
        thirdfortAddress.address_2,
        thirdfortAddress.town,
        thirdfortAddress.state,
        thirdfortAddress.postcode
      ].filter(p => p && p.trim());
      
      return parts.join(', ');
    }
    
    /*
    Format getaddress.io address for display
    */
    function formatAddressForDisplay(getAddressData) {
      if (!getAddressData) return '';
      
      const parts = [
        getAddressData.line_1,
        getAddressData.line_2,
        getAddressData.line_3,
        getAddressData.line_4,
        getAddressData.locality,
        getAddressData.town_or_city,
        getAddressData.postcode
      ].filter(p => p && p.trim());
      
      return parts.join(', ');
    }
    
    // ===== ADDRESS AUTOCOMPLETE =====
    
    /*
    Setup address autocomplete with debouncing
    */
    function setupAddressAutocomplete(inputElement, dropdownElement, timerType, isCurrentAddress) {
      let selectedIndex = -1;
      
      inputElement.addEventListener('input', (e) => {
        // Don't trigger API search during data loading
        if (isLoadingData) {
          return;
        }
        
        const searchTerm = e.target.value.trim();
        
        // Clear timer
        if (timerType === 'current') {
          if (addressDebounceTimer) clearTimeout(addressDebounceTimer);
        } else {
          if (previousAddressDebounceTimer) clearTimeout(previousAddressDebounceTimer);
        }
        
        // Clear stored object when user types
        if (isCurrentAddress) {
          currentAddressObject = null;
        } else {
          previousAddressObject = null;
        }
        
        // Hide dropdown if too short
        if (searchTerm.length < 7) {
          dropdownElement.classList.add('hidden');
          dropdownElement.innerHTML = '';
          return;
        }
        
        // Check cache first
        const cacheKey = 'auto_' + searchTerm.toLowerCase();
        const cachedSuggestions = getCachedItem(cacheKey, 'autocomplete');
        
        if (cachedSuggestions) {
          console.log('… Cache hit for autocomplete:', searchTerm);
          displayAddressSuggestions(cachedSuggestions, isCurrentAddress ? 'current' : 'previous');
          return;
        }
        
        // Show loading
        dropdownElement.classList.remove('hidden');
        dropdownElement.innerHTML = '<div class="address-loading">Searching addresses...</div>';
        
        // Debounce 300ms
        const timer = setTimeout(() => {
          console.log('📡 API call for autocomplete:', searchTerm);
          window.parent.postMessage({
            type: 'address-search',
            searchTerm: searchTerm,
            field: isCurrentAddress ? 'current' : 'previous'
          }, '*');
        }, 300);
        
        if (timerType === 'current') {
          addressDebounceTimer = timer;
        } else {
          previousAddressDebounceTimer = timer;
        }
      });
      
      // Keyboard navigation
      inputElement.addEventListener('keydown', (e) => {
        const items = dropdownElement.querySelectorAll('.address-dropdown-item');
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedItem(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedItem(items, selectedIndex);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          dropdownElement.classList.add('hidden');
          selectedIndex = -1;
        }
      });
      
      // Click outside to close
      document.addEventListener('click', (e) => {
        if (!inputElement.contains(e.target) && !dropdownElement.contains(e.target)) {
          dropdownElement.classList.add('hidden');
          selectedIndex = -1;
        }
      });
      
      function updateSelectedItem(items, index) {
        items.forEach((item, i) => {
          if (i === index) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        });
      }
    }
    
    /*
    Display address suggestions in dropdown
    */
    function displayAddressSuggestions(suggestions, field) {
      const dropdownElement = field === 'current' ? currentAddressDropdown : previousAddressDropdown;
      const isCurrentAddress = field === 'current';
      
      if (!suggestions || suggestions.length === 0) {
        dropdownElement.innerHTML = '<div class="address-no-results">No addresses found</div>';
        return;
      }
      
      dropdownElement.innerHTML = '';
      
      suggestions.forEach((suggestion) => {
        const item = document.createElement('div');
        item.className = 'address-dropdown-item';
        item.textContent = suggestion.address;
        
        item.addEventListener('click', () => {
          selectAddressSuggestion(suggestion.id, suggestion.address, isCurrentAddress);
        });
        
        dropdownElement.appendChild(item);
      });
    }
    
    /*
    Handle address selection from dropdown
    */
    function selectAddressSuggestion(addressId, displayText, isCurrentAddress) {
      const inputElement = isCurrentAddress ? currentAddress : previousAddress;
      const dropdownElement = isCurrentAddress ? currentAddressDropdown : previousAddressDropdown;
      
      inputElement.value = displayText;
      dropdownElement.classList.add('hidden');
      
      // Check cache for full address first
      const cacheKey = 'addr_' + addressId;
      const cachedAddress = getCachedItem(cacheKey, 'address');
      
      if (cachedAddress) {
        console.log('… Cache hit for full address:', addressId);
        handleAddressData(cachedAddress, isCurrentAddress ? 'current' : 'previous');
        return;
      }
      
      // Request full address from parent
      console.log('📡 API call for full address:', addressId);
      window.parent.postMessage({
        type: 'address-lookup',
        addressId: addressId,
        field: isCurrentAddress ? 'current' : 'previous'
      }, '*');
    }
    
    /*
    Handle full address data from parent
    */
    function handleAddressData(addressData, field) {
      const country = field === 'current' ? (currentCountry.dataset.countryCode || 'GBR') : (previousCountry.dataset.countryCode || 'GBR');
      const thirdfortAddress = formatToThirdfort(addressData, country);
      
      if (field === 'current') {
        currentAddressObject = thirdfortAddress;
      } else {
        previousAddressObject = thirdfortAddress;
      }
    }
    
    // ===== COMPANY SEARCH (Companies House) =====
    
    /*
    Setup company search autocomplete for business name
    */
    function setupCompanyNameAutocomplete() {
      let selectedIndex = -1;
      
      businessName.addEventListener('input', (e) => {
        // Don't trigger API search during data loading
        if (isLoadingData) {
          return;
        }
        
        const searchTerm = e.target.value.trim();
        
        // Clear timer
        if (companyNameDebounceTimer) clearTimeout(companyNameDebounceTimer);
        
        // Clear stored company data when user types
        businessData = null;
        updateCompanyButtons();
        
        // Hide dropdown if too short or not UK
        const isUK = registrationCountry.dataset.jurisdictionCode === 'GB';
        if (searchTerm.length < 2 || !isUK) {
          businessNameDropdown.classList.add('hidden');
          businessNameDropdown.innerHTML = '';
          return;
        }
        
        // Show loading
        businessNameDropdown.classList.remove('hidden');
        const searchingText = entityType === 'charity' ? 'Searching charities...' : 'Searching companies...';
        businessNameDropdown.innerHTML = `<div class="address-loading">${searchingText}</div>`;
        
        // Debounce 300ms
        companyNameDebounceTimer = setTimeout(() => {
          const apiType = entityType === 'charity' ? 'charity-search' : 'company-search';
          console.log(`📡 API call for ${entityType} name search:`, searchTerm);
          window.parent.postMessage({
            type: apiType,
            searchTerm: searchTerm,
            searchBy: 'name',
            entityType: entityType
          }, '*');
        }, 300);
      });
      
      // Keyboard navigation
      businessName.addEventListener('keydown', (e) => {
        const items = businessNameDropdown.querySelectorAll('.address-dropdown-item');
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedCompanyItem(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedCompanyItem(items, selectedIndex);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          businessNameDropdown.classList.add('hidden');
          selectedIndex = -1;
        }
      });
      
      // Click outside to close
      document.addEventListener('click', (e) => {
        if (!businessName.contains(e.target) && !businessNameDropdown.contains(e.target)) {
          businessNameDropdown.classList.add('hidden');
          selectedIndex = -1;
        }
      });
    }
    
    /*
    Setup company search autocomplete for entity number
    */
    function setupCompanyNumberAutocomplete() {
      let selectedIndex = -1;
      
      entityNumber.addEventListener('input', (e) => {
        // Don't trigger API search during data loading
        if (isLoadingData) {
          return;
        }
        
        const searchTerm = e.target.value.trim();
        
        // Clear timer
        if (companyNumberDebounceTimer) clearTimeout(companyNumberDebounceTimer);
        
        // Clear stored company data when user types
        businessData = null;
        updateCompanyButtons();
        
        // Hide dropdown if too short or not UK
        const isUK = registrationCountry.dataset.jurisdictionCode === 'GB';
        if (searchTerm.length < 2 || !isUK) {
          entityNumberDropdown.classList.add('hidden');
          entityNumberDropdown.innerHTML = '';
          return;
        }
        
        // Show loading
        entityNumberDropdown.classList.remove('hidden');
        const searchingText = entityType === 'charity' ? 'Searching charities...' : 'Searching companies...';
        entityNumberDropdown.innerHTML = `<div class="address-loading">${searchingText}</div>`;
        
        // Debounce 300ms
        companyNumberDebounceTimer = setTimeout(() => {
          const apiType = entityType === 'charity' ? 'charity-search' : 'company-search';
          console.log(`📡 API call for ${entityType} number search:`, searchTerm);
          window.parent.postMessage({
            type: apiType,
            searchTerm: searchTerm,
            searchBy: 'number',
            entityType: entityType
          }, '*');
        }, 300);
      });
      
      // Keyboard navigation
      entityNumber.addEventListener('keydown', (e) => {
        const items = entityNumberDropdown.querySelectorAll('.address-dropdown-item');
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedCompanyItem(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedCompanyItem(items, selectedIndex);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          entityNumberDropdown.classList.add('hidden');
          selectedIndex = -1;
        }
      });
      
      // Click outside to close
      document.addEventListener('click', (e) => {
        if (!entityNumber.contains(e.target) && !entityNumberDropdown.contains(e.target)) {
          entityNumberDropdown.classList.add('hidden');
          selectedIndex = -1;
        }
      });
    }
    
    function updateSelectedCompanyItem(items, index) {
      items.forEach((item, i) => {
        if (i === index) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    /*
    Display company suggestions in dropdown
    */
    function displayCompanySuggestions(suggestions, searchBy) {
      // Only show results in the dropdown for the field being searched
      const dropdownElement = searchBy === 'name' ? businessNameDropdown : entityNumberDropdown;
      
      if (!suggestions || suggestions.length === 0) {
        const noResultsText = entityType === 'charity' ? 'No charities found' : 'No companies found';
        dropdownElement.innerHTML = `<div class="address-no-results">${noResultsText}</div>`;
        dropdownElement.classList.remove('hidden');
        return;
      }
      
      dropdownElement.innerHTML = '';
      
      suggestions.forEach((company) => {
        const item = document.createElement('div');
        item.className = 'address-dropdown-item';
        // Format: "Company Name (Number)"
        item.textContent = `${company.title} (${company.company_number})`;
        
        item.addEventListener('click', () => {
          selectCompany(company);
        });
        
        dropdownElement.appendChild(item);
      });
      
      dropdownElement.classList.remove('hidden');
    }
    
    /*
    Handle company selection from dropdown
    */
    function selectCompany(company) {
      // Populate BOTH form fields
      businessName.value = company.title;
      entityNumber.value = company.company_number;
      
      // For charities, store organisation_number in data attribute (for URL construction)
      if (entityType === 'charity' && company.organisation_number) {
        entityNumber.dataset.organisationNumber = company.organisation_number;
        console.log(`🏷️ Stored organisation_number: ${company.organisation_number} (display: ${company.company_number})`);
      } else {
        entityNumber.dataset.organisationNumber = '';
      }
      
      // Hide both dropdowns
      businessNameDropdown.classList.add('hidden');
      entityNumberDropdown.classList.add('hidden');
      
      // Request full company/charity data from parent (directors/trustees, officers, PSCs)
      const apiType = entityType === 'charity' ? 'charity-lookup' : 'company-lookup';
      console.log(`📡 Requesting full ${entityType} data for:`, company.company_number);
      window.parent.postMessage({
        type: apiType,
        companyNumber: company.company_number,
        entityType: entityType
      }, '*');
      
      // Trigger unsaved changes
      notifyUnsavedChanges();
    }
    
    /*
    Handle full company data from parent
    */
    function handleCompanyData(data) {
      businessData = data;
      console.log('… Received full company data:', businessData);
      // Company data now includes: directors, officers, PSCs, registered_office_address, etc.
      
      // For charities, extract and store organisation_number in dataset (for URL construction)
      if (entityType === 'charity' && data.organisation_number) {
        entityNumber.dataset.organisationNumber = data.organisation_number;
        console.log(`🏷️ Stored organisation_number from charity data: ${data.organisation_number}`);
      }
      
      // Show the link and refresh buttons
      updateCompanyButtons();
      
      // Auto-populate registered office address when linking company/charity
      if (businessData.registered_office_address) {
        const regOffice = businessData.registered_office_address;
        
        // Convert Companies House address format directly to Thirdfort format
        const thirdfortAddress = formatCompaniesHouseToThirdfort(regOffice);
        
        if (thirdfortAddress) {
          // Check if new address is different from current (skip if identical)
          const currentDisplayText = formatThirdfortForDisplay(currentAddressObject);
          const newDisplayText = formatThirdfortForDisplay(thirdfortAddress);
          const isDifferentAddress = currentDisplayText !== newDisplayText;
          
          if (isDifferentAddress || !currentAddressObject) {
            console.log('📍 Auto-populating registered office address:', thirdfortAddress);
            
            // Set UK as country
            setCountry('currentCountry', 'GBR');
            
            // Store the Thirdfort address object directly
            currentAddressObject = thirdfortAddress;
            
            // Display in the autocomplete field
            currentAddress.value = formatThirdfortForDisplay(thirdfortAddress);
            
            console.log('… Registered office address converted and stored:', currentAddressObject);
          } else {
            console.log('ℹ️ Registered office address is identical to current address, keeping existing');
          }
        }
      }
      
      // Trigger unsaved changes
      notifyUnsavedChanges();
    }
    
    /*
    Update visibility of company link and refresh buttons
    */
    function updateCompanyButtons() {
      if (businessData && entityNumber?.value?.trim()) {
        companyLinkBtn.classList.remove('hidden');
        companyRefreshBtn.classList.remove('hidden');
        downloadSummaryBtn.classList.remove('hidden');
        populatePeopleCards();
      } else {
        companyLinkBtn.classList.add('hidden');
        companyRefreshBtn.classList.add('hidden');
        downloadSummaryBtn.classList.add('hidden');
        clearPeopleCards();
      }
    }
    
    /*
    Populate people cards (Officers, Directors, PSCs)
    */
    function populatePeopleCards() {
      if (!businessData || !peopleRepeater) return;
      
      peopleRepeater.innerHTML = '';
      
      // Use a map to merge duplicates by normalized name
      const peopleMap = new Map();
      
      // Extract Officers, Directors, and Trustees
      if (businessData.officers && businessData.officers.length > 0) {
        businessData.officers.forEach(officer => {
          // Skip resigned officers
          if (officer.resigned_on) return;
          
          const normalizedName = normalizeName(officer.name);
          const existing = peopleMap.get(normalizedName);
          
          // Determine role type
          let roleType;
          if (officer.officer_role === 'director') roleType = 'director';
          else if (officer.officer_role === 'trustee') roleType = 'trustee';
          else roleType = 'officer';
          
          if (existing) {
            // Add role if not already present
            if (!existing.types.includes(roleType)) {
              existing.types.push(roleType);
            }
            // Store officer link if not already set
            if (!existing.appointmentsUrl && officer.links?.officer?.appointments) {
              existing.appointmentsUrl = officer.links.officer.appointments;
            }
          } else {
            peopleMap.set(normalizedName, {
              displayName: officer.name,
              types: [roleType],
              share: null,
              appointmentsUrl: officer.links?.officer?.appointments || null
            });
          }
        });
      }
      
      // Extract PSCs (with ownership info)
      if (businessData.pscs && businessData.pscs.length > 0) {
        businessData.pscs.forEach(psc => {
          // Skip ceased PSCs
          if (psc.ceased) return;
          
          const normalizedName = normalizeName(psc.name);
          const existing = peopleMap.get(normalizedName);
          
          // Extract ownership percentage from natures_of_control
          let shareInfo = null;
          if (psc.natures_of_control && psc.natures_of_control.length > 0) {
            const control = psc.natures_of_control[0];
            if (control.includes('25-to-50')) shareInfo = '25-50%';
            else if (control.includes('50-to-75')) shareInfo = '50-75%';
            else if (control.includes('75-to-100')) shareInfo = '75-100%';
            else if (control.includes('ownership-of-shares')) shareInfo = 'Significant';
          }
          
          if (existing) {
            // Add PSC role and share info
            if (!existing.types.includes('psc')) {
              existing.types.push('psc');
            }
            existing.share = shareInfo;
            // Store PSC link if not already set
            if (!existing.appointmentsUrl && psc.links?.officer?.appointments) {
              existing.appointmentsUrl = psc.links.officer.appointments;
            }
          } else {
            peopleMap.set(normalizedName, {
              displayName: psc.name,
              types: ['psc'],
              share: shareInfo,
              appointmentsUrl: psc.links?.officer?.appointments || null
            });
          }
        });
      }
      
      const allPeople = Array.from(peopleMap.values());
    
      /*
      Normalize name for matching (remove titles, punctuation, sort words alphabetically)
      Handles variations like "HODIVALA, Olly" vs "Mr Olly Hodivala"
      */
      function normalizeName(name) {
        if (!name) return '';
        return name
          .toLowerCase()
          .replace(/^(mr|mrs|ms|miss|dr|rev|sir|lord|dame|prof|professor)\s+/i, '') // Remove titles
          .replace(/[,\.]/g, '') // Remove punctuation
          .split(/\s+/) // Split into words
          .filter(w => w) // Remove empty strings
          .sort() // Sort alphabetically
          .join(' ') // Join back
          .trim();
      }
      
      // Create cards
      if (allPeople.length === 0) {
        peopleRepeater.innerHTML = '<div class="no-people-message">No officers, directors, or PSCs found</div>';
        return;
      }
      
      allPeople.forEach(person => {
        const card = document.createElement('div');
        card.className = 'people-card';
        
        // Make card clickable
        // Companies: Click opens individual officer appointments page
        // Charities: Click opens charity trustees tab
        if (person.appointmentsUrl || entityType === 'charity') {
          card.style.cursor = 'pointer';
          card.title = entityType === 'charity' 
            ? 'Click to view all trustees' 
            : 'Click to view all appointments';
          
          card.addEventListener('click', () => {
            openOfficerAppointments(person.appointmentsUrl);
          });
        }
        
        // Create badges for all roles
        let badgesHtml = '';
        person.types.forEach(type => {
          const badgeClass = type === 'director' ? 'badge-director' : 
                            type === 'trustee' ? 'badge-trustee' :
                            type === 'psc' ? 'badge-psc' : 'badge-officer';
          const badgeText = type === 'director' ? 'Director' : 
                           type === 'trustee' ? 'Trustee' :
                           type === 'psc' ? 'PSC' : 'Officer';
          badgesHtml += `<span class="people-card-badge ${badgeClass}">${badgeText}</span>`;
        });
        
        let html = `
          <div class="people-card-header">
            <div class="people-card-name">${person.displayName}</div>
            <div style="display: flex; gap: 4px;">${badgesHtml}</div>
          </div>
        `;
        
        if (person.share) {
          html += `<div class="people-card-share">📊 ${person.share}</div>`;
        }
        
        card.innerHTML = html;
        peopleRepeater.appendChild(card);
      });
      
      console.log(`… Displayed ${allPeople.length} people cards`);
    }
    
    /*
    Clear people cards
    */
    function clearPeopleCards() {
      if (peopleRepeater) {
        const message = entityType === 'charity' 
          ? 'Link a charity to view trustees and directors'
          : 'Link a company to view officers, directors, and PSCs';
        peopleRepeater.innerHTML = `<div class="no-people-message">${message}</div>`;
      }
    }
    
    /*
    Open officer appointments page in Companies House (or charity trustees page)
    */
    function openOfficerAppointments(appointmentsPath) {
      if (!appointmentsPath) {
        // Charity trustees don't have individual pages, open charity trustees tab instead
        if (entityType === 'charity' && entityNumber?.value?.trim()) {
          // Use organisation_number for URL (not reg_charity_number)
          const orgNum = entityNumber.dataset.organisationNumber || entityNumber.value.trim();
          const url = `https://register-of-charities.charitycommission.gov.uk/en/charity-search/-/charity-details/${orgNum}/trustees`;
          
          // Open in centered popup window
          const width = 1000;
          const height = 800;
          const left = (screen.width - width) / 2;
          const top = (screen.height - height) / 2;
          const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`;
          
          window.open(url, 'charityTrustees', features);
          console.log('🔗 Opening charity trustees tab:', url);
        }
        return;
      }
      
      const url = `https://find-and-update.company-information.service.gov.uk${appointmentsPath}`;
      
      // Open in centered popup window
      const width = 1000;
      const height = 800;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;
      const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`;
      
      window.open(url, 'officerAppointments', features);
      console.log('🔗 Opening officer appointments:', url);
    }
    
    /*
    Open Companies House or Charity Commission page for the linked entity
    */
    function openCompaniesHousePage() {
      if (entityNumber?.value?.trim()) {
        let url;
        
        if (entityType === 'charity') {
          // Use organisation_number for URL (not reg_charity_number)
          const orgNum = entityNumber.dataset.organisationNumber || entityNumber.value.trim();
          url = `https://register-of-charities.charitycommission.gov.uk/en/charity-search/-/charity-details/${orgNum}/charity-overview`;
        } else {
          const entityNum = entityNumber.value.trim();
          url = `https://find-and-update.company-information.service.gov.uk/company/${entityNum}`;
        }
        
        // Open in centered popup window
        const width = 1000;
        const height = 800;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`;
        
        window.open(url, `${entityType}Register`, features);
      }
    }
    
    
    /*
    Refresh company data from Companies House
    */
    function refreshCompanyData() {
      if (entityNumber?.value?.trim()) {
        const companyNumber = entityNumber.value.trim();
        const apiType = entityType === 'charity' ? 'charity-lookup' : 'company-lookup';
        console.log(`🔄 Refreshing ${entityType} data for:`, companyNumber);
        window.parent.postMessage({
          type: apiType,
          companyNumber: companyNumber,
          entityType: entityType
        }, '*');
      }
    }
    
    /*
    Generate and download company/charity summary as PDF
    */
    function downloadCompanySummary() {
      if (!businessData || !window.jspdf) {
        console.error('Cannot generate PDF: missing data or jsPDF library');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      
      // Get current user email from parent (or use placeholder)
      const userEmail = 'user@thurstanhoskin.co.uk'; // Will be populated from parent
      const generatedDate = new Date().toLocaleString('en-GB', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      // A4 dimensions: 595pt wide, 842pt tall
      const pageWidth = 595;
      const pageHeight = 842;
      const margin = 40;
      let yPosition = margin;
      
      // Set font
      doc.setFont('helvetica');
      
      // Header - Add logos (Note: SVGs need to be converted or we use text)
      // For now, we'll use text headers - you can add logo images later
      doc.setFontSize(24);
      doc.setTextColor(0, 60, 113);
      doc.setFont('helvetica', 'bold');
      doc.text('Thurstan Hoskin', margin, yPosition);
      
      doc.setFontSize(18);
      doc.text("Val'ID'ate", pageWidth - margin - 120, yPosition);
      
      yPosition += 10;
      
      // Header border
      doc.setDrawColor(0, 60, 113);
      doc.setLineWidth(3);
      doc.line(margin, yPosition, pageWidth - margin, yPosition);
      
      yPosition += 25;
      
      // Document title
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      const title = entityType === 'charity' ? 'Charity Summary' : 'Company Summary';
      const titleWidth = doc.getTextWidth(title);
      doc.text(title, (pageWidth - titleWidth) / 2, yPosition);
      
      yPosition += 20;
      
      // Company/Charity name subtitle
      doc.setFontSize(14);
      doc.setTextColor(102, 102, 102);
      doc.setFont('helvetica', 'normal');
      const companyName = businessData.company_name || businessName?.value || 'Unknown';
      const subtitleWidth = doc.getTextWidth(companyName);
      doc.text(companyName, (pageWidth - subtitleWidth) / 2, yPosition);
      
      yPosition += 30;
      
      // Registration Details Section
      doc.setFontSize(14);
      doc.setTextColor(0, 60, 113);
      doc.setFont('helvetica', 'bold');
      doc.text('Registration Details', margin, yPosition);
      
      yPosition += 5;
      doc.setDrawColor(221, 221, 221);
      doc.setLineWidth(1);
      doc.line(margin, yPosition, pageWidth - margin, yPosition);
      
      yPosition += 15;
      
      // Company info
      doc.setFontSize(11);
      doc.setTextColor(51, 51, 51);
      const labelX = margin;
      const valueX = margin + 200;
      
      const companyInfo = [
        ['Company Name:', companyName],
        ['Company Number:', businessData.company_number || entityNumber?.value || 'N/A'],
        ['Registration Country:', registrationCountry?.value === 'GB' ? 'United Kingdom' : registrationCountry?.value || 'N/A'],
        ['Company Status:', businessData.company_status || 'N/A'],
        ['Date of Incorporation:', businessData.date_of_creation || 'N/A'],
        ['Company Type:', businessData.type || 'N/A']
      ];
      
      companyInfo.forEach(([label, value]) => {
        doc.setFont('helvetica', 'bold');
        doc.text(label, labelX, yPosition);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(85, 85, 85);
        doc.text(String(value), valueX, yPosition);
        doc.setTextColor(51, 51, 51);
        yPosition += 18;
      });
      
      yPosition += 10;
      
      // Registered Office Address
      doc.setFontSize(14);
      doc.setTextColor(0, 60, 113);
      doc.setFont('helvetica', 'bold');
      doc.text('Registered Office Address', margin, yPosition);
      
      yPosition += 5;
      doc.setDrawColor(221, 221, 221);
      doc.line(margin, yPosition, pageWidth - margin, yPosition);
      
      yPosition += 15;
      
      doc.setFontSize(11);
      doc.setTextColor(85, 85, 85);
      doc.setFont('helvetica', 'normal');
      
      if (businessData.registered_office_address) {
        const address = businessData.registered_office_address;
        const addressLines = [
          address.premises,
          address.address_line_1,
          address.address_line_2,
          address.locality,
          address.postal_code,
          'United Kingdom'
        ].filter(line => line && line.trim());
        
        addressLines.forEach(line => {
          doc.text(line, margin, yPosition);
          yPosition += 16;
        });
      } else {
        doc.text('Address not available', margin, yPosition);
        yPosition += 16;
      }
      
      yPosition += 15;
      
      // Accounts/Financial Information
      if (entityType === 'business' && businessData.accounts) {
        doc.setFontSize(14);
        doc.setTextColor(0, 60, 113);
        doc.setFont('helvetica', 'bold');
        doc.text('Accounts Information', margin, yPosition);
        
        yPosition += 5;
        doc.setDrawColor(221, 221, 221);
        doc.line(margin, yPosition, pageWidth - margin, yPosition);
        
        yPosition += 15;
        
        doc.setFontSize(11);
        doc.setTextColor(51, 51, 51);
        
        const accountsInfo = [
          ['Last Accounts Date:', businessData.accounts?.last_accounts?.made_up_to || 'N/A'],
          ['Next Accounts Due:', businessData.accounts?.next_due || businessData.accounts?.next_made_up_to || 'N/A'],
          ['Filing Status:', businessData.accounts?.overdue ? 'Overdue' : 'Up to date']
        ];
        
        accountsInfo.forEach(([label, value]) => {
          doc.setFont('helvetica', 'bold');
          doc.text(label, labelX, yPosition);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(85, 85, 85);
          doc.text(String(value), valueX, yPosition);
          doc.setTextColor(51, 51, 51);
          yPosition += 18;
        });
        
        yPosition += 10;
      } else if (entityType === 'charity') {
        doc.setFontSize(14);
        doc.setTextColor(0, 60, 113);
        doc.setFont('helvetica', 'bold');
        doc.text('Financial Information', margin, yPosition);
        
        yPosition += 5;
        doc.setDrawColor(221, 221, 221);
        doc.line(margin, yPosition, pageWidth - margin, yPosition);
        
        yPosition += 15;
        
        doc.setFontSize(11);
        doc.setTextColor(51, 51, 51);
        
        const financialInfo = [
          ['Latest Income:', businessData.charity_income ? `£${businessData.charity_income.toLocaleString()}` : 'N/A'],
          ['Latest Expenditure:', businessData.charity_expenditure ? `£${businessData.charity_expenditure.toLocaleString()}` : 'N/A']
        ];
        
        financialInfo.forEach(([label, value]) => {
          doc.setFont('helvetica', 'bold');
          doc.text(label, labelX, yPosition);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(85, 85, 85);
          doc.text(String(value), valueX, yPosition);
          doc.setTextColor(51, 51, 51);
          yPosition += 18;
        });
        
        yPosition += 10;
      }
      
      // People Table (Officers, Directors, PSCs, Trustees)
      doc.setFontSize(14);
      doc.setTextColor(0, 60, 113);
      doc.setFont('helvetica', 'bold');
      const peopleTitle = entityType === 'charity' 
        ? 'Trustees & Directors' 
        : 'Officers, Directors & Persons with Significant Control';
      doc.text(peopleTitle, margin, yPosition);
      
      yPosition += 5;
      doc.setDrawColor(221, 221, 221);
      doc.line(margin, yPosition, pageWidth - margin, yPosition);
      
      yPosition += 10;
      
      // Build people data for table
      const peopleMap = new Map();
      
      // Extract Officers, Directors, and Trustees
      if (businessData.officers && businessData.officers.length > 0) {
        businessData.officers.forEach(officer => {
          const normalizedName = normalizeName(officer.name);
          const existing = peopleMap.get(normalizedName);
          
          let roleType;
          if (officer.officer_role === 'director') roleType = 'Director';
          else if (officer.officer_role === 'trustee') roleType = 'Trustee';
          else roleType = 'Officer';
          
          const appointedDate = officer.appointed_on ? formatDate(officer.appointed_on) : '—';
          
          if (existing) {
            if (!existing.roles.includes(roleType)) {
              existing.roles.push(roleType);
            }
          } else {
            peopleMap.set(normalizedName, {
              name: officer.name,
              roles: [roleType],
              share: null,
              appointed: appointedDate
            });
          }
        });
      }
      
      // Extract PSCs
      if (businessData.pscs && businessData.pscs.length > 0) {
        businessData.pscs.forEach(psc => {
          const normalizedName = normalizeName(psc.name);
          const existing = peopleMap.get(normalizedName);
          
          let shareInfo = '—';
          if (psc.natures_of_control && psc.natures_of_control.length > 0) {
            const control = psc.natures_of_control[0];
            if (control.includes('25-to-50')) shareInfo = '25-50%';
            else if (control.includes('50-to-75')) shareInfo = '50-75%';
            else if (control.includes('75-to-100')) shareInfo = '75-100%';
            else if (control.includes('ownership-of-shares')) shareInfo = 'Significant';
          }
          
          if (existing) {
            if (!existing.roles.includes('PSC')) {
              existing.roles.push('PSC');
            }
            existing.share = shareInfo;
          } else {
            peopleMap.set(normalizedName, {
              name: psc.name,
              roles: ['PSC'],
              share: shareInfo,
              appointed: '—'
            });
          }
        });
      }
      
      const allPeople = Array.from(peopleMap.values());
      
      // Helper function for normalizeName (same as populatePeopleCards)
      function normalizeName(name) {
        if (!name) return '';
        return name
          .toLowerCase()
          .replace(/^(mr|mrs|ms|miss|dr|rev|sir|lord|dame|prof|professor)\s+/i, '')
          .replace(/[,\.]/g, '')
          .split(/\s+/)
          .filter(w => w)
          .sort()
          .join(' ')
          .trim();
      }
      
      // Helper function to format date
      function formatDate(dateString) {
        if (!dateString) return '—';
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        } catch {
          return dateString;
        }
      }
      
      // Create table data
      const tableData = allPeople.map(person => [
        person.name,
        person.roles.join(', '),
        person.share || '—',
        person.appointed
      ]);
      
      // Use autoTable plugin
      doc.autoTable({
        startY: yPosition,
        head: [['Name', 'Role(s)', 'Share', 'Appointed']],
        body: tableData,
        theme: 'striped',
        headStyles: {
          fillColor: [0, 60, 113],
          textColor: 255,
          fontSize: 11,
          fontStyle: 'bold'
        },
        bodyStyles: {
          fontSize: 11,
          textColor: [51, 51, 51]
        },
        alternateRowStyles: {
          fillColor: [248, 249, 250]
        },
        margin: { left: margin, right: margin }
      });
      
      yPosition = doc.lastAutoTable.finalY + 20;
      
      // Warning box
      doc.setFillColor(255, 243, 205);
      doc.setDrawColor(255, 193, 7);
      doc.roundedRect(margin, yPosition, pageWidth - (margin * 2), 50, 4, 4, 'FD');
      
      doc.setFontSize(11);
      doc.setTextColor(133, 100, 4);
      doc.setFont('helvetica', 'bold');
      doc.text('⚠️ AML & ID Verification Required', margin + 10, yPosition + 15);
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      const warningText = 'Ensure all directors and persons with significant control (> 25% share) have undergone';
      const warningText2 = 'appropriate Anti-Money Laundering checks and identity verification in accordance with MLR 2017.';
      doc.text(warningText, margin + 10, yPosition + 30);
      doc.text(warningText2, margin + 10, yPosition + 42);
      
      yPosition += 70;
      
      // Footer
      doc.setFontSize(10);
      doc.setTextColor(102, 102, 102);
      doc.setFont('helvetica', 'bold');
      doc.text('Generated:', margin, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(generatedDate, margin + 70, yPosition);
      
      doc.setFont('helvetica', 'bold');
      doc.text('Downloaded by:', pageWidth - margin - 200, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(userEmail, pageWidth - margin - 120, yPosition);
      
      yPosition += 15;
      
      // Data attribution
      doc.setFontSize(9);
      doc.setTextColor(153, 153, 153);
      doc.setFont('helvetica', 'italic');
      const dataSource = entityType === 'charity' ? 'Charity Commission' : 'Companies House';
      const disclaimer = `This summary is sourced from ${dataSource} public records and should be verified independently.`;
      doc.text(disclaimer, margin, yPosition);
      
      yPosition += 12;
      
      const attribution = entityType === 'charity'
        ? 'Contains information from the Charity Commission which is made available under the Open Government Licence v3.0.'
        : 'Contains information from Companies House which is made available under the Open Government Licence v3.0.';
      
      const splitAttribution = doc.splitTextToSize(attribution, pageWidth - (margin * 2));
      doc.text(splitAttribution, margin, yPosition);
      
      // Generate filename
      const entityNum = entityNumber?.value?.trim() || 'Unknown';
      const filename = `${entityType === 'charity' ? 'Charity' : 'Company'}_Summary_${entityNum}_${Date.now()}.pdf`;
      
      // Download
      doc.save(filename);
      console.log('📄 PDF downloaded:', filename);
    }
    
    // ===== FORM VALIDATION =====
    
    /*
    =====================================================================
    DATE PARSING - Parse various date formats into DDMMYYYY string
    - Supports: dd/mm/yyyy, dd-mm-yy, dd.mm.yyyy, dd Jan yyyy, January 11 2001, etc.
    - Used for paste functionality in DOB inputs
    - Returns: 8-character string in DDMMYYYY format, or null if invalid
    =====================================================================
    */
    function parseDateString(dateStr) {
      if (!dateStr) return null;
      
      const text = dateStr.trim().toLowerCase();
      
      // Month name mappings
      const months = {
        'jan': '01', 'january': '01',
        'feb': '02', 'february': '02',
        'mar': '03', 'march': '03',
        'apr': '04', 'april': '04',
        'may': '05',
        'jun': '06', 'june': '06',
        'jul': '07', 'july': '07',
        'aug': '08', 'august': '08',
        'sep': '09', 'sept': '09', 'september': '09',
        'oct': '10', 'october': '10',
        'nov': '11', 'november': '11',
        'dec': '12', 'december': '12'
      };
      
      let day = null, month = null, year = null;
      
      // Try pure 8-digit format first (DDMMYYYY like "22022003")
      const pureDigits = text.replace(/[^0-9]/g, '');
      if (pureDigits.length === 8) {
        day = pureDigits.substring(0, 2);
        month = pureDigits.substring(2, 4);
        year = pureDigits.substring(4, 8);
      }
      
      // Try numeric format with separators (dd/mm/yyyy, dd-mm-yy, dd.mm.yyyy)
      if (!day) {
        const numericMatch = text.match(/(\d{1,2})[\s\-\/.]+(\d{1,2})[\s\-\/.]+(\d{2,4})/);
        if (numericMatch) {
          day = numericMatch[1].padStart(2, '0');
          month = numericMatch[2].padStart(2, '0');
          year = numericMatch[3];
        }
      }
      
      // Try text month formats (11 Jan 2001, January 11th 2001, Jan 11 01)
      if (!day) {
        // Day first: "11 January 2001", "11th Jan 01"
        const dayFirstMatch = text.match(/(\d{1,2})(?:st|nd|rd|th)?\s+([a-z]+)\s+(\d{2,4})/);
        if (dayFirstMatch) {
          day = dayFirstMatch[1].padStart(2, '0');
          const monthName = dayFirstMatch[2];
          month = months[monthName] || months[monthName.substring(0, 3)];
          year = dayFirstMatch[3];
        }
      }
      
      // Try month first: "January 11 2001", "Jan 11th 01"
      if (!day) {
        const monthFirstMatch = text.match(/([a-z]+)\s+(\d{1,2})(?:st|nd|rd|th)?\s+(\d{2,4})/);
        if (monthFirstMatch) {
          const monthName = monthFirstMatch[1];
          month = months[monthName] || months[monthName.substring(0, 3)];
          day = monthFirstMatch[2].padStart(2, '0');
          year = monthFirstMatch[3];
        }
      }
      
      // Validate and normalize
      if (!day || !month || !year) return null;
      
      // Convert 2-digit year to 4-digit (assume 1900s for 00-99)
      if (year.length === 2) {
        const yearNum = parseInt(year, 10);
        year = yearNum >= 0 && yearNum <= 30 ? '20' + year : '19' + year;
      }
      
      // Validate ranges
      const dayNum = parseInt(day, 10);
      const monthNum = parseInt(month, 10);
      const yearNum = parseInt(year, 10);
      
      if (dayNum < 1 || dayNum > 31) return null;
      if (monthNum < 1 || monthNum > 12) return null;
      if (yearNum < 1900 || yearNum > 2100) return null;
      
      // Return as DDMMYYYY string
      return day + month + year;
    }
    
    function validateDOB() {
      try {
        const dobString = dobInputs.map(inp => inp?.value || '').join('');
        if (dobString.length !== 8) return false;
        const formatted = `${dobString.substring(0,2)}-${dobString.substring(2,4)}-${dobString.substring(4)}`;
        const [dd, mm, yyyy] = formatted.split('-').map(Number);
        if (!dd || !mm || !yyyy) return false;
        const d = new Date(yyyy, mm - 1, dd);
        return d && d.getMonth() === (mm - 1) && d.getDate() === dd && d.getFullYear() === yyyy;
      } catch (error) {
        console.error('DOB validation error:', error);
        return false;
      }
    }
    
    // Phone validation using Google libphonenumber
    function validatePhoneNumber() {
      try {
        // Check if phone number is provided
        if (!phoneNumber?.value?.trim()) {
          return { isValid: true, error: null }; // Phone is optional, so empty is valid
        }
        
        // Check if libphonenumber library is loaded
        if (typeof libphonenumber === 'undefined' || !libphonenumber.PhoneNumberUtil) {
          console.warn('libphonenumber library not loaded yet, skipping validation');
          // Return valid for now - validation will occur on save when library is loaded
          return { isValid: true, error: null };
        }
        
        const countryCode = phoneCountryCode?.dataset.phoneCode || '+44';
        const phoneNum = phoneNumber.value.trim();
        
        // Combine country code with phone number
        const fullPhoneNumber = countryCode + phoneNum.replace(/^0+/, '');
        
        // Use libphonenumber to validate
        const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();
        const number = phoneUtil.parseAndKeepRawInput(fullPhoneNumber, null);
        
        // Check if the number is valid
        const isValid = phoneUtil.isValidNumber(number);
        
        if (!isValid) {
          return {
            isValid: false,
            error: 'Please enter a valid phone number.'
          };
        }
        
        // Format as E164 using integer 0 (CDN doesn't expose enum)
        // PhoneNumberFormat values: 0 = E164, 1 = INTERNATIONAL, 2 = NATIONAL, 3 = RFC3966
        return { isValid: true, error: null, formattedNumber: phoneUtil.format(number, 0) };
        
      } catch (error) {
        console.error('Phone validation error:', error);
        return {
          isValid: false,
          error: 'Please enter a valid mobile phone number.'
        };
      }
    }
    
    // Helper function to format an existing phone number string to E.164 format
    function formatExistingPhoneNumber(phoneString) {
      try {
        if (!phoneString || !phoneString.trim()) {
          return null;
        }
        
        // Check if libphonenumber library is loaded
        if (typeof libphonenumber === 'undefined' || !libphonenumber.PhoneNumberUtil) {
          console.warn('libphonenumber library not loaded yet, falling back to original logic');
          return null;
        }
        
        const cleanPhone = phoneString.trim();
        
        // Try to parse as international number first
        if (cleanPhone.startsWith('+')) {
          const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();
          const number = phoneUtil.parseAndKeepRawInput(cleanPhone, null);
          
          if (phoneUtil.isValidNumber(number)) {
            // Use integer 0 for E164 format (CDN doesn't expose enum)
            return phoneUtil.format(number, 0);
          }
        }
        
        // Try common country codes
        const commonCodes = ['+44', '+1', '+33', '+49', '+39', '+34', '+61', '+86', '+91', '+81'];
        for (const code of commonCodes) {
          try {
            const fullNumber = code + cleanPhone.replace(/^0+/, '');
            const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();
            const number = phoneUtil.parseAndKeepRawInput(fullNumber, null);
            
            if (phoneUtil.isValidNumber(number)) {
              // Use integer 0 for E164 format
              return phoneUtil.format(number, 0);
            }
          } catch (error) {
            // Try next code
            continue;
          }
        }
        
        // If all else fails, return null (will be handled by original logic)
        return null;
        
      } catch (error) {
        console.error('Error formatting existing phone number:', error);
        return null;
      }
    }
    
    function validateForm() {
      const errors = [];
      
      try {
        if (!isEntityMode) {
          // Individual mode validation
          
          // DOB is NOT required, but if partially filled or invalid, throw error
          const dobDigits = dobInputs.map(inp => inp?.value || '').join('');
          if (dobDigits.length > 0 && dobDigits.length < 8) {
            errors.push('Please complete all 8 digits of the date of birth, or leave it blank.');
          } else if (dobDigits.length === 8 && !validateDOB()) {
            errors.push('The date of birth you have entered is not valid. Please use the format DD-MM-YYYY.');
          }
          
          // Name change fields only required if toggle is on
          if (recentNameChange?.checked) {
            if (!previousName?.value?.trim()) errors.push('Please enter previous/known as name.');
            if (!reasonForNameChange?.value?.trim()) errors.push('Please enter reason for name change.');
          }
        }
        
        // Phone validation - optional but must be valid if provided
        const phoneValidation = validatePhoneNumber();
        if (!phoneValidation.isValid) {
          errors.push(phoneValidation.error);
        }
      
      // Current address is NOT required
      // Manual address fields only required if "Address not listed" is checked
      if (addressNotListed?.checked) {
        const isCurrentUK = currentCountry?.dataset.countryCode === 'GBR';
        
        if (!town?.value?.trim()) {
          errors.push('You have indicated current address not listed, please enter the Town/City.');
        }
        if (!postcode?.value?.trim()) {
          errors.push('You have indicated current address not listed, please enter the Postcode.');
        }
        // Per Thirdfort API: Must have ONE OF flat_number, building_number, or building_name
        if (!flatNumber?.value?.trim() && !buildingNumber?.value?.trim() && !buildingName?.value?.trim()) {
          errors.push('You have indicated current address not listed, please enter at least one of: Flat Number, Building Number, or Building Name.');
        }
      }
        
        // Previous address validation - only if recent move toggle is on
        if (recentMove?.checked) {
          const isPreviousUK = previousCountry?.dataset.countryCode === 'GBR';
          
          // Previous address autocomplete only required if UK and "not listed" is NOT checked
          if (isPreviousUK && !previousAddressNotListed?.checked) {
            if (!previousAddress?.value?.trim()) {
              errors.push('You have indicated a recent move, please enter the previous address or check "Address not listed" to enter manually.');
            }
          }
          
          // Previous address manual fields only required if "not listed" is checked
          if (previousAddressNotListed?.checked) {
            if (!prevTown?.value?.trim()) {
              errors.push('You have indicated previous address not listed, please enter the Town/City.');
            }
            if (!prevPostcode?.value?.trim()) {
              errors.push('You have indicated previous address not listed, please enter the Postcode.');
            }
            // Must have ONE OF flat_number, building_number, or building_name
            if (!prevFlatNumber?.value?.trim() && !prevBuildingNumber?.value?.trim() && !prevBuildingName?.value?.trim()) {
              errors.push('You have indicated previous address not listed, please enter at least one of: Flat Number, Building Number, or Building Name.');
            }
          }
        }
      } catch (error) {
        console.error('Validation error:', error);
        errors.push('An error occurred during validation.');
      }
      
      return errors;
    }
    
    // ===== DATA COMPILATION =====
    
    function compileFormData() {
      try {
      // Build current address object
      const isCurrentUK = currentCountry.dataset.countryCode === 'GBR';
      
      if (!isCurrentUK || addressNotListed?.checked) {
        // Build from manual fields
        if (isCurrentUK) {
          // UK manual: Individual fields only (no address_1/address_2)
          currentAddressObject = {
            building_name: buildingName?.value?.trim() || '',
            building_number: buildingNumber?.value?.trim() || '',
            flat_number: flatNumber?.value?.trim() || '',
            postcode: postcode?.value?.trim() || '',
            street: street?.value?.trim() || '',
            sub_street: subStreet?.value?.trim() || '',
            town: town?.value?.trim() || '',
            country: 'GBR'
          };
        } else {
          // Non-UK: address_1, address_2 (no individual building fields)
          currentAddressObject = {
            address_1: buildingName?.value?.trim() || buildingNumber?.value?.trim() || flatNumber?.value?.trim() || street?.value?.trim() || '',
            address_2: subStreet?.value?.trim() || '',
            postcode: postcode?.value?.trim() || '',
            street: street?.value?.trim() || '',
            sub_street: subStreet?.value?.trim() || '',
            town: town?.value?.trim() || '',
            state: '',
            country: currentCountry?.dataset.countryCode || 'GBR'
          };
        }
      } else if (!currentAddressObject && currentAddress?.value?.trim()) {
        // Parse from autocomplete text if no object stored
        currentAddressObject = parseManualAddress(currentAddress.value, currentCountry.dataset.countryCode || 'GBR');
      }
      
      // Ensure country is set even if object was from API
      if (currentAddressObject) {
        currentAddressObject.country = currentCountry.dataset.countryCode || 'GBR';
      }
      
      // Build previous address object
      if (recentMove?.checked) {
        const isPreviousUK = previousCountry?.dataset.countryCode === 'GBR';
        
        if (!isPreviousUK || previousAddressNotListed?.checked) {
          // Build from manual fields
          if (isPreviousUK) {
            // UK manual: Individual fields only (no address_1/address_2)
            previousAddressObject = {
              building_name: prevBuildingName?.value?.trim() || '',
              building_number: prevBuildingNumber?.value?.trim() || '',
              flat_number: prevFlatNumber?.value?.trim() || '',
              postcode: prevPostcode?.value?.trim() || '',
              street: prevStreet?.value?.trim() || '',
              sub_street: prevSubStreet?.value?.trim() || '',
              town: prevTown?.value?.trim() || '',
              country: 'GBR'
            };
          } else {
            // Non-UK: address_1, address_2 (no individual building fields)
            previousAddressObject = {
              address_1: prevBuildingName?.value?.trim() || prevBuildingNumber?.value?.trim() || prevFlatNumber?.value?.trim() || prevStreet?.value?.trim() || '',
              address_2: prevSubStreet?.value?.trim() || '',
              postcode: prevPostcode?.value?.trim() || '',
              street: prevStreet?.value?.trim() || '',
              sub_street: prevSubStreet?.value?.trim() || '',
            town: prevTown?.value?.trim() || '',
            state: '',
            country: previousCountry?.dataset.countryCode || 'GBR'
            };
          }
        } else if (!previousAddressObject && previousAddress?.value?.trim()) {
          // Parse from autocomplete text if no object stored
          previousAddressObject = parseManualAddress(previousAddress.value, previousCountry?.dataset.countryCode || 'GBR');
        }
      }
      
      // Format phone number in E.164 international format using validated number
      let formattedPhone = undefined;
      if (phoneNumber?.value?.trim()) {
        const phoneValidation = validatePhoneNumber();
        if (phoneValidation.isValid && phoneValidation.formattedNumber) {
          formattedPhone = phoneValidation.formattedNumber;
        } else {
          // If validation fails, don't send the phone number (shouldn't happen due to validation checks)
          console.warn('Phone validation failed during data compilation, excluding phone from response');
          formattedPhone = undefined;
        }
      }
      
      // Compile DOB from individual inputs (only for individual mode)
      let dobFormatted = undefined;
      if (!isEntityMode) {
        const dobDigits = dobInputs.map(inp => inp?.value || '').join('');
        if (dobDigits.length === 8) {
          // Format as dd-mm-yyyy (e.g., '01-01-2000')
          dobFormatted = `${dobDigits.substring(0,2)}-${dobDigits.substring(2,4)}-${dobDigits.substring(4)}`;
        }
      }
      
      // Build business data object
      let businessDataObject = undefined;
      if (isEntityMode) {
        if (businessData) {
          // Full API data (directors, officers, PSCs, registered office)
          businessDataObject = businessData;
        } else if (businessName?.value?.trim() || entityNumber?.value?.trim()) {
          // Manual entry without API link - return basic info
          businessDataObject = {
            company_name: businessName?.value?.trim() || undefined,
            company_number: entityNumber?.value?.trim() || undefined,
            registration_country: registrationCountry?.dataset.jurisdictionCode || undefined
          };
        }
      }
      
      // Return data in same format as received (short keys)
      const compiled = {
        _id: formData._id || undefined,
        n: isEntityMode ? {
          b: businessName?.value?.trim() || undefined  // businessName
        } : {
          t: titlePrefix?.value || undefined,          // titlePrefix
          f: firstName?.value || undefined,            // firstName
          m: middleName?.value || undefined,           // middleNames
          l: lastName?.value || undefined              // lastName
        },
        b: dobFormatted || undefined,                        // birthdate (dd-mm-yyyy)
        a: currentAddressObject || undefined,                // address object (undefined if cleared/empty)
        pA: previousAddressObject || undefined,              // previousAddress object (undefined if cleared/empty)
        rM: recentMove?.checked || false,                    // clientRecentHomeMove
        nC: recentNameChange?.checked || false,              // clientRecentNameChange
        pN: previousName?.value || undefined,                // previousName
        rNC: reasonForNameChange?.value || undefined,        // reasonForNameChange
        m: formattedPhone || undefined,                      // mobileNumber
        e: email?.value?.trim() || undefined,                // email
        eN: entityNumber?.value?.trim() || undefined,        // entityNumber (company number OR charity number)
        rC: registrationCountry?.dataset.jurisdictionCode || undefined,  // registrationCountry
        eT: isEntityMode ? entityType : undefined,           // entityType ('business' or 'charity')
        bD: businessDataObject                               // businessData (full API data OR basic manual entry, includes organisation_number for charities)
      };
      
      return compiled;
      } catch (error) {
        console.error('Error compiling form data:', error);
        return null;
      }
    }
    
    // ===== EVENT LISTENERS =====
    
    // Registration country change - clear autocomplete when switching from UK
    registrationCountry.addEventListener('change', () => {
      const jurisdictionCode = registrationCountry.dataset.jurisdictionCode || 'GB';
      const isUK = jurisdictionCode === 'GB';
      
      if (!isUK) {
        // Hide dropdowns and clear company data for non-UK
        businessNameDropdown.classList.add('hidden');
        entityNumberDropdown.classList.add('hidden');
        businessData = null;
        updateCompanyButtons();
        console.log('⚠️ Company search only available for UK companies');
      }
    });
    
    // Country change handlers are now in the autocomplete initialization section below
    
    // Toggle name change fields
    recentNameChange.addEventListener('change', () => {
      if (recentNameChange.checked) {
        nameChangeFields.classList.remove('hidden');
        previousName.setAttribute('required', 'true');
        reasonForNameChange.setAttribute('required', 'true');
      } else {
        nameChangeFields.classList.add('hidden');
        previousName.removeAttribute('required');
        reasonForNameChange.removeAttribute('required');
      }
    });
    
    // Toggle manual address fields for current address
    addressNotListed.addEventListener('change', () => {
      if (addressNotListed.checked) {
        // Show manual fields, hide autocomplete
        manualAddressFields.classList.remove('hidden');
        currentAddress.classList.add('hidden');
        currentAddressLabel.classList.add('hidden');
        currentAddress.removeAttribute('required');
        
        // Set required on manual fields
        town.setAttribute('required', 'true');
        postcode.setAttribute('required', 'true');
      } else {
        // Hide manual fields, show autocomplete
        manualAddressFields.classList.add('hidden');
        currentAddress.classList.remove('hidden');
        currentAddressLabel.classList.remove('hidden');
        currentAddress.setAttribute('required', 'true');
        
        // Remove required from manual fields
        town.removeAttribute('required');
        postcode.removeAttribute('required');
        
        // Clear manual fields
        flatNumber.value = '';
        buildingNumber.value = '';
        buildingName.value = '';
        street.value = '';
        subStreet.value = '';
        town.value = '';
        postcode.value = '';
      }
    });
    
    // Toggle manual address fields for previous address
    previousAddressNotListed.addEventListener('change', () => {
      if (previousAddressNotListed.checked) {
        // Show manual fields, hide autocomplete
        manualPreviousAddressFields.classList.remove('hidden');
        previousAddress.classList.add('hidden');
        previousAddressLabel.classList.add('hidden');
        previousAddress.removeAttribute('required');
        
        // Set required on manual fields
        prevTown.setAttribute('required', 'true');
        prevPostcode.setAttribute('required', 'true');
      } else {
        // Hide manual fields, show autocomplete
        manualPreviousAddressFields.classList.add('hidden');
        previousAddress.classList.remove('hidden');
        previousAddressLabel.classList.remove('hidden');
        if (recentMove.checked) {
          previousAddress.setAttribute('required', 'true');
        }
        
        // Remove required from manual fields
        prevTown.removeAttribute('required');
        prevPostcode.removeAttribute('required');
        
        // Clear manual fields
        prevFlatNumber.value = '';
        prevBuildingNumber.value = '';
        prevBuildingName.value = '';
        prevStreet.value = '';
        prevSubStreet.value = '';
        prevTown.value = '';
        prevPostcode.value = '';
      }
    });
    
    // Toggle previous address fields
    recentMove.addEventListener('change', () => {
      if (recentMove.checked) {
        previousAddressFields.classList.remove('hidden');
        if (!previousAddressNotListed.checked) {
          previousAddress.setAttribute('required', 'true');
        } else {
          prevTown.setAttribute('required', 'true');
          prevPostcode.setAttribute('required', 'true');
        }
      } else {
        previousAddressFields.classList.add('hidden');
        previousAddress.removeAttribute('required');
        prevTown.removeAttribute('required');
        prevPostcode.removeAttribute('required');
      }
    });
    
    // DOB auto-tab
    // DOB: Auto-tab between 8 digit inputs with smart navigation and paste support
    dobInputs.forEach((input, idx) => {
      // Handle keyboard navigation
      input.addEventListener('keydown', function(e) {
        // Ignore keyboard shortcuts (Ctrl+V, Ctrl+C, Cmd+V, etc.)
        if (e.ctrlKey || e.metaKey) {
          return;
        }
        
        if (e.key === 'Backspace' && !this.value && idx > 0) {
          // Move to previous input on backspace when current is empty
          dobInputs[idx - 1].focus();
        } else if (this.value.length === 1 && idx < dobInputs.length - 1) {
          // Move to next input when current is filled
          dobInputs[idx + 1].focus();
        }
      });
      
      // Handle only numeric input
      input.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        // Auto-advance when digit entered
        if (this.value.length === 1 && idx < dobInputs.length - 1) {
          dobInputs[idx + 1].focus();
        }
      });
    });
    
    // Handle paste in first DOB field with robust date parsing
    if (dobInputs[0]) {
      dobInputs[0].addEventListener('paste', function(e) {
        e.preventDefault();
        
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        console.log('📝 Pasted DOB text:', pastedText);
        
        // Try to parse the date
        const parsedDate = parseDateString(pastedText);
        
        if (parsedDate) {
          // Fill all 8 DOB inputs with DDMMYYYY format
          dobInputs.forEach((input, index) => {
            if (input) {
              input.value = parsedDate[index];
            }
          });
          
          dobInputs[7].focus();
          const formattedDate = `${parsedDate.substring(0,2)}/${parsedDate.substring(2,4)}/${parsedDate.substring(4,8)}`;
          console.log('… Pasted DOB filled all fields:', parsedDate, '→', formattedDate);
        } else {
          console.warn('⚠️ Could not parse date from pasted text:', pastedText);
        }
      });
    }
    
    // ===== MESSAGE LISTENER =====
    
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'entity-true') {
        const type = event.data.entityType || 'business'; // 'business' or 'charity'
        switchToEntityMode(type);
      } else if (event.data && event.data.type === 'entity-false') {
        switchToIndividualMode();
      } else if (event.data && event.data.type === 'allowEdits-true') {
        setEditMode(true);
      } else if (event.data && event.data.type === 'allowEdits-false') {
        setEditMode(false);
      } else if (event.data && event.data.type === 'client-data') {
        console.log('📥 Received client-data:', event.data);
        
        // Handle entity flag from message
        if (event.data.entity === true) {
          const type = event.data.entityType || 'business'; // 'business' or 'charity'
          switchToEntityMode(type);
        } else {
          switchToIndividualMode();
        }
        
        // Handle allowEdits flag from message
        if (event.data.allowEdits === false) {
          setEditMode(false);
        } else {
          setEditMode(true);
        }
        
        // Load client data (ensure it's an object)
        const clientData = event.data.clientData;
        if (clientData && typeof clientData === 'object') {
          loadData(clientData);
        } else {
          console.warn('No valid clientData provided, loading empty form');
          loadData({});
        }
      } else if (event.data && event.data.type === 'request-data') {
        // Parent is requesting the form data (triggered by Wix save button)
        hideError();
        
        const errors = validateForm();
        if (errors.length) {
          // Send validation error to parent (don't show error popup in iframe)
          console.log('⚠️ Validation errors:', errors);
          window.parent.postMessage({
            type: 'validation-error',
            errors: errors
          }, '*');
          return;
        }
        
        // Additional phone validation before sending data
        const phoneValidation = validatePhoneNumber();
        if (!phoneValidation.isValid) {
          console.log('⚠️ Phone validation failed before sending data:', phoneValidation.error);
          window.parent.postMessage({
            type: 'validation-error',
            errors: [phoneValidation.error]
          }, '*');
          return;
        }
        
        const data = compileFormData();
        
        // Check if data compilation failed
        if (!data) {
          console.error('⚠️ Data compilation failed');
          window.parent.postMessage({
            type: 'validation-error',
            errors: ['Data compilation error']
          }, '*');
          return;
        }
        
        // Send to parent (DOB will be in 'dd-mm-yyyy' format)
        console.log('📤 Sending new-data to parent:', data);
        window.parent.postMessage({
          type: 'new-data',
          data: data
        }, '*');
        
        // Reset unsaved changes flag after successful save
        hasUnsavedChanges = false;
      } else if (event.data && event.data.type === 'address-results') {
        // Cache the autocomplete results
        if (event.data.searchTerm && event.data.suggestions) {
          const cacheKey = 'auto_' + event.data.searchTerm.toLowerCase();
          setCachedItem(cacheKey, event.data.suggestions, 'autocomplete');
          console.log('💾 Cached autocomplete results for:', event.data.searchTerm);
        }
        
        displayAddressSuggestions(event.data.suggestions, event.data.field);
      } else if (event.data && event.data.type === 'address-data') {
        // Cache the full address object
        if (event.data.addressId && event.data.address) {
          const cacheKey = 'addr_' + event.data.addressId;
          setCachedItem(cacheKey, event.data.address, 'address');
          console.log('💾 Cached full address for ID:', event.data.addressId);
        }
        
        handleAddressData(event.data.address, event.data.field);
      } else if (event.data && (event.data.type === 'company-results' || event.data.type === 'charity-results')) {
        // Display company/charity search results
        displayCompanySuggestions(event.data.companies, event.data.searchBy);
      } else if (event.data && (event.data.type === 'company-data' || event.data.type === 'charity-data')) {
        // Store full company/charity data (directors/trustees, officers, PSCs, etc.)
        handleCompanyData(event.data.companyData || event.data.charityData);
      } else if (event.data && event.data.type === 'sanctions-check') {
        // Format client data and send back to parent for sanctions lightbox
        console.log('📋 Formatting client data for sanctions check...');
        
        // Compile client name
        let clientName = '';
        if (isEntityMode) {
          // Entity mode: Use business name
          clientName = businessName?.value?.trim() || '';
        } else {
          // Individual mode: Combine first, middle, last name
          const nameParts = [
            firstName?.value?.trim(),
            middleName?.value?.trim(),
            lastName?.value?.trim()
          ].filter(p => p);
          clientName = nameParts.join(' ');
        }
        
        // Extract year of birth from DOB inputs (individual mode only)
        let yearOfBirth = '';
        if (!isEntityMode && dobInputs.length === 8) {
          const dobDigits = dobInputs.map(inp => inp?.value || '').join('');
          if (dobDigits.length === 8) {
            // Extract year (last 4 digits: DDMMYYYY)
            yearOfBirth = dobDigits.substring(4, 8);
          }
        }
        
        // Determine search type
        const searchType = isEntityMode ? 'entity' : 'individual';
        
        // Send back to parent
        const sanctionsData = {
          type: 'sanctions-information',
          clientData: {
            clientName: clientName,
            yearOfBirth: yearOfBirth,
            searchType: searchType
          }
        };
        
        console.log('📤 Sending sanctions data to parent:', sanctionsData);
        window.parent.postMessage(sanctionsData, '*');
      }
    });
    
    // ===== LOAD DATA =====
    
    function loadData(data) {
      // Set loading flag to prevent change detection during data load
      isLoadingData = true;
      hasUnsavedChanges = false;
      
      formData = data || {};
      
      // Clear address objects and company data on new data load
      currentAddressObject = null;
      previousAddressObject = null;
      businessData = null;
      
      // Note: Entity mode is set by the message handler based on event.data.entity flag
      
      // Clear timers
      if (addressDebounceTimer) clearTimeout(addressDebounceTimer);
      if (previousAddressDebounceTimer) clearTimeout(previousAddressDebounceTimer);
      if (companyNameDebounceTimer) clearTimeout(companyNameDebounceTimer);
      if (companyNumberDebounceTimer) clearTimeout(companyNumberDebounceTimer);
      addressDebounceTimer = null;
      previousAddressDebounceTimer = null;
      companyNameDebounceTimer = null;
      companyNumberDebounceTimer = null;
      
      // Reset ALL form fields and UI state before loading new data
      // This ensures a clean slate regardless of previous state
      
      // Reset toggles and checkboxes
      addressNotListed.checked = false;
      previousAddressNotListed.checked = false;
      recentNameChange.checked = false;
      recentMove.checked = false;
      
      // Reset visibility - hide all conditional sections initially
      manualAddressFields.classList.add('hidden');
      manualPreviousAddressFields.classList.add('hidden');
      nameChangeFields.classList.add('hidden');
      previousAddressFields.classList.add('hidden');
      
      // Show autocomplete inputs by default (will be hidden later if needed)
      currentAddress.classList.remove('hidden');
      currentAddressLabel.classList.remove('hidden');
      previousAddress.classList.remove('hidden');
      previousAddressLabel.classList.remove('hidden');
      
      // Clear ALL input fields
      titlePrefix.value = '';
      firstName.value = '';
      middleName.value = '';
      lastName.value = '';
      businessName.value = '';
      entityNumber.value = '';
      email.value = '';
      previousName.value = '';
      reasonForNameChange.value = '';
      currentAddress.value = '';
      previousAddress.value = '';
      dobInputs.forEach(inp => inp.value = '');
      
      // Clear current address manual fields
      flatNumber.value = '';
      buildingNumber.value = '';
      buildingName.value = '';
      street.value = '';
      subStreet.value = '';
      town.value = '';
      postcode.value = '';
      
      // Clear previous address manual fields
      prevFlatNumber.value = '';
      prevBuildingNumber.value = '';
      prevBuildingName.value = '';
      prevStreet.value = '';
      prevSubStreet.value = '';
      prevTown.value = '';
      prevPostcode.value = '';
      
      // Reset country dropdowns to UK
      setCountry('currentCountry', 'GBR');
      setCountry('previousCountry', 'GBR');
      
      // Populate entity or individual fields
      if (isEntityMode) {
        // Entity type already set by switchToEntityMode() before loadData() is called
        // Only use formData.eT if entityType wasn't explicitly set
        if (formData.eT && formData.eT !== entityType) {
          console.log(`ℹ️ Preserving entityType from message: '${entityType}' (formData has: '${formData.eT}')`);
        }
        
        setJurisdiction('registrationCountry', formData.rC || 'GB');
        businessName.value = formData.n?.b || '';
        entityNumber.value = formData.eN || '';
        businessData = formData.bD || null;
        
        // For charities, extract organisation_number from businessData (used only for URLs, not saved to DB)
        if (entityType === 'charity' && businessData?.organisation_number) {
          entityNumber.dataset.organisationNumber = businessData.organisation_number;
          console.log(`🏷️ Extracted organisation_number from businessData for URLs: ${businessData.organisation_number}`);
        } else {
          entityNumber.dataset.organisationNumber = '';
        }
        
        // Update labels based on entity type
        updateEntityLabels();
        
        if (businessData) {
          console.log(`… Loaded ${entityType} data:`, businessData);
        }
        
        // Update button visibility
        updateCompanyButtons();
      } else {
        titlePrefix.value = formData.n?.t || '';
        firstName.value = formData.n?.f || '';
        middleName.value = formData.n?.m || '';
        lastName.value = formData.n?.l || '';
      }
      
      // Parse phone number using libphonenumber for proper formatting
      if (formData.m && typeof formData.m === 'string') {
        const cleanPhone = formData.m.trim();
        
        // First, try to format using libphonenumber to get proper E.164 format
        const formattedPhone = formatExistingPhoneNumber(cleanPhone);
        
        if (formattedPhone) {
          // Successfully formatted - extract country code and number for form fields
          try {
            const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();
            const number = phoneUtil.parseAndKeepRawInput(formattedPhone, null);
            const countryCode = '+' + number.getCountryCode();
            
            // Extract national number more reliably
            const nationalNumberString = number.getNationalNumber().toString();
            const nationalNumber = nationalNumberString.replace(/^0+/, ''); // Remove leading zeros
            
            setPhoneCode('phoneCountryCode', countryCode);
            phoneNumber.value = nationalNumber;
            console.log(`📞 Formatted phone using libphonenumber: ${cleanPhone} → ${formattedPhone} (${countryCode} + ${nationalNumber})`);
          } catch (error) {
            console.warn('Error parsing formatted phone number:', error);
            // Fall back to original logic
            setPhoneCode('phoneCountryCode', '+44');
            phoneNumber.value = cleanPhone;
          }
        } else {
          // Couldn't format with libphonenumber - use original logic
          console.log('📞 Could not format phone with libphonenumber, using original logic for:', cleanPhone);
          
          // Check if it already has international format (starts with +)
          if (cleanPhone.startsWith('+')) {
            // Try to match against known country codes (longest first to avoid +1 matching +1X)
            const knownCodes = ['+993', '+992', '+971', '+967', '+966', '+960', '+886', '+880', '+856', '+853', '+852', '+973', '+998', '+996', '+995', '+977', '+968', '+964', '+963', '+962', '+961', '+974', '+594', '+593', '+598', '+595', '+591', '+590', '+507', '+506', '+505', '+504', '+503', '+502', '+501', '+389', '+387', '+386', '+385', '+381', '+380', '+376', '+375', '+374', '+373', '+372', '+371', '+370', '+359', '+358', '+357', '+356', '+355', '+354', '+353', '+352', '+351', '+421', '+420', '+264', '+263', '+262', '+261', '+260', '+258', '+257', '+256', '+255', '+254', '+253', '+252', '+251', '+250', '+249', '+248', '+244', '+243', '+242', '+241', '+240', '+239', '+238', '+237', '+236', '+235', '+234', '+233', '+232', '+231', '+230', '+229', '+228', '+227', '+226', '+225', '+224', '+223', '+222', '+221', '+220', '+218', '+216', '+213', '+212', '+98', '+95', '+94', '+93', '+92', '+91', '+90', '+86', '+84', '+82', '+81', '+66', '+65', '+64', '+63', '+62', '+61', '+60', '+58', '+57', '+56', '+55', '+54', '+52', '+51', '+49', '+48', '+47', '+46', '+45', '+44', '+43', '+41', '+40', '+39', '+36', '+34', '+33', '+32', '+31', '+30', '+27', '+20', '+7', '+1'];
            
            let matched = false;
            for (const code of knownCodes) {
              if (cleanPhone.startsWith(code)) {
                setPhoneCode('phoneCountryCode', code);
                phoneNumber.value = cleanPhone.substring(code.length);
                console.log(`📞 Loaded international phone: ${code} + ${cleanPhone.substring(code.length)}`);
                matched = true;
                break;
              }
            }
            
            // If no known code matched, try generic pattern
            if (!matched) {
              const genericMatch = cleanPhone.match(/^(\+\d{1,4})(.+)$/);
              if (genericMatch) {
                setPhoneCode('phoneCountryCode', genericMatch[1]);
                phoneNumber.value = genericMatch[2];
                console.log(`📞 Loaded phone with unrecognized code: ${genericMatch[1]} + ${genericMatch[2]}`);
              }
            }
          } 
          // Check if it's UK mobile starting with 07, 08, or 09
          else if (cleanPhone.match(/^0[7-9]\d{9}$/)) {
            setPhoneCode('phoneCountryCode', '+44');
            phoneNumber.value = cleanPhone.substring(1); // Remove leading 0: 07700000000 → 7700000000
            console.log(`📞 Converted UK mobile ${cleanPhone} → +44${cleanPhone.substring(1)}`);
          }
          // Other UK format (starts with 0) - landlines or other
          else if (cleanPhone.startsWith('0')) {
            setPhoneCode('phoneCountryCode', '+44');
            phoneNumber.value = cleanPhone.substring(1); // Remove leading 0
            console.log(`📞 Converted UK number ${cleanPhone} → +44${cleanPhone.substring(1)}`);
          }
          // No recognized format, store as-is with default country code
          else {
            setPhoneCode('phoneCountryCode', '+44');
            phoneNumber.value = cleanPhone;
            console.log('📞 Loaded phone (no prefix):', cleanPhone, '→ assuming +44');
          }
        }
      } else {
        setPhoneCode('phoneCountryCode', '+44');
        phoneNumber.value = '';
      }
      
      email.value = formData.e || '';
      
      // Individual mode fields only
      if (!isEntityMode) {
        // Name change - show/hide fields based on data
        if (formData.nC === true) {
          recentNameChange.checked = true;
          nameChangeFields.classList.remove('hidden');
          previousName.value = formData.pN || '';
          reasonForNameChange.value = formData.rNC || ''; // Updated key
        } else {
          recentNameChange.checked = false;
          nameChangeFields.classList.add('hidden');
          previousName.value = '';
          reasonForNameChange.value = '';
        }
        
        // DOB - comes in as 'dd-mm-yyyy' or 'ddmmyyyy', display as individual digits
        if (formData.b && typeof formData.b === 'string') {
          // Strip all non-digit characters (handles both 'dd-mm-yyyy' and 'ddmmyyyy')
          const digits = formData.b.replace(/[^0-9]/g, '').slice(0, 8).split('');
          dobInputs.forEach((inp, i) => {
            inp.value = digits[i] || '';
          });
        } else {
          dobInputs.forEach(inp => inp.value = '');
        }
      }
      
      // Load current address (formData.a is the address object)
      // Show/hide fields based on country in data
      if (formData.a && typeof formData.a === 'object') {
        currentAddressObject = formData.a;
        setCountry('currentCountry', formData.a?.country || 'GBR');
        
        const isCurrentUK = currentCountry.dataset.countryCode === 'GBR';
        
        if (!isCurrentUK) {
          // Non-UK address - show manual fields, hide autocomplete and checkbox
          currentAddressAutocompleteRow.classList.add('hidden');
          addressNotListedRow.classList.add('hidden');
          manualAddressFields.classList.remove('hidden');
          addressNotListed.checked = false;
          
          // Populate manual fields
          flatNumber.value = formData.a?.flat_number || '';
          buildingNumber.value = formData.a?.building_number || '';
          buildingName.value = formData.a?.building_name || '';
          street.value = formData.a?.street || '';
          subStreet.value = formData.a?.sub_street || '';
          town.value = formData.a?.town || '';
          postcode.value = formData.a?.postcode || '';
          
          // Clear autocomplete
          currentAddress.value = '';
        } else {
          // UK address - show autocomplete and checkbox, hide manual fields
          currentAddressAutocompleteRow.classList.remove('hidden');
          addressNotListedRow.classList.remove('hidden');
          manualAddressFields.classList.add('hidden');
          addressNotListed.checked = false;
          currentAddress.value = formatThirdfortForDisplay(formData.a);
        }
      } else {
        // No address data - show UK autocomplete by default
        setCountry('currentCountry', 'GBR');
        currentAddressAutocompleteRow.classList.remove('hidden');
        addressNotListedRow.classList.remove('hidden');
        manualAddressFields.classList.add('hidden');
        addressNotListed.checked = false;
        currentAddress.value = '';
      }
      
      // Load previous address (formData.pA is the previous address object)
      // Show/hide fields based on data
      if (formData.rM === true) {
        recentMove.checked = true;
        previousAddressFields.classList.remove('hidden');
        
        if (formData.pA && typeof formData.pA === 'object') {
          previousAddressObject = formData.pA;
          setCountry('previousCountry', formData.pA?.country || 'GBR');
          
          const isPreviousUK = previousCountry.dataset.countryCode === 'GBR';
          
          if (!isPreviousUK) {
            // Non-UK address - show manual fields, hide autocomplete
            previousAddressAutocompleteRow.classList.add('hidden');
            previousAddressNotListedRow.classList.add('hidden');
            manualPreviousAddressFields.classList.remove('hidden');
            
            // Populate manual fields
            prevFlatNumber.value = formData.pA?.flat_number || '';
            prevBuildingNumber.value = formData.pA?.building_number || '';
            prevBuildingName.value = formData.pA?.building_name || '';
            prevStreet.value = formData.pA?.street || '';
            prevSubStreet.value = formData.pA?.sub_street || '';
            prevTown.value = formData.pA?.town || '';
            prevPostcode.value = formData.pA?.postcode || '';
          } else {
            // UK address - show autocomplete
            previousAddressAutocompleteRow.classList.remove('hidden');
            previousAddressNotListedRow.classList.remove('hidden');
            manualPreviousAddressFields.classList.add('hidden');
            previousAddress.value = formatThirdfortForDisplay(formData.pA);
          }
        } else {
          // Recent move checked but no address data - show UK autocomplete by default
          setCountry('previousCountry', 'GBR');
          previousAddressAutocompleteRow.classList.remove('hidden');
          previousAddressNotListedRow.classList.remove('hidden');
          manualPreviousAddressFields.classList.add('hidden');
          previousAddressNotListed.checked = false;
          previousAddress.value = '';
          
          // Clear manual fields
          prevFlatNumber.value = '';
          prevBuildingNumber.value = '';
          prevBuildingName.value = '';
          prevStreet.value = '';
          prevSubStreet.value = '';
          prevTown.value = '';
          prevPostcode.value = '';
        }
      } else {
        // No recent move - hide all previous address fields and clear data
        recentMove.checked = false;
        previousAddressFields.classList.add('hidden');
        previousAddressObject = null;
        
        // Clear and reset all previous address fields
        setCountry('previousCountry', 'GBR');
        previousAddress.value = '';
        previousAddressNotListed.checked = false;
        manualPreviousAddressFields.classList.add('hidden');
        
        // Clear manual fields
        prevFlatNumber.value = '';
        prevBuildingNumber.value = '';
        prevBuildingName.value = '';
        prevStreet.value = '';
        prevSubStreet.value = '';
        prevTown.value = '';
        prevPostcode.value = '';
      }
      
      // Loading complete - enable change detection
      // Use setTimeout to ensure all DOM updates are complete before enabling change detection
      setTimeout(() => {
        isLoadingData = false;
        console.log('… Data loaded successfully, change detection enabled');
        
        // Apply edit mode state (in case it was set before data load)
        setEditMode(allowEdits);
      }, 100);
    }
    
    // ===== CHANGE DETECTION LISTENERS =====
    
    // Add change listeners to all form inputs
    const allInputs = [
      registrationCountry, businessName, entityNumber,
      titlePrefix, firstName, middleName, lastName,
      phoneCountryCode, phoneNumber, email,
      previousName, reasonForNameChange,
      currentCountry, currentAddress,
      flatNumber, buildingNumber, buildingName, street, subStreet, town, postcode,
      previousCountry, previousAddress,
      prevFlatNumber, prevBuildingNumber, prevBuildingName, prevStreet, prevSubStreet, prevTown, prevPostcode
    ];
    
    const allCheckboxes = [recentNameChange, recentMove, addressNotListed, previousAddressNotListed];
    
    // Listen for input changes
    allInputs.forEach(input => {
      if (input) {
        input.addEventListener('input', notifyUnsavedChanges);
        input.addEventListener('change', notifyUnsavedChanges);
      }
    });
    
    // Listen for checkbox/toggle changes
    allCheckboxes.forEach(checkbox => {
      if (checkbox) {
        checkbox.addEventListener('change', notifyUnsavedChanges);
      }
    });
    
    // Listen for DOB input changes
    dobInputs.forEach(input => {
      if (input) {
        input.addEventListener('input', notifyUnsavedChanges);
      }
    });
    
    // Company link button - open Companies House page
    companyLinkBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openCompaniesHousePage();
    });
    
    // Company refresh button - fetch latest data
    companyRefreshBtn.addEventListener('click', (e) => {
      e.preventDefault();
      refreshCompanyData();
    });
    
    // Download summary button - generate PDF
    downloadSummaryBtn.addEventListener('click', (e) => {
      e.preventDefault();
      downloadCompanySummary();
    });
    
    // ===== INITIALIZE =====
    setupAddressAutocomplete(currentAddress, currentAddressDropdown, 'current', true);
    setupAddressAutocomplete(previousAddress, previousAddressDropdown, 'previous', false);
    setupCompanyNameAutocomplete();
    setupCompanyNumberAutocomplete();
  </script>
  
  <!-- Jurisdiction/Country Autocomplete (must load before initialization) -->
  <script src="js/jurisdiction-autocomplete.js?v=5baf66e"></script>
  <script>
    // Initialize all autocomplete fields immediately (DOM already loaded since scripts are at bottom)
    console.log('🔧 Initializing autocomplete fields...');
    initializeCountryAutocomplete('currentCountry', 'currentCountryDropdown');
    initializeCountryAutocomplete('previousCountry', 'previousCountryDropdown');
    initializePhoneCodeAutocomplete('phoneCountryCode', 'phoneCountryCodeDropdown');
    initializeJurisdictionAutocomplete('registrationCountry', 'registrationCountryDropdown');
    console.log('… Autocomplete initialization calls complete');
    
    // Patch elements to have .value getter/setter that work with data attributes
    const currentCountryEl = document.getElementById('currentCountry');
    const previousCountryEl = document.getElementById('previousCountry');
    const phoneCountryCodeEl = document.getElementById('phoneCountryCode');
    const registrationCountryEl = document.getElementById('registrationCountry');
    
    // DON'T patch .value - let autocomplete functions work directly
    // The autocomplete functions already set input.value and dataset attributes correctly
    
    // Update country change handlers to use data-country-code attribute
    const currentCountryInput = document.getElementById('currentCountry');
    const previousCountryInput = document.getElementById('previousCountry');
    
    if (currentCountryInput) {
      currentCountryInput.addEventListener('change', () => {
        const countryCode = currentCountryInput.dataset.countryCode || 'GBR';
        const isUK = countryCode === 'GBR';
        
        const currentAddressAutocompleteRow = document.getElementById('currentAddressAutocompleteRow');
        const addressNotListedRow = document.getElementById('addressNotListedRow');
        const manualAddressFields = document.getElementById('manualAddressFields');
        const addressNotListed = document.getElementById('addressNotListed');
        
        if (isUK) {
          // Show autocomplete and "address not listed" checkbox
          if (currentAddressAutocompleteRow) currentAddressAutocompleteRow.classList.remove('hidden');
          if (addressNotListedRow) addressNotListedRow.classList.remove('hidden');
          
          // Hide manual fields unless checkbox is checked
          if (addressNotListed && !addressNotListed.checked && manualAddressFields) {
            manualAddressFields.classList.add('hidden');
          }
        } else {
          // Hide autocomplete and checkbox, show manual fields
          if (currentAddressAutocompleteRow) currentAddressAutocompleteRow.classList.add('hidden');
          if (addressNotListedRow) addressNotListedRow.classList.add('hidden');
          if (manualAddressFields) manualAddressFields.classList.remove('hidden');
          
          // Uncheck "address not listed" since we're forcing manual
          if (addressNotListed) addressNotListed.checked = false;
        }
      });
    }
    
    if (previousCountryInput) {
      previousCountryInput.addEventListener('change', () => {
        const countryCode = previousCountryInput.dataset.countryCode || 'GBR';
        const isUK = countryCode === 'GBR';
        
        const previousAddressAutocompleteRow = document.getElementById('previousAddressAutocompleteRow');
        const previousAddressNotListedRow = document.getElementById('previousAddressNotListedRow');
        const manualPreviousAddressFields = document.getElementById('manualPreviousAddressFields');
        const previousAddressNotListed = document.getElementById('previousAddressNotListed');
        
        if (isUK) {
          // Show autocomplete and "address not listed" checkbox
          if (previousAddressAutocompleteRow) previousAddressAutocompleteRow.classList.remove('hidden');
          if (previousAddressNotListedRow) previousAddressNotListedRow.classList.remove('hidden');
          
          // Hide manual fields unless checkbox is checked
          if (previousAddressNotListed && !previousAddressNotListed.checked && manualPreviousAddressFields) {
            manualPreviousAddressFields.classList.add('hidden');
          }
        } else {
          // Hide autocomplete and checkbox, show manual fields
          if (previousAddressAutocompleteRow) previousAddressAutocompleteRow.classList.add('hidden');
          if (previousAddressNotListedRow) previousAddressNotListedRow.classList.add('hidden');
          if (manualPreviousAddressFields) manualPreviousAddressFields.classList.remove('hidden');
          
          // Uncheck "address not listed" since we're forcing manual
          if (previousAddressNotListed) previousAddressNotListed.checked = false;
        }
      });
    }
  </script>
<!-- IFRAME_VERSION START -->
<script>
  (function() {
    window.__IFRAME_VERSION__ = '5baf66e';
    console.log('[client-details] version ' + window.__IFRAME_VERSION__);
  })();
</script>
<!-- IFRAME_VERSION END -->
</body>
</html>





