<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Migration Tagger</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgb(0, 60, 113);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .progress-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .begin-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .begin-controls label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .begin-controls input {
            width: 60px;
            padding: 6px;
            border: 1px solid white;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }

        .begin-btn {
            background: #10a37f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .begin-btn:hover {
            background: #0d8f6f;
        }

        .begin-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* LEFT PANEL - Image List */
        .left-panel {
            width: 250px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            background: #fafafa;
        }

        .entry-section {
            border-bottom: 3px solid #e0e0e0;
            padding: 12px;
        }

        .entry-section.complete {
            background: #e8f5e9;
        }

        .entry-section.active {
            background: #fff3cd;
        }

        .entry-header {
            font-weight: 700;
            color: rgb(0, 60, 113);
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .entry-status.pending {
            background: #ffc107;
            color: #333;
        }

        .entry-status.complete {
            background: #28a745;
            color: white;
        }

        .image-thumbnail {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .image-thumbnail:hover {
            background: rgba(0, 60, 113, 0.1);
        }

        .image-thumbnail.active {
            background: rgba(74, 144, 226, 0.2);
            border: 2px solid #4A90E2;
        }

        .image-thumbnail.tagged {
            background: rgba(40, 167, 69, 0.1);
        }

        .thumbnail-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .thumbnail-info {
            flex: 1;
            font-size: 0.75rem;
            color: #666;
        }

        .thumbnail-tag {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #D4A574;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .thumbnail-tag.skip {
            background: #dc3545; /* Red for skipped images */
        }

        .image-thumbnail.skipped {
            opacity: 0.5; /* Dim skipped images */
        }

        /* RIGHT PANEL - Main Tagging Area */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }

        .current-entry-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 2px solid #e0e0e0;
            flex-shrink: 0;
        }

        .current-entry-info h2 {
            font-size: 1.1rem;
            color: rgb(0, 60, 113);
            margin-bottom: 4px;
        }

        .current-entry-info p {
            font-size: 0.85rem;
            color: #666;
        }

        .main-image-container {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 0; /* Allow flex item to shrink below content size */
            max-height: calc(100vh - 250px); /* Ensure hotkeys/footer always visible */
        }

        .main-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .image-counter-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .hotkey-card {
            background: #f8f9fa;
            padding: 12px 15px;
            border-top: 2px solid #e0e0e0;
            flex-shrink: 0;
        }

        .hotkey-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }

        .hotkey-overlay {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hotkey-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .hotkey-item:hover {
            background: #e9ecef;
            border-color: #4A90E2;
            transform: scale(1.05);
        }

        .hotkey-item:active {
            transform: scale(0.95);
        }

        .hotkey-key {
            background: #4A90E2;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 36px;
            text-align: center;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
        }

        .hotkey-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
            pointer-events: none;
        }

        .confirm-prompt {
            background: #28a745;
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: 600;
            border-top: 2px solid #20874a;
            flex-shrink: 0;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .footer {
            padding: 10px 15px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .upload-btn {
            background: rgb(0, 60, 113);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .upload-btn:hover:not(:disabled) {
            background: rgb(0, 40, 80);
            transform: translateY(-1px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            font-size: 0.9rem;
            color: #666;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid rgb(0, 60, 113);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Upload progress modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .upload-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .upload-modal h2 {
            margin-bottom: 15px;
            color: rgb(0, 60, 113);
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90E2, #10a37f);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .file-upload-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-upload-item {
            background: #f9f9f9;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .file-upload-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-upload-item-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .file-upload-item-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-pending {
            background: #ffc107;
            color: #333;
        }

        .badge-uploading {
            background: #4A90E2;
            color: white;
        }

        .badge-success {
            background: #10a37f;
            color: white;
        }

        .badge-error {
            background: #e02424;
            color: white;
        }

        .file-upload-item-details {
            color: #666;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .file-upload-item.uploading {
            border-color: #4A90E2;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.2);
        }

        .file-upload-item.success {
            border-color: #10a37f;
            background: #e8f5e9;
        }

        .file-upload-item.error {
            border-color: #e02424;
            background: #ffebee;
        }

        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            color: #666;
        }

        /* Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .confirm-modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .confirm-modal-header {
            margin-bottom: 15px;
        }

        .confirm-modal-header h2 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.3rem;
        }

        .confirm-modal-header p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .confirm-cards-container {
            overflow-y: auto;
            flex: 1;
            margin-bottom: 20px;
        }

        .confirm-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .confirm-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .confirm-card-title {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .confirm-card-count {
            background: #4A90E2;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .confirm-image-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .confirm-image-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .confirm-image-thumb {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
        }

        .confirm-image-info {
            flex: 1;
            font-size: 0.8rem;
        }

        .confirm-image-tag {
            background: #D4A574;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .confirm-image-tag.skip {
            background: #dc3545;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 10px;
        }

        .confirm-cancel-btn {
            flex: 1;
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .confirm-cancel-btn:hover {
            background: #5a6268;
        }

        .confirm-submit-btn {
            flex: 2;
            background: #10a37f;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .confirm-submit-btn:hover {
            background: #0d8f6f;
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .left-panel {
                width: 220px;
            }
        }

        @media (max-width: 992px) {
            body {
                padding: 10px;
            }
            
            .left-panel {
                width: 200px;
            }
            
            .right-panel {
                padding: 15px;
            }
            
            .hotkey-overlay {
                gap: 8px;
            }
            
            .hotkey-item {
                padding: 8px 10px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                padding: 12px 15px;
            }
            
            .header h1 {
                font-size: 1.1rem;
                text-align: center;
            }
            
            .begin-controls {
                justify-content: center;
            }
            
            .progress-info {
                text-align: center;
                font-size: 0.85rem;
            }
            
            .main-layout {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            
            .right-panel {
                padding: 15px;
            }
            
            .main-image-container {
                height: 300px;
            }
            
            .hotkey-card {
                padding: 15px;
            }
            
            .hotkey-overlay {
                gap: 6px;
            }
            
            .hotkey-item {
                padding: 6px 8px;
                min-width: calc(33.33% - 4px);
            }
            
            .hotkey-key {
                font-size: 0.8rem;
                padding: 4px 8px;
                min-width: 30px;
            }
            
            .hotkey-label {
                font-size: 0.7rem;
            }
            
            .footer {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
            }
            
            .stats {
                text-align: center;
                font-size: 0.85rem;
            }
            
            .upload-modal-content {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
            }
            
            .confirm-modal-content {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 3px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .begin-controls {
                flex-direction: column;
                gap: 6px;
            }
            
            .begin-controls label {
                font-size: 0.85rem;
            }
            
            .begin-controls input {
                width: 100%;
            }
            
            .begin-btn {
                width: 100%;
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .progress-info {
                font-size: 0.8rem;
            }
            
            .left-panel {
                max-height: 150px;
            }
            
            .entry-section {
                padding: 8px;
            }
            
            .entry-header {
                font-size: 0.8rem;
            }
            
            .entry-status {
                font-size: 0.65rem;
                padding: 1px 4px;
            }
            
            .image-thumbnail {
                gap: 6px;
                padding: 4px;
            }
            
            .thumbnail-img {
                width: 50px;
                height: 50px;
            }
            
            .thumbnail-info {
                font-size: 0.7rem;
            }
            
            .thumbnail-tag {
                font-size: 0.6rem;
                padding: 1px 3px;
            }
            
            .right-panel {
                padding: 10px;
            }
            
            .current-entry-info {
                padding: 8px;
                margin-bottom: 10px;
            }
            
            .current-entry-info h2 {
                font-size: 0.95rem;
            }
            
            .current-entry-info p {
                font-size: 0.75rem;
            }
            
            .main-image-container {
                height: 250px;
            }
            
            .image-counter-overlay {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            .hotkey-card {
                padding: 10px;
                margin-top: 10px;
            }
            
            .hotkey-card-title {
                font-size: 0.8rem;
                margin-bottom: 8px;
            }
            
            .hotkey-overlay {
                gap: 4px;
            }
            
            .hotkey-item {
                padding: 5px 6px;
                min-width: calc(50% - 2px);
                flex: 0 0 calc(50% - 2px);
            }
            
            .hotkey-key {
                font-size: 0.75rem;
                padding: 4px 6px;
                min-width: 28px;
            }
            
            .hotkey-label {
                font-size: 0.65rem;
            }
            
            .confirm-prompt {
                padding: 8px 12px;
                font-size: 0.85rem;
                margin-top: 10px;
            }
            
            .footer {
                padding: 10px;
            }
            
            .stats {
                font-size: 0.8rem;
            }
            
            .upload-modal-content,
            .confirm-modal-content {
                width: 98%;
                padding: 15px;
                max-height: 90vh;
            }
            
            .upload-modal h2,
            .confirm-modal-header h2 {
                font-size: 1.1rem;
            }
            
            .confirm-modal-header p {
                font-size: 0.85rem;
            }
            
            .file-upload-item {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .file-upload-item-name {
                font-size: 0.85rem;
            }
            
            .file-upload-item-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            .file-upload-item-details {
                font-size: 0.75rem;
            }
            
            .confirm-card {
                padding: 8px;
            }
            
            .confirm-card-title {
                font-size: 0.85rem;
            }
            
            .confirm-card-count {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
            
            .confirm-image-thumb {
                width: 40px;
                height: 40px;
            }
            
            .confirm-image-info {
                font-size: 0.75rem;
            }
            
            .confirm-image-tag {
                font-size: 0.65rem;
                padding: 2px 5px;
            }
            
            .confirm-modal-actions {
                gap: 6px;
            }
            
            .confirm-cancel-btn,
            .confirm-submit-btn {
                padding: 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 360px) {
            .header h1 {
                font-size: 0.9rem;
            }
            
            .begin-controls label {
                font-size: 0.75rem;
            }
            
            .begin-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .left-panel {
                max-height: 120px;
            }
            
            .current-entry-info h2 {
                font-size: 0.85rem;
            }
            
            .current-entry-info p {
                font-size: 0.7rem;
            }
            
            .main-image-container {
                height: 200px;
            }
            
            .hotkey-card-title {
                font-size: 0.75rem;
            }
            
            .hotkey-item {
                padding: 4px 5px;
            }
            
            .hotkey-key {
                font-size: 0.7rem;
                padding: 3px 5px;
                min-width: 24px;
            }
            
            .hotkey-label {
                font-size: 0.6rem;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-layout {
                flex-direction: row;
            }
            
            .left-panel {
                width: 180px;
                max-height: none;
                border-right: 2px solid #e0e0e0;
                border-bottom: none;
            }
            
            .main-image-container {
                height: auto;
                min-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∑Ô∏è ID Image Migration Tool</h1>
            
            <!-- Begin Controls (shown initially) -->
            <div class="begin-controls" id="beginControls">
                <label for="limitInput">Entries to load:</label>
                <input type="number" id="limitInput" min="1" max="10" value="10" />
                <button class="begin-btn" id="beginBtn">Begin</button>
            </div>
            
            <!-- Progress Info (shown after data loaded) -->
            <div class="progress-info hidden" id="progressInfo">
                <span id="entryProgress">Entry 0/0</span> | 
                <span id="imageProgress">Image 0/0</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state hidden">
            <div class="spinner"></div>
            <p>Loading entries...</p>
        </div>

        <!-- No Data State -->
        <div id="noDataState" class="no-data hidden">
            <h2>üì≠ No Entries to Process</h2>
            <p>No entries were provided for migration.</p>
        </div>

        <!-- Main Tagging Interface -->
        <div id="mainInterface" class="hidden">
            <div class="main-layout">
                <!-- Left Panel: Image List -->
                <div class="left-panel" id="leftPanel">
                    <!-- Entry sections will be dynamically added here -->
                </div>

                <!-- Right Panel: Main Tagging Area -->
                <div class="right-panel">
                    <div class="current-entry-info">
                        <h2 id="currentEntryName">Entry Name</h2>
                        <p id="currentEntryDetails">Details</p>
                    </div>

                    <div class="main-image-container" id="mainImageContainer">
                        <img id="mainImage" src="" alt="ID Document">
                        <div class="image-counter-overlay" id="imageCounter">1 / 10</div>
                    </div>

                    <!-- Hotkey Guide Card (below image) -->
                    <div class="hotkey-card">
                        <div class="hotkey-card-title">üè∑Ô∏è Tag Image (Click or Press Key)</div>
                        <div class="hotkey-overlay">
                            <div class="hotkey-item" onclick="tagCurrentImage('Passport')" title="Click to tag or press P">
                                <div class="hotkey-key">P</div>
                                <div class="hotkey-label">Passport</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Driving Licence Front')" title="Click to tag or press DF">
                                <div class="hotkey-key">DF</div>
                                <div class="hotkey-label">DL Front</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Driving Licence Back')" title="Click to tag or press DB">
                                <div class="hotkey-key">DB</div>
                                <div class="hotkey-label">DL Back</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Other Photo ID Single')" title="Click to tag or press OS">
                                <div class="hotkey-key">OS</div>
                                <div class="hotkey-label">Other ID</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Other Photo ID Front')" title="Click to tag or press OF">
                                <div class="hotkey-key">OF</div>
                                <div class="hotkey-label">Other Front</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Other Photo ID Back')" title="Click to tag or press OB">
                                <div class="hotkey-key">OB</div>
                                <div class="hotkey-label">Other Back</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Other')" title="Click to tag or press A">
                                <div class="hotkey-key">A</div>
                                <div class="hotkey-label">Address ID</div>
                            </div>
                            <div class="hotkey-item" onclick="tagCurrentImage('Skip')" title="Click to tag or press Tab" style="background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545;">
                                <div class="hotkey-key" style="background: #dc3545;">Tab</div>
                                <div class="hotkey-label" style="color: #dc3545;">Skip</div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm Prompt (shown when entry complete) -->
                    <div id="confirmPrompt" class="confirm-prompt hidden">
                        ‚úÖ Entry Complete! Press <strong>ENTER</strong> to continue or click next entry ‚Üí
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="stats">
                    <strong id="taggedCount">0</strong> images tagged | 
                    <strong id="remainingCount">0</strong> remaining
                </div>
            </div>
        </div>

        <!-- Upload Progress Modal -->
        <div id="uploadModal" class="upload-modal hidden">
            <div class="upload-modal-content">
                <h2>Uploading Images to S3</h2>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">0%</div>
                </div>
                <p id="uploadStatus">Preparing upload...</p>
                <div class="file-upload-list" id="fileUploadList"></div>
            </div>
        </div>

        <!-- Error Popup (matching image-viewer.html styling) -->
        <div id="errorPopup" class="upload-modal hidden">
            <div class="upload-modal-content" style="background: #dc3545; padding: 20px; max-width: 400px;">
                <button onclick="hideErrorPopup()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">√ó</button>
                <h2 style="color: white; font-size: 1.1rem; margin-bottom: 10px; font-weight: 600;">Upload Error</h2>
                <p id="errorMessage" style="color: white; margin: 0; line-height: 1.4; font-size: 0.9rem;"></p>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="confirm-modal hidden">
            <div class="confirm-modal-content">
                <div class="confirm-modal-header">
                    <h2>Confirm Upload</h2>
                    <p id="confirmSummary">Review tagged images before uploading to S3</p>
                </div>
                <div class="confirm-cards-container" id="confirmCardsContainer">
                    <!-- Cards will be populated here -->
                </div>
                <div class="confirm-modal-actions">
                    <button class="confirm-cancel-btn" onclick="hideConfirmModal()">Cancel</button>
                    <button class="confirm-submit-btn" onclick="confirmAndUpload()">Upload to S3</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        =====================================================================
        ID MIGRATION TAGGER - State Management
        =====================================================================
        */
        let batchData = null; // Array of entries from parent
        let currentBatchNumber = 0;
        let totalBatches = 0;
        let currentEntryIndex = 0;
        let currentImageIndex = 0;
        let uploader = '';
        let pendingHotkey = ''; // For two-character hotkeys (DF, DB, OS, OF, OB)
        let currentLimit = 10; // Store current limit for all messages to parent
        let currentRotation = 0; // Track current image rotation (0, 90, 180, 270)
        
        // Image cache for background pre-fetching
        const imageCache = new Map(); // Key: entryId-imageIndex, Value: {blob, metadata}

        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const noDataState = document.getElementById('noDataState');
        const mainInterface = document.getElementById('mainInterface');
        const leftPanel = document.getElementById('leftPanel');
        const mainImage = document.getElementById('mainImage');
        const imageCounter = document.getElementById('imageCounter');
        const currentEntryName = document.getElementById('currentEntryName');
        const currentEntryDetails = document.getElementById('currentEntryDetails');
        const confirmPrompt = document.getElementById('confirmPrompt');
        const entryProgress = document.getElementById('entryProgress');
        const imageProgress = document.getElementById('imageProgress');
        const confirmModal = document.getElementById('confirmModal');
        const confirmCardsContainer = document.getElementById('confirmCardsContainer');
        const confirmSummary = document.getElementById('confirmSummary');
        const taggedCount = document.getElementById('taggedCount');
        const remainingCount = document.getElementById('remainingCount');
        const uploadModal = document.getElementById('uploadModal');
        const progressFill = document.getElementById('progressFill');
        const uploadStatus = document.getElementById('uploadStatus');
        const fileUploadList = document.getElementById('fileUploadList');
        const beginControls = document.getElementById('beginControls');
        const progressInfo = document.getElementById('progressInfo');
        const beginBtn = document.getElementById('beginBtn');
        const limitInput = document.getElementById('limitInput');

        /*
        =====================================================================
        Message Handling from Parent
        =====================================================================
        */
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'migration-batch') {
                handleBatchData(event.data);
            } else if (event.data && event.data.type === 'put-links') {
                handlePutLinks(event.data);
            } else if (event.data && event.data.type === 'put-error') {
                handlePutError(event.data);
            } else if (event.data && event.data.type === 'backend-error') {
                handleBackendError(event.data);
            } else if (event.data && event.data.type === 'network-error') {
                handleNetworkError(event.data);
            }
        });

        function handleBatchData(data) {
            console.log('Received migration batch:', data);
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            // Show begin controls and progress info in header
            beginControls.classList.remove('hidden');
            progressInfo.classList.remove('hidden');
            
            // Close upload modal if it's open (allows interaction with new data)
            uploadModal.classList.add('hidden');
            
            // Close confirmation modal if it's open
            if (confirmModal) {
                confirmModal.classList.add('hidden');
            }
            
            // Clear any stored upload data
            window.uploadDataWithBlobs = null;
            window.confirmModalWasOpen = false;
            
            // Clear image cache for new batch
            imageCache.clear();
            
            batchData = data.entries || [];
            currentBatchNumber = data.batchNumber || 1;
            totalBatches = data.totalBatches || 1;
            uploader = 'System transfer'; // Migration marker instead of user email
            
            if (batchData.length === 0) {
                showNoData();
                return;
            }
            
            // Scroll left panel to top when new data loaded
            leftPanel.scrollTop = 0;
            
            // Initialize tagging state for each entry
            batchData.forEach(entry => {
                // Flatten cD object for easier access
                if (entry.cD) {
                    entry.fe = entry.cD.f;
                    entry.clientNumber = entry.cD.c;
                    entry.matterNumber = entry.cD.m;
                    entry.name = entry.cD.n;
                }
                
                // Handle both array of URLs (strings) or array of objects
                entry.images = (entry.images || []).map((photo, index) => ({
                    src: typeof photo === 'string' ? photo : (photo.src || photo),
                    fileName: `image-${index}.jpg`,
                    tag: null, // Will be set by hotkeys
                    uploaded: false
                }));
                entry.complete = false;
            });
            
            currentEntryIndex = 0;
            currentImageIndex = 0;
            
            renderInterface();
            updateDisplay();
        }

        function showNoData() {
            loadingState.classList.add('hidden');
            noDataState.classList.remove('hidden');
            mainInterface.classList.add('hidden');
        }

        /*
        =====================================================================
        Rendering Functions
        =====================================================================
        */
        function renderInterface() {
            loadingState.classList.add('hidden');
            noDataState.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            
            // Render left panel entry list
            renderLeftPanel();
            
            // Update progress info
            updateProgressInfo();
        }

        function renderLeftPanel() {
            leftPanel.innerHTML = '';
            
            batchData.forEach((entry, entryIdx) => {
                const section = document.createElement('div');
                section.className = 'entry-section';
                if (entry.complete) section.classList.add('complete');
                if (entryIdx === currentEntryIndex) section.classList.add('active');
                
                const statusClass = entry.complete ? 'complete' : 'pending';
                const statusText = entry.complete ? 'Complete' : 'Pending';
                
                section.innerHTML = `
                    <div class="entry-header">
                        <span>${entry.fe}-${entry.clientNumber}-${entry.matterNumber}</span>
                        <span class="entry-status ${statusClass}">${statusText}</span>
                    </div>
                    <div id="entry-${entryIdx}-images"></div>
                `;
                
                leftPanel.appendChild(section);
                
                // Render image thumbnails for this entry
                const imagesContainer = section.querySelector(`#entry-${entryIdx}-images`);
                entry.images.forEach((img, imgIdx) => {
                    const thumb = document.createElement('div');
                    thumb.className = 'image-thumbnail';
                    if (img.tag) thumb.classList.add('tagged');
                    if (img.tag === 'Skip') thumb.classList.add('skipped'); // Dim skipped images
                    if (entryIdx === currentEntryIndex && imgIdx === currentImageIndex) {
                        thumb.classList.add('active');
                    }
                    
                    const tagClass = img.tag === 'Skip' ? 'skip' : '';
                    
                    // Get display text for tag
                    const tagDisplayText = img.tag ? getTagDisplayText(img.tag) : '<em>Not tagged</em>';
                    const tagBadgeText = img.tag ? getTagBadgeText(img.tag) : '';
                    
                    thumb.innerHTML = `
                        <img class="thumbnail-img" src="${img.src}" alt="Image ${imgIdx + 1}">
                        <div class="thumbnail-info">
                            ${tagDisplayText}
                        </div>
                        ${tagBadgeText ? `<div class="thumbnail-tag ${tagClass}">${tagBadgeText}</div>` : ''}
                    `;
                    
                    thumb.onclick = () => jumpToImage(entryIdx, imgIdx);
                    imagesContainer.appendChild(thumb);
                });
            });
        }

        function getTagShorthand(tag) {
            const map = {
                'Passport': 'P',
                'Driving Licence Front': 'DF',
                'Driving Licence Back': 'DB',
                'Other Photo ID Single': 'OS',
                'Other Photo ID Front': 'OF',
                'Other Photo ID Back': 'OB',
                'Other': 'A',
                'Skip': 'Tab'
            };
            return map[tag] || tag;
        }

        function getTagDisplayText(tag) {
            // Full text shown in left panel thumbnail info
            const map = {
                'Passport': 'Passport',
                'Driving Licence Front': 'Driving Licence - Front',
                'Driving Licence Back': 'Driving Licence - Back',
                'Other Photo ID Single': 'Other Photo ID',
                'Other Photo ID Front': 'Other Photo ID - Front',
                'Other Photo ID Back': 'Other Photo ID - Back',
                'Other': 'Address ID',
                'Skip': 'Skip'
            };
            return map[tag] || tag;
        }

        function getTagBadgeText(tag) {
            // Badge text shown in thumbnail - only show Front/Back, or Ignore
            if (tag === 'Skip') return 'Ignore';
            if (tag.includes('Front')) return 'Front';
            if (tag.includes('Back')) return 'Back';
            return ''; // No badge for Single
        }

        function updateDisplay() {
            const entry = batchData[currentEntryIndex];
            const image = entry.images[currentImageIndex];
            
            // Reset rotation when changing images
            resetRotation();
            
            // Update current entry info
            currentEntryName.textContent = `${entry.fe}-${entry.clientNumber}-${entry.matterNumber} - ${entry.name}`;
            currentEntryDetails.textContent = `Entry ${currentEntryIndex + 1} of ${batchData.length} | Image ${currentImageIndex + 1} of ${entry.images.length}`;
            
            // Update main image
            mainImage.src = image.src;
            imageCounter.textContent = `${currentImageIndex + 1} / ${entry.images.length}`;
            
            // Check if entry is complete
            const entryComplete = entry.images.every(img => img.tag !== null);
            if (entryComplete && !entry.complete) {
                confirmPrompt.classList.remove('hidden');
            } else {
                confirmPrompt.classList.add('hidden');
            }
            
            // Update stats
            updateStats();
            
            // Check if all entries complete
            checkIfAllComplete();
        }

        function updateProgressInfo() {
            entryProgress.textContent = `Entry ${currentEntryIndex + 1}/${batchData.length}`;
            imageProgress.textContent = `Image ${currentImageIndex + 1}/${batchData[currentEntryIndex].images.length}`;
        }

        function updateStats() {
            let tagged = 0;
            let remaining = 0;
            let skipped = 0;
            
            batchData.forEach(entry => {
                entry.images.forEach(img => {
                    if (img.tag === 'Skip') {
                        skipped++;
                    } else if (img.tag) {
                        tagged++;
                    } else {
                        remaining++;
                    }
                });
            });
            
            taggedCount.textContent = tagged;
            remainingCount.textContent = remaining + (skipped > 0 ? ` (${skipped} skipped)` : '');
        }

        function checkIfAllComplete() {
            const allComplete = batchData.every(entry => entry.complete);
            
            // Show confirmation modal when all entries are complete
            if (allComplete) {
                // If we were already viewing it and came back after re-tagging, re-show
                if (window.confirmModalWasOpen) {
                    window.confirmModalWasOpen = false;
                    showConfirmModal();
                } else {
                    // First time all complete - show modal
                    showConfirmModal();
                }
            }
        }

        function jumpToImage(entryIdx, imgIdx) {
            // Auto-mark current entry as complete if all images tagged before switching
            const currentEntry = batchData[currentEntryIndex];
            if (currentEntry) {
                const allTagged = currentEntry.images.every(img => img.tag !== null);
                if (allTagged) {
                    currentEntry.complete = true;
                }
            }
            
            currentEntryIndex = entryIdx;
            currentImageIndex = imgIdx;
            renderLeftPanel();
            updateDisplay();
            updateProgressInfo();
            
            // Scroll to active entry in left panel
            scrollToActiveEntry();
        }

        /*
        =====================================================================
        Hotkey Handling
        =====================================================================
        */
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            // Handle Tab to skip/ignore current image
            if (e.key === 'Tab') {
                e.preventDefault(); // Prevent default tab behavior
                tagCurrentImage('Skip');
                return;
            }
            
            // Handle Arrow keys to rotate current image
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                rotateImage(-90); // Rotate counter-clockwise
                return;
            }
            
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                rotateImage(90); // Rotate clockwise
                return;
            }
            
            // Handle Backspace to go to previous image (for re-tagging)
            if (e.key === 'Backspace') {
                e.preventDefault(); // Prevent browser back navigation
                goToPreviousImage();
                return;
            }
            
            // Handle Enter key to move to next entry
            if (key === 'enter') {
                e.preventDefault(); // Prevent any default form submission behavior
                
                const entry = batchData[currentEntryIndex];
                const entryComplete = entry.images.every(img => img.tag !== null);
                
                console.log('Enter pressed:', {
                    entryIndex: currentEntryIndex,
                    entryName: entry.name,
                    entryComplete: entryComplete,
                    alreadyMarkedComplete: entry.complete,
                    tags: entry.images.map(img => img.tag),
                    isLastEntry: currentEntryIndex === batchData.length - 1
                });
                
                if (entryComplete && !entry.complete) {
                    entry.complete = true;
                    confirmPrompt.classList.add('hidden');
                    
                    console.log('Marking entry complete');
                    
                    // Start background pre-fetching for this entry's images
                    prefetchEntryImages(entry);
                    
                    // Move to next entry OR update UI if last entry
                    if (currentEntryIndex < batchData.length - 1) {
                        console.log('Moving to next entry');
                        currentEntryIndex++;
                        currentImageIndex = 0;
                        renderLeftPanel();
                        updateDisplay();
                        updateProgressInfo();
                        
                        // Scroll to active entry in left panel
                        scrollToActiveEntry();
                    } else {
                        console.log('Last entry in batch - updating UI only');
                        // Last entry - update UI to show complete state and enable upload button
                        renderLeftPanel(); // This will show entry as green
                        confirmPrompt.classList.add('hidden'); // Hide confirm prompt
                        updateDisplay(); // Refresh display
                        updateProgressInfo(); // Update progress
                        checkIfAllComplete(); // Enable upload button if all complete
                    }
                } else {
                    console.log('Cannot mark complete: entry not complete or already marked complete');
                }
                return;
            }
            
            // Handle two-character hotkeys (DF, DB, OS, OF, OB)
            if (pendingHotkey) {
                const fullKey = pendingHotkey + key;
                pendingHotkey = '';
                
                const tagMap = {
                    'df': 'Driving Licence Front',
                    'db': 'Driving Licence Back',
                    'os': 'Other Photo ID Single',
                    'of': 'Other Photo ID Front',
                    'ob': 'Other Photo ID Back'
                };
                
                if (tagMap[fullKey]) {
                    tagCurrentImage(tagMap[fullKey]);
                }
                return;
            }
            
            // Start of two-character hotkey
            if (key === 'd' || key === 'o') {
                pendingHotkey = key;
                return;
            }
            
            // Single-character hotkeys
            if (key === 'p') {
                tagCurrentImage('Passport');
            } else if (key === 'a') {
                tagCurrentImage('Other');
            }
        });

        /*
        =====================================================================
        Image Rotation
        =====================================================================
        */
        function rotateImage(degrees) {
            const nextRotation = (currentRotation + degrees) % 360;
            const normalizedNext = nextRotation < 0 ? nextRotation + 360 : nextRotation;
            
            // Check if we're crossing 0¬∞ boundary
            // If at 270¬∞ and rotating right (+90), should unwind to 0¬∞ not continue to 360¬∞
            // If at 90¬∞ and rotating left (-90), should unwind to 0¬∞ not continue to -90¬∞
            if (currentRotation === 270 && degrees > 0) {
                // At 270¬∞, rotating right ‚Üí unwind back to 0¬∞
                currentRotation = 0;
                mainImage.style.transform = 'rotate(0deg)';
            } else if (currentRotation === 90 && degrees < 0) {
                // At 90¬∞, rotating left ‚Üí unwind back to 0¬∞
                currentRotation = 0;
                mainImage.style.transform = 'rotate(0deg)';
            } else {
                // Normal rotation
                currentRotation = normalizedNext;
                mainImage.style.transform = `rotate(${currentRotation}deg)`;
            }
            
            console.log(`üîÑ Image rotated to ${currentRotation}¬∞`);
        }

        function resetRotation() {
            currentRotation = 0;
            mainImage.style.transform = 'rotate(0deg)';
        }

        function tagCurrentImage(tag) {
            const entry = batchData[currentEntryIndex];
            const image = entry.images[currentImageIndex];
            
            image.tag = tag;
            
            // Auto-advance to next untagged image in current entry
            let nextImageIndex = currentImageIndex + 1;
            while (nextImageIndex < entry.images.length && entry.images[nextImageIndex].tag !== null) {
                nextImageIndex++;
            }
            
            if (nextImageIndex < entry.images.length) {
                currentImageIndex = nextImageIndex;
            } else {
                // Stay on last image, entry is complete
                currentImageIndex = entry.images.length - 1;
            }
            
            renderLeftPanel();
            updateDisplay();
            updateProgressInfo();
        }

        function goToPreviousImage() {
            const entry = batchData[currentEntryIndex];
            
            if (currentImageIndex > 0) {
                // Go to previous image in current entry
                currentImageIndex--;
            } else if (currentEntryIndex > 0) {
                // Go to last image of previous entry
                currentEntryIndex--;
                const previousEntry = batchData[currentEntryIndex];
                currentImageIndex = previousEntry.images.length - 1;
            }
            // If already at first image of first entry, do nothing
            
            renderLeftPanel();
            updateDisplay();
            updateProgressInfo();
            
            // Scroll to active entry in left panel
            scrollToActiveEntry();
        }

        function scrollToActiveEntry() {
            // Wait for render to complete
            setTimeout(() => {
                const activeSection = leftPanel.querySelector('.entry-section.active');
                if (activeSection) {
                    activeSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }
            }, 100);
        }

        /*
        =====================================================================
        Wix URL Conversion
        =====================================================================
        */
        function convertWixUrlToPublic(wixUrl) {
            // Convert wix:image://v1/{MEDIA_ID}/{FILENAME}#... to https://static.wixstatic.com/media/{MEDIA_ID}
            if (!wixUrl || !wixUrl.startsWith('wix:image://')) {
                return wixUrl; // Already a public URL or invalid
            }
            
            try {
                // Extract media ID from wix:image://v1/{MEDIA_ID}/{FILENAME}#...
                const match = wixUrl.match(/wix:image:\/\/v1\/([^\/]+)/);
                if (match && match[1]) {
                    const mediaId = match[1];
                    return `https://static.wixstatic.com/media/${mediaId}`;
                }
                
                console.warn('Could not parse Wix URL:', wixUrl);
                return wixUrl;
            } catch (error) {
                console.error('Error converting Wix URL:', error);
                return wixUrl;
            }
        }

        /*
        =====================================================================
        Background Image Pre-fetching
        =====================================================================
        */
        async function prefetchEntryImages(entry) {
            console.log('üîÑ Background pre-fetching images for:', entry.name);
            
            for (let imgIdx = 0; imgIdx < entry.images.length; imgIdx++) {
                const img = entry.images[imgIdx];
                
                // Skip untagged or skipped images
                if (!img.tag || img.tag === 'Skip') continue;
                
                const cacheKey = `${entry._id}-${imgIdx}`;
                
                // Skip if already cached
                if (imageCache.has(cacheKey)) continue;
                
                try {
                    const publicUrl = convertWixUrlToPublic(img.src);
                    const response = await fetch(publicUrl);
                    const blob = await response.blob();
                    
                    // Store in cache
                    imageCache.set(cacheKey, {
                        blob: blob,
                        metadata: {
                            type: blob.type || 'image/jpeg',
                            size: blob.size,
                            lastModified: Date.now()
                        }
                    });
                    
                    console.log(`‚úÖ Pre-fetched: ${entry.name} - Image ${imgIdx + 1}`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Pre-fetch failed for ${entry.name} - Image ${imgIdx + 1}:`, error);
                    // Don't block - will fetch during upload if needed
                }
            }
        }

        /*
        =====================================================================
        Upload to S3
        =====================================================================
        */
        async function uploadToS3() {
            // Build upload data with all tagged images - use cache if available
            const uploadData = [];
            
            // Show upload modal early to indicate processing
            uploadModal.classList.remove('hidden');
            uploadStatus.textContent = 'Preparing images...';
            progressFill.style.width = '0%';
            fileUploadList.innerHTML = '';
            
            try {
                // Compile all tagged images (using cache when available)
                for (const entry of batchData) {
                    for (let imgIdx = 0; imgIdx < entry.images.length; imgIdx++) {
                        const img = entry.images[imgIdx];
                        
                        if (!img.tag || img.tag === 'Skip') continue; // Skip untagged and skipped images
                        
                        // Map tags to document types and sides
                        const { type, documentType, side } = mapTagToMetadata(img.tag);
                        
                        // Generate filename
                        const uploadDate = new Date().toLocaleString('en-GB', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit', 
                            hour12: false 
                        });
                        
                        // Convert Wix URL to public URL
                        const publicUrl = convertWixUrlToPublic(img.src);
                        const cacheKey = `${entry._id}-${imgIdx}`;
                        
                        // Check cache first
                        let blob, metadata;
                        if (imageCache.has(cacheKey)) {
                            console.log(`üì¶ Using cached blob for: ${entry.name} - Image ${imgIdx + 1}`);
                            const cached = imageCache.get(cacheKey);
                            blob = cached.blob;
                            metadata = cached.metadata;
                        } else {
                            // Fetch if not cached (fallback)
                            console.log(`‚è≥ Fetching (not cached): ${entry.name} - Image ${imgIdx + 1}`);
                            try {
                                const response = await fetch(publicUrl);
                                blob = await response.blob();
                                metadata = {
                                    type: blob.type || 'image/jpeg',
                                    size: blob.size,
                                    lastModified: Date.now()
                                };
                            } catch (error) {
                                console.error(`‚ùå Fetch failed for ${entry.name} - Image ${imgIdx + 1}:`, error);
                                throw error;
                            }
                        }
                            
                        uploadData.push({
                            entryId: entry._id,
                            type: type,
                            document: documentType,
                            side: side,
                            name: generateFileName(entry, documentType, side),
                            uploader: 'System transfer',
                            date: uploadDate,
                            url: publicUrl,
                            data: metadata,
                            blob: blob // Store blob for later upload (avoid re-fetching)
                        });
                    }
                }
                
                console.log(`‚úÖ Compiled upload data: ${uploadData.length} images (${imageCache.size} from cache)`);
                console.log('Upload data details:', uploadData);
                
                // Log message before posting
                console.log('üì§ Posting image-data to parent:', {
                    type: 'image-data',
                    images: uploadData.map(item => ({
                        entryId: item.entryId,
                        type: item.type,
                        document: item.document,
                        side: item.side,
                        name: item.name,
                        uploader: item.uploader,
                        date: item.date,
                        url: item.url,
                        data: item.data
                    })),
                    totalImages: uploadData.length
                });
                
                // Request PUT links from parent (matching image-viewer.html structure)
                window.parent.postMessage({
                    type: 'image-data',
                    images: uploadData.map(item => ({
                        entryId: item.entryId,
                        type: item.type,
                        document: item.document,
                        side: item.side,
                        name: item.name,
                        uploader: item.uploader,
                        date: item.date,
                        url: item.url,
                        data: item.data // Include metadata for backend validation
                        // blob is NOT sent (can't be serialized via postMessage)
                    })),
                    limit: currentLimit // Include current limit setting
                }, '*');
                
                // Update upload modal with file list
                showUploadModal(uploadData);
                
                // Store uploadData globally for use in uploadFilesToS3
                window.uploadDataWithBlobs = uploadData;
                
            } catch (error) {
                console.error('Error preparing upload data:', error);
                showErrorPopup('Failed to prepare images for upload. Please try again.');
                uploadModal.classList.add('hidden');
            }
        }

        function mapTagToMetadata(tag) {
            const map = {
                'Passport': { type: 'PhotoID', documentType: 'Passport', side: 'Single' },
                'Driving Licence Front': { type: 'PhotoID', documentType: 'Driving Licence', side: 'Front' },
                'Driving Licence Back': { type: 'PhotoID', documentType: 'Driving Licence', side: 'Back' },
                'Other Photo ID Single': { type: 'PhotoID', documentType: 'Other Photo ID Card', side: 'Single' },
                'Other Photo ID Front': { type: 'PhotoID', documentType: 'Other Photo ID Card', side: 'Front' },
                'Other Photo ID Back': { type: 'PhotoID', documentType: 'Other Photo ID Card', side: 'Back' },
                'Other': { type: 'AddressID', documentType: 'Address ID', side: 'Single' } // Migration: generic Address ID without specific type
            };
            return map[tag] || { type: 'AddressID', documentType: 'Unknown Document', side: 'Single' };
        }

        function generateFileName(entry, document, side) {
            const fe = String(entry.fe || '').replace(/\//g, '-');
            const clientNumber = String(entry.clientNumber || '').replace(/\//g, '-');
            const matterNumber = String(entry.matterNumber || '').replace(/\//g, '-');
            const name = String(entry.name || '').replace(/\//g, '-');
            
            const sideText = side !== 'Single' ? ` ${side}` : '';
            return `${fe}-${clientNumber}-${matterNumber} - ${name} - ${document}${sideText}`;
        }

        function showUploadModal(uploadData) {
            uploadModal.classList.remove('hidden');
            uploadStatus.textContent = `Uploading ${uploadData.length} files...`;
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            
            // Create file cards
            fileUploadList.innerHTML = '';
            uploadData.forEach((fileData, index) => {
                const card = document.createElement('div');
                card.className = 'file-upload-item';
                card.id = `file-${index}`;
                
                const entry = batchData.find(e => e._id === fileData.entryId);
                const entryName = entry ? `${entry.fe}-${entry.clientNumber}-${entry.matterNumber} - ${entry.name}` : 'Unknown Entry';
                
                card.innerHTML = `
                    <div class="file-upload-item-header">
                        <div class="file-upload-item-name">${fileData.name}</div>
                        <div class="file-upload-item-badge badge-pending" id="badge-${index}">Pending</div>
                    </div>
                    <div class="file-upload-item-details">
                        Entry: ${entryName}<br>
                        Document: ${fileData.document} ${fileData.side !== 'Single' ? '(' + fileData.side + ')' : ''}
                    </div>
                `;
                
                fileUploadList.appendChild(card);
            });
        }

        function handlePutLinks(data) {
            console.log('Received PUT links:', data);
            const links = data.links;
            const s3Keys = data.s3Keys;
            
            // Upload files to S3
            uploadFilesToS3(links, s3Keys);
        }

        function handlePutError(data) {
            console.error('PUT error:', data);
            uploadModal.classList.add('hidden');
            showErrorPopup(`Upload failed: ${data.error || data.message || 'Unknown error'}. Please review and try again.`);
            
            // Return to confirmation modal after error is dismissed
            setTimeout(() => {
                showConfirmModal();
            }, 3000);
        }

        async function uploadFilesToS3(links, s3Keys) {
            const total = links.length;
            const uploadDataWithBlobs = window.uploadDataWithBlobs || [];
            
            let completed = 0; // Track completions for progress bar
            
            console.log(`‚ö° Uploading ALL ${total} files simultaneously with Promise.all()`);
            
            // Create upload promise for each file
            const uploadPromises = uploadDataWithBlobs.map(async (uploadItem, index) => {
                const link = links[index];
                const blob = uploadItem.blob;
                const fileItem = document.getElementById(`file-${index}`);
                const badge = document.getElementById(`badge-${index}`);
                
                // Update to uploading state
                if (fileItem && badge) {
                    fileItem.classList.add('uploading');
                    badge.textContent = 'Uploading';
                    badge.className = 'file-upload-item-badge badge-uploading';
                }
                
                try {
                    if (!blob) {
                        throw new Error('Image data not found. Please refresh and try again.');
                    }
                    
                    // Upload to S3 using pre-fetched blob
                    const uploadResponse = await fetch(link, {
                        method: 'PUT',
                        body: blob,
                        headers: {
                            'Content-Type': blob.type || 'image/jpeg'
                        }
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error(`Upload failed with status ${uploadResponse.status}`);
                    }
                    
                    // Success
                    if (fileItem && badge) {
                        fileItem.classList.remove('uploading');
                        fileItem.classList.add('success');
                        badge.textContent = 'Success ‚úì';
                        badge.className = 'file-upload-item-badge badge-success';
                    }
                    
                    // Update progress bar as each file completes
                    completed++;
                    const percentage = Math.round((completed / total) * 100);
                    progressFill.style.width = `${percentage}%`;
                    progressFill.textContent = `${percentage}%`;
                    uploadStatus.textContent = `Uploading: ${completed} of ${total} files`;
                    
                    return { success: true, index };
                    
                } catch (error) {
                    console.error(`Upload error for file ${index}:`, error);
                    
                    // Error
                    if (fileItem && badge) {
                        fileItem.classList.remove('uploading');
                        fileItem.classList.add('error');
                        badge.textContent = 'Failed ‚úó';
                        badge.className = 'file-upload-item-badge badge-error';
                    }
                    
                    // Update progress bar even for errors
                    completed++;
                    const percentage = Math.round((completed / total) * 100);
                    progressFill.style.width = `${percentage}%`;
                    progressFill.textContent = `${percentage}%`;
                    uploadStatus.textContent = `Uploading: ${completed} of ${total} files`;
                    
                    return { success: false, index, error };
                }
            });
            
            // Upload ALL files simultaneously and wait for all to complete
            const results = await Promise.all(uploadPromises);
            
            // Count successes
            const successCount = results.filter(r => r.success).length;
            
            console.log(`‚úÖ All uploads complete: ${successCount}/${total} successful`);
            
            // All uploads complete
            if (successCount === total) {
                uploadStatus.textContent = '‚úÖ All files uploaded successfully!';
                
                // Compile results for parent
                const results = compileUploadResults(s3Keys);
                
                // Log message before posting
                console.log('üì§ Posting migration-complete to parent:', {
                    type: 'migration-complete',
                    updates: results,
                    batchNumber: currentBatchNumber,
                    totalUpdates: results.length
                });
                
                // Send success message to parent
                // Note: Upload modal will be closed when parent sends next migration-batch
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'migration-complete',
                        updates: results,
                        batchNumber: currentBatchNumber,
                        limit: currentLimit // Include current limit for next batch
                    }, '*');
                }, 1000);
            } else {
                uploadStatus.textContent = `‚ö†Ô∏è Upload completed with errors (${successCount}/${total} successful)`;
            }
        }

        function compileUploadResults(s3Keys) {
            const results = [];
            
            // Group s3Keys by entry ID
            const entriesMap = {};
            s3Keys.forEach(s3Key => {
                if (!entriesMap[s3Key.entryId]) {
                    entriesMap[s3Key.entryId] = [];
                }
                entriesMap[s3Key.entryId].push({
                    type: s3Key.type,
                    document: s3Key.document,
                    side: s3Key.side,
                    s3Key: s3Key.s3Key,
                    name: s3Key.name,
                    uploader: s3Key.uploader,
                    date: s3Key.date
                });
            });
            
            // Create result objects for bulkUpdate (not bulkSave to prevent duplicates)
            Object.keys(entriesMap).forEach(entryId => {
                // Validate _id exists and is a valid UUID/GUID format
                if (!entryId || entryId === 'undefined' || entryId === 'null') {
                    console.error('‚ö†Ô∏è Invalid entry ID detected:', entryId);
                    return;
                }
                
                const updateObject = {
                    _id: entryId,
                    idImages: entriesMap[entryId],
                    imagesTransferred: true
                };
                
                // Log each update object for debugging
                console.log('üìã Update object for entry:', {
                    _id: entryId,
                    imageCount: entriesMap[entryId].length,
                    images: entriesMap[entryId]
                });
                
                results.push(updateObject);
            });
            
            // Final validation log
            console.log('‚úÖ Compiled results for bulkUpdate:', {
                totalEntries: results.length,
                entryIds: results.map(r => r._id),
                results: results
            });
            
            return results;
        }

        /*
        =====================================================================
        Error Handling from Parent
        =====================================================================
        */
        function handleBackendError(data) {
            console.error('Backend error:', data);
            showErrorPopup(`Backend Error: ${data.message || 'Unknown error occurred'}`);
            
            // Hide upload modal if it's showing
            uploadModal.classList.add('hidden');
        }

        function handleNetworkError(data) {
            console.error('Network error:', data);
            showErrorPopup(`Network Error: ${data.message || 'Connection failed'}. Please check your connection and try again.`);
            
            // Hide upload modal if it's showing
            uploadModal.classList.add('hidden');
        }

        function showErrorPopup(message) {
            const errorPopup = document.getElementById('errorPopup');
            const errorMessageEl = document.getElementById('errorMessage');
            
            if (errorMessageEl) {
                errorMessageEl.textContent = message;
            }
            if (errorPopup) {
                errorPopup.classList.remove('hidden');
            }
        }

        function hideErrorPopup() {
            const errorPopup = document.getElementById('errorPopup');
            if (errorPopup) {
                errorPopup.classList.add('hidden');
            }
        }

        /*
        =====================================================================
        Confirmation Modal Functions
        =====================================================================
        */
        function showConfirmModal() {
            // Count tagged images (excluding skipped)
            let totalToUpload = 0;
            let skippedCount = 0;
            
            batchData.forEach(entry => {
                entry.images.forEach(img => {
                    if (img.tag === 'Skip') {
                        skippedCount++;
                    } else if (img.tag) {
                        totalToUpload++;
                    }
                });
            });
            
            // Update summary
            confirmSummary.textContent = `${totalToUpload} images will be uploaded${skippedCount > 0 ? ` (${skippedCount} skipped)` : ''}`;
            
            // Build confirmation cards
            confirmCardsContainer.innerHTML = '';
            
            batchData.forEach((entry, entryIdx) => {
                // Only show entries with tagged images (excluding skipped)
                const taggedImages = entry.images.filter(img => img.tag && img.tag !== 'Skip');
                
                if (taggedImages.length === 0) return;
                
                const card = document.createElement('div');
                card.className = 'confirm-card';
                
                const imageCount = taggedImages.length;
                const skippedInEntry = entry.images.filter(img => img.tag === 'Skip').length;
                
                card.innerHTML = `
                    <div class="confirm-card-header">
                        <div class="confirm-card-title">${entry.fe}-${entry.clientNumber}-${entry.matterNumber} - ${entry.name}</div>
                        <div class="confirm-card-count">${imageCount} image${imageCount !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="confirm-image-list" id="confirm-entry-${entryIdx}"></div>
                `;
                
                confirmCardsContainer.appendChild(card);
                
                const imageList = card.querySelector(`#confirm-entry-${entryIdx}`);
                
                entry.images.forEach((img, imgIdx) => {
                    if (!img.tag || img.tag === 'Skip') return; // Don't show untagged or skipped
                    
                    const imageItem = document.createElement('div');
                    imageItem.className = 'confirm-image-item';
                    imageItem.style.cursor = 'pointer';
                    imageItem.onclick = () => jumpToImageFromConfirm(entryIdx, imgIdx);
                    
                    const tagClass = img.tag === 'Skip' ? 'skip' : '';
                    const { type, documentType, side } = mapTagToMetadata(img.tag);
                    const fileName = generateFileName(entry, documentType, side);
                    
                    // Tag text for confirmation: show Front/Back, or "Ignore" for skipped, hide "Single"
                    let tagText = img.tag === 'Skip' ? 'Ignore' : (side !== 'Single' ? side : '');
                    
                    imageItem.innerHTML = `
                        <img class="confirm-image-thumb" src="${img.src}" alt="${fileName}">
                        <div class="confirm-image-info">
                            <div><strong>${fileName}</strong></div>
                            <div style="color: #666; font-size: 0.75rem; margin-top: 2px;">Click to re-tag</div>
                        </div>
                        ${tagText ? `<div class="confirm-image-tag ${tagClass}">${tagText}</div>` : ''}
                    `;
                    
                    imageList.appendChild(imageItem);
                });
            });
            
            // Show modal
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        function jumpToImageFromConfirm(entryIdx, imgIdx) {
            // Set flag to re-show modal when tagging is complete
            window.confirmModalWasOpen = true;
            
            // Hide modal
            hideConfirmModal();
            
            // Jump to the image
            currentEntryIndex = entryIdx;
            currentImageIndex = imgIdx;
            renderLeftPanel();
            updateDisplay();
            updateProgressInfo();
            scrollToActiveEntry();
        }

        function confirmAndUpload() {
            // Hide confirmation modal
            hideConfirmModal();
            
            // Proceed with upload
            uploadToS3();
        }

        /*
        =====================================================================
        Begin Button - Fetch Data from Parent
        =====================================================================
        */
        function fetchDataFromParent() {
            const limit = parseInt(limitInput.value, 10) || 10;
            
            // Validate limit
            if (limit < 1 || limit > 10) {
                showErrorPopup('Please enter a number between 1 and 10.');
                return;
            }
            
            console.log('üì§ Requesting data from parent with limit:', limit);
            
            // Hide all sections and show loading state
            mainInterface.classList.add('hidden');
            noDataState.classList.add('hidden');
            beginControls.classList.add('hidden');
            progressInfo.classList.add('hidden');
            loadingState.classList.remove('hidden');
            
            // Clear current data
            batchData = null;
            currentEntryIndex = 0;
            currentImageIndex = 0;
            imageCache.clear();
            
            // Send fetch-data message to parent
            window.parent.postMessage({
                type: 'fetch-data',
                limit: currentLimit
            }, '*');
        }

        beginBtn.addEventListener('click', () => {
            console.log('Begin button clicked');
            // Update stored limit
            currentLimit = parseInt(limitInput.value, 10) || 10;
            console.log('Current limit set to:', currentLimit);
            fetchDataFromParent();
        });

        // Initialize
        console.log('Migration tagger loaded and ready');
        console.log('Begin button element:', beginBtn);
        console.log('Limit input element:', limitInput);
    </script>
</body>
</html>

