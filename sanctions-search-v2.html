<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FCDO UK Sanctions List Search</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <!-- jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <!-- MOCK XML DATA: Paste full XML response here for testing -->
  <script id="mockSanctionsXML" type="application/xml">
    <!-- Paste XML content here for testing -->
  </script>
  
  <style>
    /*
    =====================================================================
    CUSTOM FONTS - Base64 Embedded with Google Fonts Fallback
    =====================================================================
    Transport Medium â†’ fallback to Quicksand Bold (700)
    Rotis fonts â†’ fallback to Quicksand Regular (400/600)
    =====================================================================
    */
    
    /* Transport Medium - for headings and buttons */
    @font-face {
      font-family: 'Transport';
      font-weight: 500;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0000-003F, U+0041-FFFF;
      src: url(data:font/truetype;charset=utf-8;base64,) format('truetype');
    }
    
    /* Rotis Sans Serif Regular - for body text */
    @font-face {
      font-family: 'RotisRegular';
      font-weight: 300;
      font-style: normal;
      font-display: swap;
      src: url(data:font/truetype;charset=utf-8;base64,) format('opentype');
    }
    
    /* Rotis Sans Serif Italic - for timestamps */
    @font-face {
      font-family: 'RotisItalic';
      font-weight: 400;
      font-style: italic;
      font-display: swap;
      src: url(data:font/truetype;charset=utf-8;base64,) format('opentype');
    }
    
    /* Rotis Sans Serif Bold - for emphasis */
    @font-face {
      font-family: 'RotisBold';
      font-weight: 700;
      font-style: normal;
      font-display: swap;
      src: url(data:font/truetype;charset=utf-8;base64,) format('truetype');
    }
    
    /*
    =====================================================================
    FCDO SANCTIONS SEARCH IFRAME - XML VERSION
    =====================================================================
    Searches the live FCDO UK Sanctions List (XML format) for client name matches.
    Generates PDF report and uploads to S3 using document-viewer.html pattern.
    =====================================================================
    */
    
    /* CSS Variables */
    :root { 
      --primary: rgb(0, 60, 113); 
      --tan: #D4A574;
      --error: #e02424;
      --success: #10a37f;
      --warning: #ffa500;
    }
    
    /* Global reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'RotisRegular', 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: transparent; 
      color: #111; 
      padding: 0; 
      margin: 0; 
      line-height: 1.5;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Fixed header */
    .header {
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--primary) 0%, #004080 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-family: 'Transport', 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 24px;
      margin: 0;
    }
    
    .header .subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 5px;
    }
    
    /* Scrollable content area */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      min-height: 0;
    }
    
    /* Search form section */
    .search-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-family: 'RotisBold', 'Quicksand', sans-serif;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--primary);
    }
    
    .form-group input[type="text"],
    .form-group input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'RotisRegular', 'Quicksand', sans-serif;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
    }
    
    /* Results section */
    .results-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    
    .results-section.visible {
      display: block;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--tan);
    }
    
    .results-header h2 {
      font-family: 'Transport', 'Quicksand', sans-serif;
      font-weight: 700;
      color: var(--primary);
      font-size: 20px;
    }
    
    .results-count {
      font-size: 14px;
      color: #666;
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .results-table th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
      font-family: 'RotisBold', 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 13px;
    }
    
    .results-table td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
    }
    
    .results-table tr:hover {
      background: #f5f5f5;
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    
    .no-results .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    /* Status messages */
    .status-message {
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.visible {
      display: block;
    }
    
    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }
    
    .status-message.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .status-message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #2e7d32;
    }
    
    .status-message.warning {
      background: #fff3e0;
      color: #e65100;
      border-left: 4px solid #e65100;
    }
    
    /* Fixed footer */
    .footer {
      flex-shrink: 0;
      background: #f5f5f5;
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    /* Buttons */
    .btn {
      font-family: 'Transport', 'Quicksand', sans-serif;
      font-weight: 700;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #004080;
    }
    
    .btn-secondary {
      background: var(--tan);
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #c49563;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #0d8c6d;
    }
    
    .btn-cancel {
      background: #888;
      color: white;
    }
    
    .btn-cancel:hover:not(:disabled) {
      background: #666;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 20px;
      }
      
      .content {
        padding: 15px;
      }
      
      .footer {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Fixed Header -->
  <div class="header">
    <h1>ðŸ” FCDO UK Sanctions List Search</h1>
    <div class="subtitle">Search the UK Sanctions List for matches</div>
  </div>

  <!-- Scrollable Content -->
  <div class="content">
    <!-- Status Message -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Search Form -->
    <div class="search-section">
      <div class="form-group">
        <label for="clientName">Client Name *</label>
        <input 
          type="text" 
          id="clientName" 
          placeholder="Enter full name or partial name"
          required
        />
      </div>

      <div class="form-group">
        <label for="clientDOB">Date of Birth (Optional)</label>
        <input 
          type="date" 
          id="clientDOB"
        />
      </div>

      <div class="checkbox-group">
        <input 
          type="checkbox" 
          id="fuzzySearch" 
          checked
        />
        <label for="fuzzySearch">Enable fuzzy matching (allows minor spelling differences)</label>
      </div>

      <div class="checkbox-group">
        <input 
          type="checkbox" 
          id="fuzzyDOB"
        />
        <label for="fuzzyDOB">Enable fuzzy DOB matching (Â±5 years)</label>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="results-section">
      <div class="results-header">
        <h2>Search Results</h2>
        <span id="resultsCount" class="results-count"></span>
      </div>
      <div id="resultsContainer">
        <!-- Results will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Fixed Footer -->
  <div class="footer">
    <button id="searchBtn" class="btn btn-primary">
      Search Sanctions List
    </button>
    <button id="generatePdfBtn" class="btn btn-success" disabled>
      Generate & Upload PDF Report
    </button>
    <button id="cancelBtn" class="btn btn-cancel">
      Cancel
    </button>
  </div>

  <script>
    /*
    =====================================================================
    FCDO SANCTIONS SEARCH - XML VERSION
    =====================================================================
    Features:
    - Fuzzy name matching with configurable threshold
    - Optional DOB matching (exact or fuzzy Â±5 years)
    - PDF generation with jsPDF
    - S3 upload via parent postMessage (same pattern as document-viewer.html)
    - Mock data support for testing
    =====================================================================
    */

    // ========== CONFIGURATION ==========
    const USE_MOCK_DATA = true; // Set to true to use mock XML data below
    
    // ========== STATE ==========
    let sanctionsList = []; // Parsed sanctions list
    let searchResults = []; // Current search results
    let clientData = null; // Client data from parent

    // ========== DOM ELEMENTS ==========
    const clientNameInput = document.getElementById('clientName');
    const clientDOBInput = document.getElementById('clientDOB');
    const fuzzySearchCheckbox = document.getElementById('fuzzySearch');
    const fuzzyDOBCheckbox = document.getElementById('fuzzyDOB');
    const searchBtn = document.getElementById('searchBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusMessage = document.getElementById('statusMessage');
    const resultsSection = document.getElementById('resultsSection');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsCount = document.getElementById('resultsCount');

    // ========== UTILITY FUNCTIONS ==========
    
    /**
     * Show status message
     */
    function showStatus(message, type = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} visible`;
      setTimeout(() => {
        statusMessage.classList.remove('visible');
      }, 5000);
    }

    /**
     * Levenshtein distance for fuzzy matching
     */
    function levenshteinDistance(a, b) {
      const an = a ? a.length : 0;
      const bn = b ? b.length : 0;
      if (an === 0) return bn;
      if (bn === 0) return an;
      
      const matrix = [];
      for (let i = 0; i <= bn; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= an; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= bn; i++) {
        for (let j = 1; j <= an; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      
      return matrix[bn][an];
    }

    /**
     * Calculate similarity percentage
     */
    function calculateSimilarity(str1, str2) {
      const longer = str1.length > str2.length ? str1 : str2;
      const shorter = str1.length > str2.length ? str2 : str1;
      const longerLength = longer.length;
      
      if (longerLength === 0) return 1.0;
      
      const distance = levenshteinDistance(longer, shorter);
      return (longerLength - distance) / longerLength;
    }

    /**
     * Normalize name for comparison
     */
    function normalizeName(name) {
      if (!name) return '';
      return name.toLowerCase().trim().replace(/\s+/g, ' ');
    }

    /**
     * Parse XML and extract sanctions entries
     */
    function parseXML(xmlString) {
      console.log('ðŸ“„ Parsing XML sanctions list...');
      
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
      
      // Check for parser errors
      const parserError = xmlDoc.querySelector('parsererror');
      if (parserError) {
        console.error('âŒ XML parsing error:', parserError.textContent);
        throw new Error('Failed to parse XML: ' + parserError.textContent);
      }
      
      const entries = [];
      const designations = xmlDoc.querySelectorAll('Designation');
      
      console.log(`Found ${designations.length} designations in XML`);
      
      designations.forEach((designation, index) => {
        try {
          // Extract basic info
          const uniqueId = designation.querySelector('uniqueID')?.textContent || '';
          const entityType = designation.querySelector('entityType')?.textContent || '';
          
          // Extract regime info
          const regimes = [];
          designation.querySelectorAll('Regime').forEach(regime => {
            regimes.push({
              name: regime.querySelector('regimeName')?.textContent || '',
              sanctions: regime.querySelector('sanctionsImposed')?.textContent || '',
              dateDesignated: regime.querySelector('dateDesignated')?.textContent || '',
              lastUpdated: regime.querySelector('lastUpdated')?.textContent || ''
            });
          });
          
          // Extract names
          const names = [];
          designation.querySelectorAll('name').forEach(name => {
            const nameObj = {
              fullName: '',
              firstName: name.querySelector('name1')?.textContent || '',
              middleName: name.querySelector('name2')?.textContent || '',
              lastName: name.querySelector('name6')?.textContent || '',
              nameType: name.querySelector('nameType')?.textContent || '',
              title: name.querySelector('title')?.textContent || ''
            };
            
            // Build full name
            nameObj.fullName = [nameObj.firstName, nameObj.middleName, nameObj.lastName]
              .filter(n => n)
              .join(' ');
            
            if (nameObj.fullName) {
              names.push(nameObj);
            }
          });
          
          // Extract DOB
          const dobElement = designation.querySelector('dob');
          const dob = dobElement?.textContent || '';
          
          // Extract addresses
          const addresses = [];
          designation.querySelectorAll('address').forEach(addr => {
            const address = {
              line1: addr.querySelector('addressLine1')?.textContent || '',
              line2: addr.querySelector('addressLine2')?.textContent || '',
              city: addr.querySelector('addressLine4')?.textContent || '',
              country: addr.querySelector('country')?.textContent || ''
            };
            addresses.push(address);
          });
          
          // Extract positions
          const positions = [];
          designation.querySelectorAll('position').forEach(pos => {
            const position = pos.textContent?.trim();
            if (position) positions.push(position);
          });
          
          // Create entry
          if (names.length > 0) {
            entries.push({
              uniqueId,
              entityType,
              names,
              dob,
              regimes,
              addresses,
              positions
            });
          }
          
        } catch (error) {
          console.error(`Error parsing designation ${index}:`, error);
        }
      });
      
      console.log(`âœ… Parsed ${entries.length} valid entries from XML`);
      return entries;
    }

    /**
     * Load sanctions list from backend or mock data
     */
    async function loadSanctionsList() {
      try {
        showStatus('Loading sanctions list...', 'info');
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="spinner"></span>Loading...';
        
        let xmlString;
        
        if (USE_MOCK_DATA) {
          console.log('ðŸ“¦ Using mock XML data');
          const mockScript = document.getElementById('mockSanctionsXML');
          xmlString = mockScript.textContent;
          
          if (!xmlString || xmlString.trim() === '<!-- Paste XML content here for testing -->') {
            throw new Error('Mock XML data is empty. Please paste XML content.');
          }
        } else {
          console.log('ðŸŒ Requesting XML from backend...');
          
          // Request XML from parent (which will call backend)
          return new Promise((resolve, reject) => {
            const requestId = Date.now();
            
            const handleResponse = (event) => {
              if (event.data.type === 'sanctions-xml-response' && event.data.requestId === requestId) {
                window.removeEventListener('message', handleResponse);
                
                if (event.data.success) {
                  xmlString = event.data.xml;
                  console.log(`âœ… Received ${xmlString.length} characters XML from backend`);
                  
                  sanctionsList = parseXML(xmlString);
                  showStatus(`âœ… Loaded ${sanctionsList.length} sanctions entries`, 'success');
                  
                  searchBtn.disabled = false;
                  searchBtn.textContent = 'Search Sanctions List';
                  
                  resolve();
                } else {
                  throw new Error(event.data.error || 'Failed to load sanctions list');
                }
              }
            };
            
            window.addEventListener('message', handleResponse);
            
            window.parent.postMessage({
              type: 'request-sanctions-xml',
              requestId: requestId
            }, '*');
            
            // Timeout after 30 seconds
            setTimeout(() => {
              window.removeEventListener('message', handleResponse);
              reject(new Error('Request timeout'));
            }, 30000);
          });
        }
        
        // Parse XML
        sanctionsList = parseXML(xmlString);
        showStatus(`âœ… Loaded ${sanctionsList.length} sanctions entries`, 'success');
        
      } catch (error) {
        console.error('âŒ Error loading sanctions list:', error);
        showStatus(`âŒ Error: ${error.message}`, 'error');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search Sanctions List';
      }
    }

    /**
     * Search sanctions list
     */
    function searchSanctions() {
      const searchName = clientNameInput.value.trim();
      const searchDOB = clientDOBInput.value;
      const useFuzzy = fuzzySearchCheckbox.checked;
      const useFuzzyDOB = fuzzyDOBCheckbox.checked;
      
      if (!searchName) {
        showStatus('Please enter a client name', 'warning');
        return;
      }
      
      if (sanctionsList.length === 0) {
        showStatus('Sanctions list not loaded. Please try again.', 'error');
        return;
      }
      
      console.log(`ðŸ” Searching for: "${searchName}"${searchDOB ? ` (DOB: ${searchDOB})` : ''}`);
      
      searchResults = [];
      const normalizedSearch = normalizeName(searchName);
      const fuzzyThreshold = 0.75; // 75% similarity required
      
      sanctionsList.forEach(entry => {
        let bestMatch = null;
        let bestScore = 0;
        
        // Check all names
        entry.names.forEach(nameObj => {
          const fullName = normalizeName(nameObj.fullName);
          
          // Exact match
          if (fullName === normalizedSearch) {
            bestMatch = { type: 'exact', score: 1.0, name: nameObj.fullName };
            bestScore = 1.0;
            return;
          }
          
          // Substring match
          if (fullName.includes(normalizedSearch) || normalizedSearch.includes(fullName)) {
            const score = 0.9;
            if (score > bestScore) {
              bestMatch = { type: 'substring', score, name: nameObj.fullName };
              bestScore = score;
            }
          }
          
          // Fuzzy match
          if (useFuzzy) {
            const similarity = calculateSimilarity(normalizedSearch, fullName);
            if (similarity >= fuzzyThreshold && similarity > bestScore) {
              bestMatch = { type: 'fuzzy', score: similarity, name: nameObj.fullName };
              bestScore = similarity;
            }
            
            // Try first name + last name
            const firstName = normalizeName(nameObj.firstName);
            const lastName = normalizeName(nameObj.lastName);
            const firstLast = `${firstName} ${lastName}`.trim();
            
            if (firstLast) {
              const flSimilarity = calculateSimilarity(normalizedSearch, firstLast);
              if (flSimilarity >= fuzzyThreshold && flSimilarity > bestScore) {
                bestMatch = { type: 'fuzzy-fl', score: flSimilarity, name: nameObj.fullName };
                bestScore = flSimilarity;
              }
            }
          }
        });
        
        // If we have a name match, check DOB if provided
        if (bestMatch) {
          let dobMatch = true;
          
          if (searchDOB && entry.dob) {
            const searchYear = new Date(searchDOB).getFullYear();
            
            // Try to extract year from entry DOB (format could be DD/MM/YYYY or YYYY)
            let entryYear = null;
            if (entry.dob.includes('/')) {
              const parts = entry.dob.split('/');
              if (parts.length === 3) {
                entryYear = parseInt(parts[2]);
              }
            } else {
              entryYear = parseInt(entry.dob);
            }
            
            if (entryYear) {
              if (useFuzzyDOB) {
                dobMatch = Math.abs(searchYear - entryYear) <= 5;
              } else {
                dobMatch = searchYear === entryYear;
              }
            }
          }
          
          if (dobMatch) {
            searchResults.push({
              ...entry,
              matchType: bestMatch.type,
              matchScore: bestMatch.score,
              matchedName: bestMatch.name
            });
          }
        }
      });
      
      // Sort by match score (highest first)
      searchResults.sort((a, b) => b.matchScore - a.matchScore);
      
      console.log(`âœ… Found ${searchResults.length} matches`);
      displayResults();
    }

    /**
     * Display search results
     */
    function displayResults() {
      resultsSection.classList.add('visible');
      resultsCount.textContent = `${searchResults.length} match${searchResults.length !== 1 ? 'es' : ''} found`;
      
      if (searchResults.length === 0) {
        resultsContainer.innerHTML = `
          <div class="no-results">
            <div class="icon">âœ…</div>
            <div>No matches found in the sanctions list</div>
          </div>
        `;
        generatePdfBtn.disabled = false; // Allow generating "no match" PDF
        generatePdfBtn.textContent = 'Generate "No Match" PDF';
        return;
      }
      
      // Build table
      let html = `
        <table class="results-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>DOB</th>
              <th>Regime</th>
              <th>Match</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      searchResults.forEach(result => {
        const regime = result.regimes[0] || {};
        const matchPercentage = (result.matchScore * 100).toFixed(0);
        
        html += `
          <tr>
            <td><strong>${result.matchedName}</strong></td>
            <td>${result.entityType}</td>
            <td>${result.dob || 'N/A'}</td>
            <td>${regime.name || 'N/A'}</td>
            <td>${matchPercentage}%</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      resultsContainer.innerHTML = html;
      generatePdfBtn.disabled = false;
      generatePdfBtn.textContent = 'Generate & Upload PDF Report';
    }

    /**
     * Generate PDF report
     */
    async function generatePDF() {
      try {
        showStatus('Generating PDF...', 'info');
        generatePdfBtn.disabled = true;
        generatePdfBtn.innerHTML = '<span class="spinner"></span>Generating...';
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // TH Branding
        doc.setFillColor(0, 60, 113);
        doc.rect(0, 0, 210, 30, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text('Thurstan Hoskin', 105, 12, { align: 'center' });
        
        doc.setFontSize(14);
        doc.text('FCDO UK Sanctions List Search', 105, 22, { align: 'center' });
        
        // Search parameters
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text('Search Parameters:', 14, 40);
        
        doc.setFontSize(10);
        doc.text(`Client Name: ${clientNameInput.value}`, 14, 48);
        doc.text(`Date of Birth: ${clientDOBInput.value || 'Not provided'}`, 14, 54);
        doc.text(`Fuzzy Matching: ${fuzzySearchCheckbox.checked ? 'Enabled' : 'Disabled'}`, 14, 60);
        doc.text(`Search Date: ${new Date().toLocaleString('en-GB')}`, 14, 66);
        
        // Results
        doc.setFontSize(12);
        doc.text(`Results: ${searchResults.length} match${searchResults.length !== 1 ? 'es' : ''} found`, 14, 76);
        
        if (searchResults.length > 0) {
          // Table
          const tableData = searchResults.map(result => {
            const regime = result.regimes[0] || {};
            return [
              result.matchedName,
              result.entityType,
              result.dob || 'N/A',
              regime.name || 'N/A',
              `${(result.matchScore * 100).toFixed(0)}%`
            ];
          });
          
          doc.autoTable({
            startY: 82,
            head: [['Name', 'Type', 'DOB', 'Regime', 'Match']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: [0, 60, 113] },
            styles: { fontSize: 9 }
          });
        } else {
          doc.setFontSize(10);
          doc.text('âœ… No matches found in the UK Sanctions List', 14, 86);
        }
        
        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(128, 128, 128);
          doc.text(`Page ${i} of ${pageCount}`, 105, 285, { align: 'center' });
          doc.text('This report is generated automatically and should be reviewed by a compliance officer.', 105, 290, { align: 'center' });
        }
        
        const pdfBlob = doc.output('blob');
        console.log('âœ… PDF generated, size:', pdfBlob.size, 'bytes');
        
        // Request S3 upload URL from parent
        await uploadPDFToS3(pdfBlob);
        
      } catch (error) {
        console.error('âŒ Error generating PDF:', error);
        showStatus(`âŒ Error: ${error.message}`, 'error');
        generatePdfBtn.disabled = false;
        generatePdfBtn.textContent = 'Generate & Upload PDF Report';
      }
    }

    /**
     * Upload PDF to S3 via parent postMessage
     */
    async function uploadPDFToS3(pdfBlob) {
      return new Promise((resolve, reject) => {
        const requestId = Date.now();
        
        const handleResponse = (event) => {
          if (event.data.type === 's3-upload-url-response' && event.data.requestId === requestId) {
            window.removeEventListener('message', handleResponse);
            
            if (event.data.success) {
              uploadToPresignedURL(event.data.uploadUrl, pdfBlob, event.data.metadata)
                .then(resolve)
                .catch(reject);
            } else {
              reject(new Error(event.data.error || 'Failed to get upload URL'));
            }
          }
        };
        
        window.addEventListener('message', handleResponse);
        
        // Request upload URL from parent
        window.parent.postMessage({
          type: 'request-s3-upload-url',
          requestId: requestId,
          uploadType: 'sanctions-pdf',
          documentType: 'FCDO Sanctions Search',
          category: 'PEP & Sanctions Check',
          metadata: {
            searchName: clientNameInput.value,
            searchDOB: clientDOBInput.value || null,
            resultsCount: searchResults.length,
            searchDate: new Date().toISOString()
          }
        }, '*');
        
        // Timeout after 30 seconds
        setTimeout(() => {
          window.removeEventListener('message', handleResponse);
          reject(new Error('Request timeout'));
        }, 30000);
      });
    }

    /**
     * Upload to presigned S3 URL
     */
    async function uploadToPresignedURL(uploadUrl, blob, metadata) {
      try {
        showStatus('Uploading PDF to S3...', 'info');
        
        const response = await fetch(uploadUrl, {
          method: 'PUT',
          body: blob,
          headers: {
            'Content-Type': 'application/pdf'
          }
        });
        
        if (!response.ok) {
          throw new Error(`S3 upload failed: ${response.status}`);
        }
        
        console.log('âœ… PDF uploaded to S3');
        
        // Notify parent of completion
        window.parent.postMessage({
          type: 'sanctions-search-complete',
          success: true,
          metadata: metadata
        }, '*');
        
        showStatus('âœ… PDF uploaded successfully!', 'success');
        
        // Close after 2 seconds
        setTimeout(() => {
          window.parent.postMessage({ type: 'close-lightbox' }, '*');
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Error uploading to S3:', error);
        showStatus(`âŒ Upload error: ${error.message}`, 'error');
        throw error;
      }
    }

    // ========== EVENT LISTENERS ==========
    
    searchBtn.addEventListener('click', searchSanctions);
    
    generatePdfBtn.addEventListener('click', generatePDF);
    
    cancelBtn.addEventListener('click', () => {
      window.parent.postMessage({ type: 'close-lightbox' }, '*');
    });
    
    // Allow Enter key to trigger search
    clientNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !searchBtn.disabled) {
        searchSanctions();
      }
    });

    // ========== INITIALIZATION ==========
    
    // Listen for client data from parent
    window.addEventListener('message', (event) => {
      if (event.data.type === 'sanctions-client-data') {
        console.log('ðŸ“¬ Received client data from parent:', event.data);
        clientData = event.data;
        
        // Pre-fill form
        if (clientData.name) {
          clientNameInput.value = clientData.name;
        }
        if (clientData.dob) {
          clientDOBInput.value = clientData.dob;
        }
      }
    });
    
    // Request client data from parent
    console.log('ðŸ“¤ Requesting client data from parent...');
    window.parent.postMessage({ type: 'request-sanctions-client-data' }, '*');
    
    // Load sanctions list on startup
    loadSanctionsList();
    
    console.log('âœ… FCDO Sanctions Search initialized');
  </script>
<!-- IFRAME_VERSION START -->
<script>
  (function() {
    window.__IFRAME_VERSION__ = '37b167e';
    console.log('[sanctions-search-v2] version ' + window.__IFRAME_VERSION__);
  })();
</script>
<!-- IFRAME_VERSION END -->
</body>
</html>


