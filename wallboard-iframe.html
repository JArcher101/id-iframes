<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallboard</title>
    
    <!-- Google Fonts - Quicksand as fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /*
        =====================================================================
        CUSTOM FONTS - Base64 Embedded with Google Fonts Fallback
        =====================================================================
        Transport Medium → fallback to Quicksand Bold (700)
        Rotis fonts → fallback to Quicksand Regular (400) or Italic
        =====================================================================
        */
        
        /* Transport Medium - for headings and buttons */
        @font-face {
            font-family: 'Transport';
            font-weight: 500;
            font-style: normal;
            font-display: swap;
            unicode-range: U+0000-003F, U+0041-FFFF;
            src: url(data:font/truetype;charset=utf-8;base64,) format('truetype');
        }
        
        /* Rotis Sans Serif Regular - for body text */
        @font-face {
            font-family: 'RotisRegular';
            font-weight: 300;
            font-style: normal;
            font-display: swap;
            src: url(data:font/truetype;charset=utf-8;base64,) format('opentype');
        }
        
        /* Rotis Sans Serif Italic - for timestamps */
        @font-face {
            font-family: 'RotisItalic';
            font-weight: 400;
            font-style: italic;
            font-display: swap;
            src: url(data:font/truetype;charset=utf-8;base64,) format('opentype');
        }
        
        /* Rotis Sans Serif Extra Bold - for table headers */
        @font-face {
            font-family: 'RotisBold';
            font-weight: 700;
            font-style: normal;
            font-display: swap;
            src: url(data:font/truetype;charset=utf-8;base64,) format('truetype');
        }
        
        /*
        =====================================================================
        WALLBOARD IFRAME - STYLE SECTION
        =====================================================================
        This iframe displays ID system metrics in a table format with
        controls for refreshing data, viewing analytics, and downloading PDF reports.
        
        COMMUNICATION ARCHITECTURE:
        - Parent sends: 'wallboard-data' with metrics and dropdown options
        - Child sends: 'refresh-request'
        - Child downloads: PDF report (no parent communication needed)
        
        VIEWS:
        1. WALLBOARD VIEW - Table of metrics by fee earner
        2. ANALYTICS VIEW - Charts breakdown for selected fee earner
        =====================================================================
        */
        
        /* Global reset */
        * { 
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: white;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'RotisRegular', 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* 
        =====================================================================
        CONTAINER & LAYOUT
        =====================================================================
        */
        .wallboard-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 900px;
            max-width: 100%;
            background: white;
            margin: 0 auto;
        }

        /* 
        =====================================================================
        HEADER SECTION - Controls and countdown
        =====================================================================
        */
        .header {
            background: #f5f5f5;
            border-bottom: 2px solid #D4A574; /* Pantone 451C */
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-title {
            font-family: 'Transport', 'Quicksand', sans-serif;
            font-size: 24px;
            font-weight: 500;
            color: rgb(0, 60, 113); /* Brand navy blue */
            margin: 0;
        }

        .countdown-text {
            font-family: 'RotisItalic', 'Quicksand', sans-serif;
            font-size: 14px;
            font-style: italic;
            color: #666;
            margin-left: auto;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Button styles */
        .btn {
            font-family: 'Transport', 'Quicksand', sans-serif;
            background: rgb(0, 60, 113);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            background: rgb(0, 40, 80);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #D4A574; /* Pantone 451C */
        }

        .btn-secondary:hover:not(:disabled) {
            background: #b88e5d;
        }

        .btn-mock {
            background: #28a745 !important;
            margin-left: auto;
        }

        .btn-mock:hover:not(:disabled) {
            background: #218838 !important;
        }

        /* Dropdown styles */
        .dropdown {
            font-family: 'RotisRegular', 'Quicksand', sans-serif;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            color: rgb(0, 60, 113);
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        .dropdown:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #999;
        }

        .dropdown:focus {
            outline: none;
            border-color: rgb(0, 60, 113);
            box-shadow: 0 0 0 2px rgba(0, 60, 113, 0.2);
        }

        /* 
        =====================================================================
        WALLBOARD VIEW - Metrics table
        =====================================================================
        */
        .view-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .wallboard-view {
            display: block;
        }

        .analytics-view {
            display: none;
        }

        /* Table styles */
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .metrics-table thead {
            background: rgb(0, 60, 113); /* Brand navy blue */
            color: white;
        }

        .metrics-table th {
            font-family: 'RotisBold', 'Quicksand', sans-serif;
            font-weight: 700;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .metrics-table th:first-child {
            text-align: left;
            min-width: 200px;
        }

        .metrics-table th:not(:first-child) {
            text-align: center;
        }

        .metrics-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
        }

        .metrics-table tbody tr:hover {
            background: #f9f9f9;
        }

        .metrics-table tbody tr:last-child {
            border-bottom: none;
        }

        .metrics-table td {
            font-family: 'RotisRegular', 'Quicksand', sans-serif;
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .metrics-table td:first-child {
            font-weight: 600;
            color: rgb(0, 60, 113);
            text-align: left;
            cursor: pointer;
        }

        .metrics-table th:first-child {
            cursor: default;
        }

        .metrics-table td:not(:first-child) {
            text-align: center;
            font-weight: 400;
        }

        /* Alternate row coloring */
        .metrics-table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .metrics-table tbody tr:nth-child(even):hover {
            background: #f5f5f5;
        }

        /* Hover highlighting effects */
        .metrics-table th.column-highlight {
            background: #003a71 !important; /* Darker navy for column header highlight */
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 60, 113, 0.3);
        }

        .metrics-table td.column-highlight {
            background: rgba(0, 60, 113, 0.1) !important;
            font-weight: 600;
        }

        .metrics-table tr.row-highlight td {
            background: rgba(212, 165, 116, 0.15) !important; /* Tan highlight */
            font-weight: 600;
        }

        .metrics-table td.cell-highlight {
            background: rgba(0, 60, 113, 0.25) !important;
            font-weight: 700;
            color: rgb(0, 60, 113);
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(0, 60, 113, 0.4);
            position: relative;
            z-index: 10;
        }

        /* 
        =====================================================================
        ANALYTICS VIEW - Charts display
        =====================================================================
        */
        .analytics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .analytics-title {
            font-family: 'Transport', 'Quicksand', sans-serif;
            font-size: 22px;
            font-weight: 500;
            color: rgb(0, 60, 113);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 380px; /* Fixed height to prevent expansion */
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-family: 'RotisBold', 'Quicksand', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: rgb(0, 60, 113);
            margin-bottom: 15px;
        }

        .chart-placeholder {
            font-family: 'RotisItalic', 'Quicksand', sans-serif;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 6px;
            color: #666;
            font-style: italic;
        }

        .chart-canvas-wrapper {
            flex: 1;
            position: relative;
            min-height: 0; /* Important for flexbox */
            overflow: hidden;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: 320px;
        }

        /* 
        =====================================================================
        LOADING STATE
        =====================================================================
        */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid rgb(0, 60, 113);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 
        =====================================================================
        RESPONSIVE DESIGN
        =====================================================================
        */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .header-title {
                font-size: 20px;
            }

            .controls-row {
                width: 100%;
            }

            .btn, .dropdown {
                flex: 1;
                min-width: 0;
            }

            .view-container {
                padding: 15px;
            }

            .metrics-table {
                font-size: 12px;
            }

            .metrics-table th,
            .metrics-table td {
                padding: 8px 10px;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 18px;
            }

            .btn, .dropdown {
                font-size: 12px;
                padding: 6px 12px;
            }

            .countdown-text {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="wallboard-container">
        <!-- Header with controls -->
        <div class="header">
            <div class="header-row">
                <h1 class="header-title">ID System Wallboard</h1>
                <span class="countdown-text" id="countdownText">Refreshing in: 5:00</span>
            </div>
            <div class="controls-row">
                <button class="btn" id="refreshBtn" disabled onclick="refreshWallboard()">Refresh</button>
                <select class="dropdown" id="feeEarnerDropdown" disabled onchange="handleFeeEarnerChange()">
                    <option value="">Select Fee Earner...</option>
                </select>
                <button class="btn btn-secondary" id="analyticsBtn" disabled onclick="showAnalytics()">Analytics</button>
                <button class="btn" id="downloadBtn" disabled onclick="downloadWallboardPDF()">Download PDF</button>
                <button class="btn btn-mock" onclick="loadMockData()">Load Mock Data</button>
            </div>
        </div>

        <!-- Main content area -->
        <div class="view-container">
            <!-- Wallboard View -->
            <div class="wallboard-view" id="wallboardView">
                <table class="metrics-table" id="metricsTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>SJM</th>
                            <th>MB</th>
                            <th>SKN</th>
                            <th>EL</th>
                            <th>EJL</th>
                            <th>LJD</th>
                            <th>MLP</th>
                        </tr>
                    </thead>
                    <tbody id="metricsBody">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Analytics View -->
            <div class="analytics-view" id="analyticsView">
                <div class="analytics-header">
                    <h2 class="analytics-title" id="analyticsTitle">Analytics: All Fee Earners</h2>
                    <button class="btn" onclick="backToWallboard()">Back to Wallboard</button>
                </div>
                <div class="charts-container" id="chartsContainer">
                    <!-- Charts will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        =====================================================================
        WALLBOARD IFRAME - JAVASCRIPT SECTION
        =====================================================================
        
        GLOBAL STATE VARIABLES:
        - wallboardData: Complete metrics array from parent
        - feeEarnerOptions: Dropdown options for fee earner selection
        - countdownInterval: Timer for 5-minute countdown
        - remainingTime: Seconds remaining until auto-refresh
        - selectedFeeEarner: Currently selected fee earner for analytics
        
        PARENT-CHILD COMMUNICATION:
        
        INCOMING MESSAGES (from parent):
        1. 'wallboard-data' - Complete metrics data and dropdown options
           Structure: {
               type: 'wallboard-data',
               wallboard: [
                   { title: 'Outstanding total', sjm: 5, mb: 3, ... },
                   { title: 'Outstanding With Photo ID', sjm: 2, mb: 1, ... },
                   ...
               ],
               feeEarnerOptions: [
                   { label: 'ALL', value: 'ALL' },
                   { label: 'Stephen Morrison', value: 'SJM' },
                   ...
               ]
           }
        
        2. 'analytics-data' - Detailed analytics for specific fee earner
           Structure: {
               type: 'analytics-data',
               fe: 'SJM',
               analyticsData: {
                   // Detailed breakdown data for individual fee earner
                   // Structure TBD based on backend implementation
               }
           }
        
        3. 'analytics-error' - Error fetching analytics for fee earner
           Structure: {
               type: 'analytics-error',
               fe: 'SJM',
               error: { ... },
               message: 'Error message to display'
           }
        
        OUTGOING MESSAGES (to parent):
        1. 'refresh-request' - Request fresh wallboard data
        2. 'fe-analytics' - Request detailed analytics for specific fee earner
           Structure: { type: 'fe-analytics', fe: 'SJM' }
        
        PDF DOWNLOADS (no parent communication):
        - Download button generates PDF locally using jsPDF library
        - Includes all wallboard metrics in formatted table
        - Auto-downloads with timestamp filename
        
        COUNTDOWN TIMER:
        - Starts at 5:00 (300 seconds) when data received
        - Updates display every second
        - Sends 'refresh-request' when reaches 0:00
        - Resets to 5:00 after refresh
        
        ANALYTICS FLOW:
        1. User selects fee earner from dropdown (enables Analytics button)
        2. User clicks Analytics button
        3. Send 'fe-analytics' to parent with fe: 'ALL' or fe: 'SJM', etc.
        4. Wait for 'analytics-data' response with detailed breakdown
        5a. If ALL: Show aggregate totals + breakdowns by FE (using wallboard data + analytics data)
        5b. If specific FE: Show individual metrics (combining wallboard row + analytics data)
        6. Display charts in analytics view
        7. Back to Wallboard button returns to table view
        
        ANALYTICS DATA EXAMPLES:
        - ALL: { totalAwaiting: 226, totalRequests: 0, pass90: 598, ... } (aggregated across all FE)
        - SJM: { totalAwaiting: 156, totalRequests: 0, pass90: 115, ... } (SJM-specific data)
        
        Charts combine wallboard metrics with analytics detail for rich visualizations
        
        =====================================================================
        */
        
        // Global state
        let wallboardData = null;
        let feeEarnerOptions = [];
        let countdownInterval = null;
        let remainingTime = 300; // 5 minutes in seconds
        let selectedFeeEarner = '';
        let feeEarnerAnalyticsData = null; // Detailed analytics for specific fee earner

        /*
        =====================================================================
        INITIALIZATION - Ready to receive data
        =====================================================================
        */
        document.addEventListener('DOMContentLoaded', function() {
            // Ready and waiting for wallboard-data from parent
            // Or user can click "Load Mock Data" button to test
            console.log('Wallboard iframe ready');
        });

        /*
        =====================================================================
        MESSAGE LISTENER - Handle parent communication
        =====================================================================
        */
        window.addEventListener('message', function(event) {
            if (event.data.type === 'wallboard-data') {
                const data = event.data;
                
                // Store data
                wallboardData = data.wallboard || [];
                feeEarnerOptions = data.feeEarnerOptions || [];
                
                // Populate table
                populateMetricsTable(wallboardData);
                
                // Populate dropdown
                populateFeeEarnerDropdown(feeEarnerOptions);
                
                // Enable controls
                enableControls();
                
                // Start countdown
                startCountdown();
                
                // Hide loading
                hideLoading();
                
                console.log('Wallboard data received and displayed');
            } 
            else if (event.data.type === 'analytics-data') {
                // Received detailed analytics for specific fee earner
                const data = event.data;
                
                console.log('✅ Received analytics-data message');
                
                // Store data
                feeEarnerAnalyticsData = data.analyticsData || null;
                
                // Generate charts with detailed data
                if (feeEarnerAnalyticsData) {
                    console.log('📊 Analytics data received for fee earner:', selectedFeeEarner);
                    generateChartsWithData(selectedFeeEarner, feeEarnerAnalyticsData);
                } else {
                    console.warn('⚠️ No analytics data in message');
                }
                
                // Hide loading
                console.log('🔄 Calling hideLoading()');
                hideLoading();
                console.log('✅ hideLoading() completed');
            }
            else if (event.data.type === 'analytics-error') {
                // Parent encountered error fetching analytics
                console.error('Analytics error:', event.data.error);
                
                // Hide loading
                hideLoading();
                
                // Return to wallboard view
                backToWallboard();
                
                // Re-enable analytics button so user can retry
                const analyticsBtn = document.getElementById('analyticsBtn');
                if (analyticsBtn) {
                    analyticsBtn.disabled = false;
                }
                
                // Show error message in chart area (optional - could also show error popup)
                const container = document.getElementById('chartsContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3 style="font-size: 18px; margin-bottom: 10px;">⚠️ Analytics Error</h3>
                        <p style="font-size: 14px; color: #666;">
                            ${event.data.message || 'Unable to load analytics data. Please try again.'}
                        </p>
                    </div>
                `;
                
                console.log('❌ Analytics request failed, returned to wallboard, button re-enabled for retry');
            }
        });

        /*
        =====================================================================
        POPULATE METRICS TABLE
        =====================================================================
        */
        function populateMetricsTable(data) {
            const tbody = document.getElementById('metricsBody');
            tbody.innerHTML = ''; // Clear existing rows
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">No data available</td></tr>';
                return;
            }
            
            // Fee earner keys in order
            const feeEarners = ['sjm', 'mb', 'skn', 'el', 'ejl', 'ljd', 'mlp'];
            
            // Create a row for each metric
            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = rowIndex;
                
                // Title cell (metric name)
                const titleCell = document.createElement('td');
                titleCell.textContent = row.title || 'Unknown Metric';
                titleCell.dataset.isTitle = 'true';
                tr.appendChild(titleCell);
                
                // Data cells for each fee earner
                feeEarners.forEach((fe, colIndex) => {
                    const dataCell = document.createElement('td');
                    dataCell.textContent = row[fe] !== undefined ? row[fe] : '-';
                    dataCell.dataset.colIndex = colIndex;
                    dataCell.dataset.rowIndex = rowIndex;
                    tr.appendChild(dataCell);
                });
                
                tbody.appendChild(tr);
            });
            
            // Add hover event listeners
            addTableHoverEffects();
        }

        /*
        =====================================================================
        ADD TABLE HOVER EFFECTS - Interactive highlighting
        =====================================================================
        */
        function addTableHoverEffects() {
            const table = document.getElementById('metricsTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // 1. Column header hover - highlight entire column
            const headers = thead.querySelectorAll('th');
            headers.forEach((th, index) => {
                if (index === 0) return; // Skip first header (Metric column)
                
                th.addEventListener('mouseenter', function() {
                    highlightColumn(index);
                });
                
                th.addEventListener('mouseleave', function() {
                    clearAllHighlights();
                });
            });
            
            // 2. Metric name (first cell in row) hover - highlight entire row
            const titleCells = tbody.querySelectorAll('td[data-is-title="true"]');
            titleCells.forEach(titleCell => {
                titleCell.addEventListener('mouseenter', function() {
                    const row = this.parentElement;
                    row.classList.add('row-highlight');
                });
                
                titleCell.addEventListener('mouseleave', function() {
                    clearAllHighlights();
                });
            });
            
            // 3. Data cell hover - highlight both row and column
            const dataCells = tbody.querySelectorAll('td[data-col-index]');
            dataCells.forEach(dataCell => {
                dataCell.addEventListener('mouseenter', function() {
                    const colIndex = parseInt(this.dataset.colIndex);
                    const row = this.parentElement;
                    
                    // Highlight the row
                    row.classList.add('row-highlight');
                    
                    // Highlight the column
                    highlightColumn(colIndex + 1); // +1 because column 0 is the title column
                    
                    // Extra highlight for the specific cell
                    this.classList.add('cell-highlight');
                });
                
                dataCell.addEventListener('mouseleave', function() {
                    clearAllHighlights();
                });
            });
        }

        /*
        =====================================================================
        HIGHLIGHT COLUMN - Add highlight class to all cells in column
        =====================================================================
        */
        function highlightColumn(colIndex) {
            const table = document.getElementById('metricsTable');
            
            // Highlight header
            const headers = table.querySelectorAll('thead th');
            if (headers[colIndex]) {
                headers[colIndex].classList.add('column-highlight');
            }
            
            // Highlight all data cells in this column
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells[colIndex]) {
                    cells[colIndex].classList.add('column-highlight');
                }
            });
        }

        /*
        =====================================================================
        CLEAR ALL HIGHLIGHTS - Remove all highlight classes
        =====================================================================
        */
        function clearAllHighlights() {
            const table = document.getElementById('metricsTable');
            
            // Clear column highlights
            table.querySelectorAll('.column-highlight').forEach(el => {
                el.classList.remove('column-highlight');
            });
            
            // Clear row highlights
            table.querySelectorAll('.row-highlight').forEach(el => {
                el.classList.remove('row-highlight');
            });
            
            // Clear cell highlights
            table.querySelectorAll('.cell-highlight').forEach(el => {
                el.classList.remove('cell-highlight');
            });
        }

        /*
        =====================================================================
        POPULATE FEE EARNER DROPDOWN
        =====================================================================
        */
        function populateFeeEarnerDropdown(options) {
            const dropdown = document.getElementById('feeEarnerDropdown');
            
            // Clear existing options except the first placeholder
            dropdown.innerHTML = '<option value="">Select Fee Earner...</option>';
            
            if (!options || options.length === 0) {
                return;
            }
            
            // Add options
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                dropdown.appendChild(option);
            });
        }

        /*
        =====================================================================
        ENABLE CONTROLS - After data loaded
        =====================================================================
        */
        function enableControls() {
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('feeEarnerDropdown').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        }

        /*
        =====================================================================
        COUNTDOWN TIMER FUNCTIONS
        =====================================================================
        */
        function startCountdown() {
            // Stop any existing countdown
            stopCountdown();
            
            // Reset to 5 minutes
            remainingTime = 300;
            
            // Update display immediately
            updateCountdownDisplay();
            
            // Start interval
            countdownInterval = setInterval(() => {
                remainingTime--;
                updateCountdownDisplay();
                
                if (remainingTime <= 0) {
                    // Time expired - refresh
                    refreshWallboard();
                }
            }, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function updateCountdownDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const formatted = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            document.getElementById('countdownText').textContent = `Refreshing in: ${formatted}`;
        }

        /*
        =====================================================================
        REFRESH WALLBOARD - Request fresh data from parent
        =====================================================================
        */
        function refreshWallboard() {
            console.log('Refresh requested');
            
            // Show loading
            showLoading();
            
            // Stop countdown
            stopCountdown();
            
            // Disable controls during refresh
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('analyticsBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('feeEarnerDropdown').disabled = true;
            
            // Request fresh data from parent
            window.parent.postMessage({
                type: 'refresh-request'
            }, '*');
            
            // Note: Parent will respond with new 'wallboard-data' message
            // which will re-enable controls and restart countdown
        }

        /*
        =====================================================================
        DOWNLOAD WALLBOARD PDF - Generate and download metrics table as PDF
        =====================================================================
        */
        function downloadWallboardPDF() {
            if (!wallboardData || wallboardData.length === 0 || !window.jspdf) {
                console.error('Cannot generate PDF: missing data or jsPDF library');
                return;
            }
            
            console.log('📄 Generating wallboard PDF...');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4'); // Landscape orientation for wide table
            
            const generatedDate = new Date().toLocaleString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // A4 Landscape: 842pt wide, 595pt tall
            const pageWidth = 842;
            const pageHeight = 595;
            const margin = 40;
            let yPosition = margin;
            
            // Set font
            doc.setFont('helvetica');
            
            // Header - Thurstan Hoskin branding
            doc.setFontSize(24);
            doc.setTextColor(0, 60, 113);
            doc.setFont('helvetica', 'bold');
            doc.text('Thurstan Hoskin', margin, yPosition);
            
            doc.setFontSize(18);
            doc.text("Val'ID'ate Wallboard", pageWidth - margin - 180, yPosition);
            
            yPosition += 10;
            
            // Header border
            doc.setDrawColor(0, 60, 113);
            doc.setLineWidth(3);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            
            yPosition += 25;
            
            // Document title
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            const title = 'ID System Metrics - Wallboard Report';
            const titleWidth = doc.getTextWidth(title);
            doc.text(title, (pageWidth - titleWidth) / 2, yPosition);
            
            yPosition += 20;
            
            // Generation timestamp
            doc.setFontSize(12);
            doc.setTextColor(102, 102, 102);
            doc.setFont('helvetica', 'normal');
            const timestamp = `Generated: ${generatedDate}`;
            const timestampWidth = doc.getTextWidth(timestamp);
            doc.text(timestamp, (pageWidth - timestampWidth) / 2, yPosition);
            
            yPosition += 25;
            
            // Build table data
            const feeEarners = ['sjm', 'mb', 'skn', 'el', 'ejl', 'ljd', 'mlp'];
            const tableData = wallboardData.map(row => {
                return [
                    row.title || 'Unknown',
                    row.sjm !== undefined ? row.sjm : '-',
                    row.mb !== undefined ? row.mb : '-',
                    row.skn !== undefined ? row.skn : '-',
                    row.el !== undefined ? row.el : '-',
                    row.ejl !== undefined ? row.ejl : '-',
                    row.ljd !== undefined ? row.ljd : '-',
                    row.mlp !== undefined ? row.mlp : '-'
                ];
            });
            
            // Create table using autoTable
            doc.autoTable({
                startY: yPosition,
                head: [['Metric', 'SJM', 'MB', 'SKN', 'EL', 'EJL', 'LJD', 'MLP']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [0, 60, 113],
                    textColor: 255,
                    fontSize: 11,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 10,
                    textColor: [51, 51, 51]
                },
                columnStyles: {
                    0: { halign: 'left', fontStyle: 'bold', cellWidth: 200 }, // Metric column
                    1: { halign: 'center' },
                    2: { halign: 'center' },
                    3: { halign: 'center' },
                    4: { halign: 'center' },
                    5: { halign: 'center' },
                    6: { halign: 'center' },
                    7: { halign: 'center' }
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                margin: { left: margin, right: margin }
            });
            
            yPosition = doc.lastAutoTable.finalY + 20;
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(102, 102, 102);
            doc.setFont('helvetica', 'italic');
            const footer = 'This report contains ID system metrics for all active fee earners at the time of generation.';
            const footerWidth = doc.getTextWidth(footer);
            doc.text(footer, (pageWidth - footerWidth) / 2, yPosition);
            
            // Generate filename with timestamp
            const timestamp_file = new Date().toISOString().replace(/:/g, '-').split('.')[0];
            const filename = `Wallboard_Report_${timestamp_file}.pdf`;
            
            // Download
            doc.save(filename);
            console.log('📄 PDF downloaded:', filename);
        }

        /*
        =====================================================================
        FEE EARNER SELECTION - Enable analytics button when selected
        =====================================================================
        */
        function handleFeeEarnerChange() {
            const dropdown = document.getElementById('feeEarnerDropdown');
            selectedFeeEarner = dropdown.value;
            
            // Enable analytics button if fee earner selected
            const analyticsBtn = document.getElementById('analyticsBtn');
            analyticsBtn.disabled = !selectedFeeEarner;
            
            console.log('Fee earner selected:', selectedFeeEarner);
        }

        /*
        =====================================================================
        SHOW ANALYTICS - Switch to analytics view
        =====================================================================
        */
        function showAnalytics() {
            if (!selectedFeeEarner) return;
            
            console.log('Showing analytics for:', selectedFeeEarner);
            
            // Hide wallboard, show analytics
            document.getElementById('wallboardView').style.display = 'none';
            document.getElementById('analyticsView').style.display = 'block';
            
            // Update analytics title
            const title = document.getElementById('analyticsTitle');
            if (selectedFeeEarner === 'ALL') {
                title.textContent = 'Analytics: All Fee Earners';
            } else {
                const option = feeEarnerOptions.find(opt => opt.value === selectedFeeEarner);
                title.textContent = option ? `Analytics: ${option.label}` : 'Analytics';
            }
            
            // Request detailed analytics from parent (for both ALL and individual FE)
            console.log('📡 Requesting detailed analytics for:', selectedFeeEarner);
            
            // Show loading while waiting for data
            showLoading();
            
            // Clear previous analytics data
            feeEarnerAnalyticsData = null;
            
            // Request from parent (fe can be 'ALL' or specific like 'SJM')
            window.parent.postMessage({
                type: 'fe-analytics',
                fe: selectedFeeEarner
            }, '*');
            
            // Note: Parent will respond with 'analytics-data' message
            // - For ALL: returns aggregated totals for all fee earners combined
            // - For specific FE: returns detailed data for that fee earner only
            // Then generateChartsWithData() will create appropriate charts
        }

        /*
        =====================================================================
        BACK TO WALLBOARD - Switch back to table view
        =====================================================================
        */
        function backToWallboard() {
            console.log('Returning to wallboard view');
            
            // Show wallboard, hide analytics
            document.getElementById('wallboardView').style.display = 'block';
            document.getElementById('analyticsView').style.display = 'none';
        }

        /*
        =====================================================================
        GENERATE CHARTS WITH DATA - Create charts based on FE selection
        =====================================================================
        Uses wallboard data + detailed analytics data from parent
        
        ALL mode: Shows aggregate totals + breakdowns by fee earner
        Individual FE mode: Shows specific FE metrics with detailed breakdowns
        =====================================================================
        */
        function generateChartsWithData(feeEarner, analyticsData) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = ''; // Clear existing charts
            
            if (feeEarner === 'ALL') {
                // ALL ANALYTICS: Show totals and breakdowns by fee earner
                console.log('📊 Creating ALL fee earner charts (totals + breakdowns)');
                console.log('Analytics data:', analyticsData);
                console.log('Wallboard data:', wallboardData);
                
                // Charts that show aggregate totals + breakdowns by fee earner
                const allCharts = [
                    'Total Outstanding (Breakdown by FE)',
                    'Total Requests (Breakdown by Type & FE)',
                    'Passes - 7/30/90 Days (Comparison by FE)',
                    'E-ID in Progress (Breakdown by FE)',
                    'Issues & Pending (Breakdown by FE)',
                    'Messages & Activity (Breakdown by FE)'
                ];
                
                allCharts.forEach(chartTitle => {
                    createChartCard(chartTitle, container, 'ALL', analyticsData);
                });
            } else {
                // INDIVIDUAL FE ANALYTICS: Show specific FE metrics with detailed breakdowns
                console.log('📊 Creating individual fee earner charts');
                console.log('Fee Earner:', feeEarner);
                console.log('Analytics data:', analyticsData);
                console.log('Wallboard row:', getWallboardRowForFE(feeEarner.toLowerCase()));
                
            // Charts for individual fee earner (combining wallboard + analytics data)
            const individualCharts = [
                'Passes by Type (Last 90 Days)',
                'Outstanding & Requests Breakdown',
                'E-ID Breakdown',
                'PEP Breakdown',
                'Open Requests Breakdown',
                'Pass Breakdown (90 Days)'
            ];
                
                individualCharts.forEach(chartTitle => {
                    createChartCard(chartTitle, container, feeEarner, analyticsData);
                });
            }
        }

        /*
        =====================================================================
        GET WALLBOARD ROW FOR FE - Extract specific fee earner's data
        =====================================================================
        */
        function getWallboardRowForFE(feKey) {
            if (!wallboardData || wallboardData.length === 0) return null;
            
            // Extract all metrics for this fee earner from wallboard data
            const feData = {};
            wallboardData.forEach(row => {
                if (row[feKey] !== undefined) {
                    feData[row.title] = row[feKey];
                }
            });
            
            return feData;
        }

        /*
        =====================================================================
        CREATE CHART CARD - Helper to create chart with Chart.js
        =====================================================================
        */
        function createChartCard(title, container, feeEarner = null, analyticsData = null) {
            const card = document.createElement('div');
            card.className = 'chart-card';
            
            const chartTitle = document.createElement('div');
            chartTitle.className = 'chart-title';
            chartTitle.textContent = title;
            
            // Create wrapper for canvas to control height
            const canvasWrapper = document.createElement('div');
            canvasWrapper.className = 'chart-canvas-wrapper';
            
            // Create canvas for Chart.js
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            const canvasId = 'chart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            canvas.id = canvasId;
            
            canvasWrapper.appendChild(canvas);
            card.appendChild(chartTitle);
            card.appendChild(canvasWrapper);
            container.appendChild(card);
            
            // Generate appropriate chart based on mode and title
            if (feeEarner === 'ALL') {
                createAllModeChart(canvas, title, analyticsData);
            } else {
                createIndividualModeChart(canvas, title, feeEarner, analyticsData);
            }
        }

        /*
        =====================================================================
        CREATE ALL MODE CHART - Charts for aggregate view
        =====================================================================
        */
        function createAllModeChart(canvas, title, analyticsData) {
            const ctx = canvas.getContext('2d');
            const feeEarners = ['SJM', 'MB', 'SKN', 'EL', 'EJL', 'LJD', 'MLP'];
            const colors = [
                'rgba(0, 60, 113, 0.8)',    // Navy
                'rgba(212, 165, 116, 0.8)', // Tan
                'rgba(74, 144, 226, 0.8)',  // Blue
                'rgba(255, 107, 53, 0.8)',  // Orange
                'rgba(46, 204, 113, 0.8)',  // Green
                'rgba(155, 89, 182, 0.8)',  // Purple
                'rgba(241, 196, 15, 0.8)'   // Yellow
            ];
            
            switch(title) {
                case 'Total Outstanding (Breakdown by FE)':
                    createBarChartByFE(ctx, 'Outstanding total', feeEarners, colors);
                    break;
                    
                case 'Total Requests (Breakdown by Type & FE)':
                    createRequestsChart(ctx, analyticsData, feeEarners, colors);
                    break;
                    
                case 'Passes - 7/30/90 Days (Comparison by FE)':
                    createPassesComparisonChart(ctx, feeEarners, colors);
                    break;
                    
                case 'E-ID in Progress (Breakdown by FE)':
                    createBarChartByFE(ctx, 'E-ID in progress', feeEarners, colors);
                    break;
                    
                case 'Issues & Pending (Breakdown by FE)':
                    createIssuesPendingChart(ctx, feeEarners, colors);
                    break;
                    
                case 'Messages & Activity (Breakdown by FE)':
                    createBarChartByFE(ctx, 'Messages', feeEarners, colors);
                    break;
                    
                default:
                    new Chart(ctx, {
                        type: 'bar',
                        data: { labels: feeEarners, datasets: [{ label: title, data: [] }] }
                    });
            }
        }

        /*
        =====================================================================
        CREATE INDIVIDUAL MODE CHART - Charts for specific fee earner
        =====================================================================
        */
        function createIndividualModeChart(canvas, title, feeEarner, analyticsData) {
            const ctx = canvas.getContext('2d');
            
            switch(title) {
                case 'Passes by Type (Last 90 Days)':
                    createPassesByTypeChart(ctx, analyticsData);
                    break;
                    
                case 'Outstanding & Requests Breakdown':
                    createOutstandingBreakdownChart(ctx, analyticsData);
                    break;
                    
                case 'E-ID Breakdown':
                    createEidBreakdownChart(ctx, analyticsData);
                    break;
                    
                case 'PEP Breakdown':
                    createPepBreakdownChart(ctx, analyticsData);
                    break;
                    
                case 'Open Requests Breakdown':
                    createOpenRequestsChart(ctx, analyticsData);
                    break;
                    
                case 'Pass Breakdown (90 Days)':
                    createPassBreakdownChart(ctx, analyticsData);
                    break;
                    
                default:
                    new Chart(ctx, {
                        type: 'bar',
                        data: { labels: ['Data'], datasets: [{ label: title, data: [0] }] }
                    });
            }
        }

        /*
        =====================================================================
        CHART BUILDERS - ALL MODE
        =====================================================================
        */
        
        function createBarChartByFE(ctx, metric, feeEarners, colors) {
            // Find the metric row in wallboard data
            const metricRow = wallboardData.find(row => row.title === metric);
            if (!metricRow) return;
            
            const data = feeEarners.map(fe => metricRow[fe.toLowerCase()] || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: feeEarners,
                    datasets: [{
                        label: metric,
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createRequestsChart(ctx, analyticsData, feeEarners, colors) {
            // Get requests data from wallboard for each FE
            const requestsRow = wallboardData.find(row => row.title === 'Requests');
            if (!requestsRow) return;
            
            const data = feeEarners.map(fe => requestsRow[fe.toLowerCase()] || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: feeEarners,
                    datasets: [{
                        label: 'Total Requests',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createPassesComparisonChart(ctx, feeEarners, colors) {
            // Get passes data for 7, 30, 90 days
            const passes7Row = wallboardData.find(row => row.title === 'Passes in last 7 days');
            const passes30Row = wallboardData.find(row => row.title === 'Passes in last 30 days');
            const passes90Row = wallboardData.find(row => row.title === 'Passes in last 90 days');
            
            if (!passes7Row || !passes30Row || !passes90Row) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: feeEarners,
                    datasets: [
                        {
                            label: '7 Days',
                            data: feeEarners.map(fe => passes7Row[fe.toLowerCase()] || 0),
                            backgroundColor: 'rgba(46, 204, 113, 0.8)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '30 Days',
                            data: feeEarners.map(fe => passes30Row[fe.toLowerCase()] || 0),
                            backgroundColor: 'rgba(74, 144, 226, 0.8)',
                            borderColor: 'rgba(74, 144, 226, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '90 Days',
                            data: feeEarners.map(fe => passes90Row[fe.toLowerCase()] || 0),
                            backgroundColor: 'rgba(0, 60, 113, 0.8)',
                            borderColor: 'rgba(0, 60, 113, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createIssuesPendingChart(ctx, feeEarners, colors) {
            const issuesRow = wallboardData.find(row => row.title === 'Issues');
            const pendingRow = wallboardData.find(row => row.title === 'Pending');
            
            if (!issuesRow || !pendingRow) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: feeEarners,
                    datasets: [
                        {
                            label: 'Issues',
                            data: feeEarners.map(fe => issuesRow[fe.toLowerCase()] || 0),
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending',
                            data: feeEarners.map(fe => pendingRow[fe.toLowerCase()] || 0),
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        /*
        =====================================================================
        CHART BUILDERS - INDIVIDUAL FE MODE
        =====================================================================
        */
        
        // 1. Passes by Type (Last 90 Days) - Doughnut
        function createPassesByTypeChart(ctx, analyticsData) {
            const pass90 = analyticsData.pass90 || 0;
            const ePass90 = analyticsData.ePass90 || 0;
            const idHeld90 = analyticsData.idHeld90 || 0;
            const totalPasses = pass90 + ePass90 + idHeld90;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Pass - ${((pass90 / totalPasses * 100) || 0).toFixed(1)}%`,
                        `ePass - ${((ePass90 / totalPasses * 100) || 0).toFixed(1)}%`,
                        `ID Held - ${((idHeld90 / totalPasses * 100) || 0).toFixed(1)}%`
                    ],
                    datasets: [{
                        data: [pass90, ePass90, idHeld90],
                        backgroundColor: [
                            'rgba(166, 157, 108, 0.6)', // Pantone 451C
                            'rgba(0, 57, 96, 0.6)', // Pantone 541C
                            'rgba(0, 255, 128, 0.6)' // Green
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'right' },
                        title: {
                            display: true,
                            text: `Passes by Type (Last 90 Days) [${totalPasses}]`,
                            font: { size: 12 }
                        }
                    }
                }
            });
        }
        
        // 2. Outstanding & Requests Breakdown - Doughnut
        function createOutstandingBreakdownChart(ctx, analyticsData) {
            const added7 = analyticsData.added7 || 0;
            const added830 = analyticsData.added830 || 0;
            const over30 = analyticsData.over30 || 0;
            const withPhotoID = analyticsData.totalAwaitingWID || 0;
            const totalRequests = parseInt(analyticsData.totalRequests) || 0;
            const totalPending = analyticsData.totalPending || 0;
            
            const totalValues = added7 + added830 + over30 + withPhotoID + totalRequests + totalPending;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Added in last 7 days - ${(added7 / totalValues * 100).toFixed(1)}%`,
                        `8-30 Days - ${(added830 / totalValues * 100).toFixed(1)}%`,
                        `Over 30 Days Old - ${(over30 / totalValues * 100).toFixed(1)}%`,
                        `With Photo ID - ${(withPhotoID / totalValues * 100).toFixed(1)}%`,
                        `Requests - ${(totalRequests / totalValues * 100).toFixed(1)}%`,
                        `Pending - ${(totalPending / totalValues * 100).toFixed(1)}%`
                    ],
                    datasets: [{
                        data: [added7, added830, over30, withPhotoID, totalRequests, totalPending],
                        backgroundColor: [
                            'rgba(0, 204, 102, 0.6)', // Green
                            'rgba(255, 206, 86, 0.6)', // Amber
                            'rgba(255, 99, 132, 0.6)', // Red
                            'rgba(255, 255, 102, 0.6)', // Yellow
                            'rgba(211, 211, 211, 0.6)', // Light Grey
                            'rgba(173, 216, 230, 0.6)' // Light Blue
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'right' }
                    }
                }
            });
        }
        
        // 3. E-ID Breakdown - Bar
        function createEidBreakdownChart(ctx, analyticsData) {
            const totalEID = analyticsData.totalBio || 0;
            const over7Days = analyticsData.totalBio7 || 0;
            const under7Days = totalEID - over7Days;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        `Less than 1 week old [${under7Days}]`,
                        `Over 1 week old [${over7Days}]`
                    ],
                    datasets: [
                        {
                            label: 'Less than 1 week old',
                            data: [under7Days, 0],
                            backgroundColor: 'rgba(255, 206, 86, 0.6)', // Yellow
                            barPercentage: 1
                        },
                        {
                            label: 'Over 1 week old',
                            data: [0, over7Days],
                            backgroundColor: 'rgba(255, 99, 132, 0.6)', // Red
                            barPercentage: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: {
                            display: true,
                            text: `E-ID in Progress Breakdown [${totalEID}]`,
                            font: { size: 12 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Number in Progress' }
                        },
                        x: { title: { display: true, text: ' ' } }
                    }
                }
            });
        }
        
        // 4. PEP Breakdown - Doughnut
        function createPepBreakdownChart(ctx, analyticsData) {
            const totalPEPs = (analyticsData.totalPpep || 0) + (analyticsData.totalCpep || 0) + (analyticsData.totalNpep || 0);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Potential PEP - ${(((analyticsData.totalPpep || 0) / totalPEPs * 100) || 0).toFixed(1)}%`,
                        `Confirmed PEP - ${(((analyticsData.totalCpep || 0) / totalPEPs * 100) || 0).toFixed(1)}%`,
                        `Outruled PEP - ${(((analyticsData.totalNpep || 0) / totalPEPs * 100) || 0).toFixed(1)}%`
                    ],
                    datasets: [{
                        data: [
                            analyticsData.totalPpep || 0,
                            analyticsData.totalCpep || 0,
                            analyticsData.totalNpep || 0
                        ],
                        backgroundColor: [
                            'rgba(255, 159, 64, 0.6)', // Orange (Potential PEP)
                            'rgba(255, 99, 132, 0.6)', // Red (Confirmed PEP)
                            'rgba(0, 204, 102, 0.6)' // Green (Outruled PEP)
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'right' },
                        title: {
                            display: true,
                            text: `PEP Breakdown [${totalPEPs}]`,
                            font: { size: 12 }
                        }
                    }
                }
            });
        }
        
        // 5. Open Requests Breakdown - Doughnut
        function createOpenRequestsChart(ctx, analyticsData) {
            const totalRequests = (analyticsData.formJ || 0) + (analyticsData.formE || 0) + (analyticsData.formK || 0) + 
                                 (analyticsData.eSoF || 0) + (analyticsData.formEsoF?.length || 0);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Form J - ${(((analyticsData.formJ || 0) / totalRequests * 100) || 0).toFixed(1)}%`,
                        `Form K - ${(((analyticsData.formK || 0) / totalRequests * 100) || 0).toFixed(1)}%`,
                        `Form E - ${(((analyticsData.formE || 0) / totalRequests * 100) || 0).toFixed(1)}%`,
                        `eSoF - ${(((analyticsData.eSoF || 0) / totalRequests * 100) || 0).toFixed(1)}%`,
                        `Form E + eSoF Combined - ${(((analyticsData.formEsoF?.length || 0) / totalRequests * 100) || 0).toFixed(1)}%`
                    ],
                    datasets: [{
                        data: [
                            analyticsData.formJ || 0,
                            analyticsData.formK || 0,
                            analyticsData.formE || 0,
                            analyticsData.eSoF || 0,
                            analyticsData.formEsoF?.length || 0
                        ],
                        backgroundColor: [
                            'rgba(0, 204, 102, 0.6)', // Green for Form J
                            'rgba(211, 211, 211, 0.6)', // Grey for Form K
                            'rgba(54, 162, 235, 0.6)', // Blue for Form E
                            'rgba(255, 206, 86, 0.6)', // Yellow for eSoF
                            'rgba(255, 159, 64, 0.6)' // Orange for Combined
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'right' },
                        title: {
                            display: true,
                            text: `Requests Breakdown [${totalRequests}]`,
                            font: { size: 12 }
                        }
                    }
                }
            });
        }

        // 6. Pass Breakdown (90 Days) - Bar
        function createPassBreakdownChart(ctx, analyticsData) {
            const totalPassSeven = analyticsData.totalPasses7 || 0;
            const totalPassThirty = analyticsData.totalPasses30 || 0;
            const totalPassNinety = analyticsData.totalPasses90 || 0;
            
            const pass830 = totalPassThirty - totalPassSeven;
            const pass3190 = totalPassNinety - totalPassThirty;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        `Passes in last 7 Days [${totalPassSeven}]`,
                        `Passes 8-30 Days ago [${pass830}]`,
                        `Passes 31-90 Days ago [${pass3190}]`
                    ],
                    datasets: [
                        {
                            label: 'Passes in last 7 Days',
                            data: [totalPassSeven, 0, 0],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Teal
                            barPercentage: 1
                        },
                        {
                            label: 'Passes 8-30 Days ago',
                            data: [0, pass830, 0],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)', // Blue
                            barPercentage: 1
                        },
                        {
                            label: 'Passes 31-90 Days ago',
                            data: [0, 0, pass3190],
                            backgroundColor: 'rgba(255, 206, 86, 0.6)', // Yellow
                            barPercentage: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: {
                            display: true,
                            text: `Pass Breakdown (Last 90 Days) [${totalPassNinety}]`,
                            font: { size: 12 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Passes' }
                        },
                        x: { title: { display: true, text: ' ' } }
                    }
                }
            });
        }

        /*
        =====================================================================
        LOADING STATE FUNCTIONS
        =====================================================================
        */
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            console.log('💡 hideLoading() called, overlay element:', overlay);
            console.log('💡 Overlay current classes:', overlay?.className);
            overlay.classList.remove('show');
            console.log('💡 Overlay classes after remove:', overlay?.className);
        }

        /*
        =====================================================================
        MOCK DATA - For testing purposes
        =====================================================================
        */
        
        // Mock analytics data for ALL fee earners
        const mockAnalyticsDataAll = {
            totalAwaiting: 226,
            totalAwaitingWID: 28,
            totalRequests: "0",
            formJ: 0,
            formE: 0,
            formEsoF: [],
            formK: 0,
            eSoF: 0,
            totalPending: 29,
            added7: 18,
            added830: 46,
            over30: 162,
            pass90: 291,
            ePass90: 178,
            idHeld90: 129,
            totalPasses90: 598,
            totalPasses7: 151,
            totalPasses30: 257,
            totalIssues: 1,
            totalIssues7: 0,
            totalBio: 12,
            totalBio7: 4,
            totalPpep: 1,
            totalCpep: 0,
            totalNpep: 347,
            totalUnassigned: 1,
            messages: 389
        };
        
        // Mock analytics data for individual fee earner (SJM example)
        const mockAnalyticsDataSJM = {
            totalAwaiting: 156,
            totalAwaitingWID: 16,
            totalRequests: "0",
            formJ: 0,
            formE: 0,
            formEsoF: [],
            formK: 0,
            eSoF: 0,
            totalPending: 21,
            added7: 4,
            added830: 19,
            over30: 133,
            pass90: 58,
            ePass90: 38,
            idHeld90: 19,
            totalPasses90: 115,
            totalPasses7: 21,
            totalPasses30: 40,
            totalIssues: 0,
            totalIssues7: 0,
            totalBio: 5,
            totalBio7: 2,
            totalPpep: 0,
            totalCpep: 0,
            totalNpep: 82,
            totalUnassigned: 0,
            messages: 94
        };
        
        // Intercept analytics requests and respond with mock data
        const originalPostMessage = window.parent.postMessage;
        window.parent.postMessage = function(message, targetOrigin) {
            console.log('🔍 postMessage interceptor called with:', message);
            
            // Check if it's an analytics request
            if (message && message.type === 'fe-analytics') {
                console.log('🎭 Mock: Intercepted analytics request for:', message.fe);
                
                // Simulate delay
                setTimeout(() => {
                    let analyticsData;
                    
                    if (message.fe === 'ALL') {
                        console.log('📊 Returning ALL analytics data');
                        analyticsData = mockAnalyticsDataAll;
                    } else if (message.fe === 'SJM') {
                        console.log('📊 Returning SJM analytics data');
                        analyticsData = mockAnalyticsDataSJM;
                    } else {
                        console.log('📊 Returning generic analytics data for:', message.fe);
                        // For other fee earners, return a simplified version
                        analyticsData = {
                            totalAwaiting: 20,
                            totalAwaitingWID: 2,
                            totalRequests: "0",
                            totalPending: 5,
                            added7: 2,
                            added830: 8,
                            over30: 10,
                            pass90: 50,
                            ePass90: 30,
                            idHeld90: 20,
                            totalPasses90: 100,
                            totalPasses7: 15,
                            totalPasses30: 30,
                            totalIssues: 0,
                            totalIssues7: 0,
                            totalBio: 2,
                            totalBio7: 1,
                            totalPpep: 0,
                            totalCpep: 0,
                            totalNpep: 20,
                            formJ: 0,
                            formE: 0,
                            formK: 0,
                            eSoF: 0,
                            formEsoF: [],
                            messages: 30
                        };
                    }
                    
                    console.log('✅ Dispatching analytics-data response');
                    
                    // Send mock analytics response
                    window.dispatchEvent(new MessageEvent('message', {
                        data: {
                            type: 'analytics-data',
                            fe: message.fe,
                            analyticsData: analyticsData
                        },
                        origin: window.location.origin
                    }));
                }, 300); // Simulate network delay (reduced to 300ms for better UX)
                
                return; // Don't call original postMessage
            }
            
            // For other message types, call original (or ignore in standalone mode)
            console.log('📤 Message to parent (not intercepted):', message.type);
        };
        
        function loadMockData() {
            console.log('Loading mock data for testing...');
            
            const mockData = {
                type: 'wallboard-data',
                wallboard: [
                    {
                        "title": "Outstanding total",
                        "sjm": 156,
                        "mb": 15,
                        "skn": 20,
                        "el": 0,
                        "ejl": 2,
                        "ljd": 24,
                        "mlp": 6
                    },
                    {
                        "title": "Outstanding With Photo ID",
                        "sjm": 16,
                        "mb": 1,
                        "skn": 1,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 8,
                        "mlp": 1
                    },
                    {
                        "title": "Added in last 7 days",
                        "sjm": 3,
                        "mb": 2,
                        "skn": 3,
                        "el": 0,
                        "ejl": 1,
                        "ljd": 6,
                        "mlp": 0
                    },
                    {
                        "title": "Outstanding over 30 days",
                        "sjm": 51,
                        "mb": 0,
                        "skn": 0,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 6,
                        "mlp": 0
                    },
                    {
                        "title": "Requests",
                        "sjm": 0,
                        "mb": 0,
                        "skn": 0,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 0,
                        "mlp": 0
                    },
                    {
                        "title": "Messages",
                        "sjm": 94,
                        "mb": 83,
                        "skn": 2,
                        "el": 50,
                        "ejl": 7,
                        "ljd": 136,
                        "mlp": 17
                    },
                    {
                        "title": "Unassigned Clients",
                        "sjm": 0,
                        "mb": 0,
                        "skn": 0,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 1,
                        "mlp": 0
                    },
                    {
                        "title": "E-ID in progress",
                        "sjm": 5,
                        "mb": 3,
                        "skn": 2,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 2,
                        "mlp": 0
                    },
                    {
                        "title": "E-ID over 1 week old",
                        "sjm": 2,
                        "mb": 1,
                        "skn": 1,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 0,
                        "mlp": 0
                    },
                    {
                        "title": "Issues",
                        "sjm": 0,
                        "mb": 0,
                        "skn": 1,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 0,
                        "mlp": 0
                    },
                    {
                        "title": "Passes in last 7 days",
                        "sjm": 21,
                        "mb": 13,
                        "skn": 91,
                        "el": 8,
                        "ejl": 6,
                        "ljd": 11,
                        "mlp": 1
                    },
                    {
                        "title": "Passes in last 30 days",
                        "sjm": 40,
                        "mb": 40,
                        "skn": 106,
                        "el": 12,
                        "ejl": 11,
                        "ljd": 43,
                        "mlp": 5
                    },
                    {
                        "title": "Passes in last 90 days",
                        "sjm": 115,
                        "mb": 127,
                        "skn": 131,
                        "el": 69,
                        "ejl": 29,
                        "ljd": 111,
                        "mlp": 16
                    },
                    {
                        "title": "Pending",
                        "sjm": 21,
                        "mb": 7,
                        "skn": 1,
                        "el": 0,
                        "ejl": 0,
                        "ljd": 0,
                        "mlp": 0
                    }
                ],
                feeEarnerOptions: [
                    { label: 'ALL', value: 'ALL' },
                    { label: 'Stephen Morrison', value: 'SJM' },
                    { label: 'Mollie Pellowe', value: 'MLP' },
                    { label: 'Martin Biscombe', value: 'MB' },
                    { label: 'Samantha Newton', value: 'SKN' },
                    { label: 'Emma Lilley', value: 'EL' },
                    { label: 'Emma Lockie', value: 'EJL' },
                    { label: 'Louise Deere', value: 'LJD' },
                    { label: 'Barbara Archer', value: 'BA' }
                ]
            };
            
            // Simulate receiving message from parent
            window.dispatchEvent(new MessageEvent('message', {
                data: mockData,
                origin: window.location.origin
            }));
        }

    </script>
    
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</body>
</html>

